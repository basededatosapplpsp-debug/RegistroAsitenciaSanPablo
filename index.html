<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b5fff" />
  <meta name="description" content="Registro de asistencia de docentes con validación por ubicación." />

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" sizes="32x32" href="favicon-32.png" />
  <link rel="icon" sizes="16x16" href="favicon-16.png" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <title>Asistencia Docentes</title>
 <style>
:root{
  --bg:#0b1220;
  --card:#121a2b;
  --text:#e9eefc;
  --muted:#9bb0d0;
  --primary:#0b5fff;
  --secondary:#3b82f6;
  --danger:#ef4444;
  --line:rgba(255,255,255,.10);
  --shadow: 0 8px 30px rgba(0,0,0,.35);
  --radius:18px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background: radial-gradient(1200px 800px at 20% 0%, rgba(11,95,255,.18), transparent 60%),
              radial-gradient(900px 600px at 80% 30%, rgba(59,130,246,.14), transparent 55%),
              var(--bg);
  color:var(--text);

  /* ✅ Layout tipo app (sin scroll global) */
  height: 100dvh;            /* mejor que 100vh en móviles */
  overflow: hidden;          /* NO scroll en la app completa */
  overscroll-behavior: none;

  display: flex;
  flex-direction: column;
}


.header{
  position:sticky; top:0; z-index:10;
  background: rgba(11,18,32,.75);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
  padding: 14px 14px calc(12px + env(safe-area-inset-top));
  display:flex; align-items:center; justify-content:space-between;
}

.header-actions{display:flex; gap:10px; align-items:center}

h1{font-size:18px; margin:0}
.sub{margin:4px 0 0; color:var(--muted); font-size:12px}

.container{
  flex: 1 1 auto;      /* ocupa el espacio entre header y footer */
  min-height: 0;       /* ✅ CLAVE: permite scroll interno */
  overflow: hidden;    /* NO scroll del main */
  
  max-width: 520px;
  margin: 12px auto;
  padding: 0 12px 12px;

  display: flex;       /* ✅ en columna para controlar alturas */
  flex-direction: column;
  gap: 12px;
}


.card{
  background: rgba(18,26,43,.92);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}

h2{font-size:16px; margin:0 0 12px}

.label{display:block; color:var(--muted); font-size:12px; margin-bottom:6px}
.input{
  width:100%;
  padding: 14px 12px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  color: var(--text);
  outline:none;
}
.input:focus{border-color: rgba(11,95,255,.55); box-shadow: 0 0 0 4px rgba(11,95,255,.15)}

.row{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
.row-between{align-items:center; justify-content:space-between}

.btn{
  border:0;
  border-radius: 14px;
  padding: 12px 14px;
  font-weight: 700;
  cursor:pointer;
  color: var(--text);
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
}
.btn:active{transform: translateY(1px)}
.btn-primary{background: linear-gradient(180deg, rgba(11,95,255,.95), rgba(11,95,255,.75)); border-color: rgba(11,95,255,.55)}
.btn-secondary{background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(59,130,246,.70)); border-color: rgba(59,130,246,.55)}
.btn-danger{background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(239,68,68,.70)); border-color: rgba(239,68,68,.55)}
.btn-ghost{background: transparent}

.status{
  display:flex; gap:10px; align-items:center;
  margin-top: 14px;
  padding: 12px;
  border: 1px dashed var(--line);
  border-radius: 14px;
}
.dot{
  width:10px; height:10px; border-radius:50%;
  background: #22c55e;
  box-shadow: 0 0 0 6px rgba(34,197,94,.12);
}
.dot.warn{background:#f59e0b; box-shadow:0 0 0 6px rgba(245,158,11,.12)}
.dot.bad{background:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.12)}
.muted{color:var(--muted)}
.small{font-size:12px}

.details{margin-top:12px; color:var(--muted)}
.details summary{cursor:pointer}
.kv{margin-top:10px; display:grid; gap:6px}
.k{color:var(--text)}

.table-wrap{
  overflow:auto;
  border-radius: 14px;
  border:1px solid var(--line);
  -webkit-overflow-scrolling: touch;
}

.table{width:100%; border-collapse: collapse; min-width: 760px; background: rgba(0,0,0,.15)}
.table th,.table td{
  padding: 10px 10px;
  border-bottom:1px solid var(--line);
  font-size:13px;
  text-align:left;
  white-space:nowrap;
}
.table th{color: var(--muted); font-weight:700}
.table tr:hover td{background: rgba(255,255,255,.03)}

.footer{
  flex: 0 0 auto;
  padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
  border-top: 1px solid var(--line);
  background: rgba(11,18,32,.75);
  backdrop-filter: blur(10px);

  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
}


/* ===== Mobile: botones full width ===== */
@media (max-width: 699px){
  .row{flex-direction: column;}
  .row .btn{width:100%;}
}

/* ===== Desktop ===== */
@media (min-width: 700px){
  .container{
    max-width: 900px;
    margin: 18px auto;
    padding: 0 14px 60px;
    gap:14px;
  }
  .header{padding: 16px 18px;}
  .row{flex-direction: row;}
  .row .btn{width:auto;}
}

.collapse[hidden]{display:none;}

/* ===== Tarjeta botón "Registros" estilo app ===== */
.card-action{padding:0}

.card-button{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;

  padding:16px;

  background: transparent;
  border: 0;
  color: inherit;
  font: inherit;
  text-align:left;
  cursor:pointer;
}

.card-button:active{transform: translateY(1px);}

.card-title{
  font-weight: 800;
  font-size: 16px;
  margin-bottom: 4px;
}

.chevron{
  font-size: 26px;
  opacity: .7;
  transition: transform .15s ease;
}

/* gira la flecha cuando está abierto */
.card-button.open .chevron{
  transform: rotate(90deg);
}

/* ===== Lista tipo cards (mobile) ===== */
.records-list{
  display:grid;
  gap:12px;
  margin-top:12px;
}

.record-card{
  background: rgba(255,255,255,.04);
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
}

.record-card .top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  font-weight:800;
}

.record-card .teacher{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.record-card .type{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--line);
}

.type.ENTRADA{background:rgba(34,197,94,.15); color:#22c55e}
.type.SALIDA{background:rgba(59,130,246,.15); color:#3b82f6}

.record-card .meta{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

/* mobile vs desktop */
.desktop-only{display:none}
@media (min-width:700px){
  .records-list{display:none}
  .desktop-only{display:block}
}


/* ===== Colores A TIEMPO / TARDE ===== */
.record-card.ontime{
  border-color: rgba(34,197,94,.45);
  background: rgba(34,197,94,.10);
}
.record-card.late{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.10);
}

.badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--line);
  font-weight:800;
}
.badge-ontime{ background: rgba(34,197,94,.15); color:#22c55e; border-color: rgba(34,197,94,.35); }
.badge-late{ background: rgba(239,68,68,.15); color:#ef4444; border-color: rgba(239,68,68,.35); }
.badge-neutral{ background: rgba(255,255,255,.08); color: var(--text); }


/* ======= MODAL LOGIN ======= */
.modal-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 9999;
}
.modal-card{
  width: min(420px, 100%);
  background: #0b1220;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.modal-title{ margin: 0 0 6px 0; font-size: 18px; }
.modal-sub{ margin: 0 0 12px 0; opacity: .85; font-size: 13px; }

.modal-label{ display:block; margin: 10px 0 6px; font-size: 12px; opacity:.9; }
.modal-input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: #fff;
  outline: none;
}
.modal-input:focus{ border-color: rgba(99, 179, 237, .8); }

.modal-actions{ margin-top: 14px; display:flex; gap:10px; }
.modal-hint{ margin-top: 10px; }


.device-box{
  margin-top: 12px;
  padding: 10px;
  border-radius: 12px;
  border: 1px dashed rgba(255,255,255,.18);
  background: rgba(255,255,255,.04);
}
.device-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 6px;
}
.device-id{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
  word-break: break-all;
  opacity: .95;
}
.modal-backdrop[hidden]{ 
  display: none !important; 
}

/* ===== Docente logueado: input grande y bloqueado ===== */
.input.is-locked{
  font-size: 20px;
  font-weight: 800;
  letter-spacing: .2px;
  opacity: 1;
}

.input.is-locked:disabled{
  cursor: not-allowed;
  opacity: 1; /* que NO se vea gris apagado */
}

/* ===== Docente logueado: estilo etiqueta/título ===== */
.input.is-locked{
  font-size: 22px;
  font-weight: 900;
  text-align: center;
  letter-spacing: .3px;
  background: linear-gradient(
    180deg,
    rgba(11,95,255,.20),
    rgba(11,95,255,.10)
  );
  border-color: rgba(11,95,255,.55);
  box-shadow: 0 0 0 4px rgba(11,95,255,.15);
  cursor: default;
}

/* Mantener color normal aunque esté disabled */
.input.is-locked:disabled{
  opacity: 1;
  -webkit-text-fill-color: var(--text);
}


/* ===== Menú circular con iniciales ===== */
.menu{ position: relative; }

.menu-btn{
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-weight: 900;
  letter-spacing: .5px;
  display: grid;
  place-items: center;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
}
.menu-btn:active{ transform: translateY(1px); }

.menu-panel{
  position: absolute;
  right: 0;
  top: calc(100% + 10px);
  min-width: 180px;
  background: rgba(18,26,43,.98);
  border: 1px solid var(--line);
  border-radius: 14px;
  box-shadow: var(--shadow);
  padding: 6px;
  z-index: 10000;
}

.menu-item{
  width: 100%;
  text-align: left;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--text);
  font-weight: 800;
  cursor: pointer;
}
.menu-item:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); }
.menu-item.danger{ color: #ffb4b4; }
.menu-item.danger:hover{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.25); }


/* ===== Botones ENTRADA / SALIDA PRO ===== */

/* ===== Botones ENTRADA / SALIDA (pastel, premium glass, SIN flechas) ===== */

#btnEntrada,
#btnSalida{
  position: relative;
  overflow: hidden;

  font-size: 14.5px;
  font-weight: 800;
  letter-spacing: .35px;
  padding: 14px 16px;
  border-radius: 16px;

  /* Premium feel */
  border: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);

  /* micro-animación elegante (easing suave) */
  transition:
    transform .18s cubic-bezier(.2,.8,.2,1),
    box-shadow .20s cubic-bezier(.2,.8,.2,1),
    filter .20s cubic-bezier(.2,.8,.2,1);
}

/* Hover / active premium (sutil) */
#btnEntrada:hover,
#btnSalida:hover{
  filter: brightness(1.03);
  box-shadow:
    0 10px 24px rgba(0,0,0,.22),
    inset 0 1px 0 rgba(255,255,255,.55);
}

#btnEntrada:active,
#btnSalida:active{
  transform: translateY(1px) scale(0.99);
  filter: brightness(1.01);
  box-shadow:
    0 7px 16px rgba(0,0,0,.18),
    inset 0 1px 0 rgba(255,255,255,.45);
}

/* ================= ENTRADA ================= */
#btnEntrada{
  background: linear-gradient(
    180deg,
    rgba(209,250,229,.95),  /* verde pastel */
    rgba(236,253,245,.88)
  );
  color: rgba(6,95,70,.95);
  border-color: rgba(6,95,70,.22);

  /* sombra ultra suave + highlight interno */
  box-shadow:
    0 8px 18px rgba(6,95,70,.12),
    inset 0 1px 0 rgba(255,255,255,.65);
}

/* ================= SALIDA ================= */
#btnSalida{
  background: linear-gradient(
    180deg,
    rgba(237,233,254,.95), /* violeta pastel */
    rgba(245,243,255,.88)
  );
  color: rgba(76,29,149,.95);
  border-color: rgba(76,29,149,.22);

  box-shadow:
    0 8px 18px rgba(76,29,149,.12),
    inset 0 1px 0 rgba(255,255,255,.65);
}

/* ================= Disabled ================= */
#btnEntrada:disabled,
#btnSalida:disabled{
  opacity: .6;
  box-shadow: none;
  filter: grayscale(.25);
}

/* ===== SALIDA inactiva hasta ENTRADA ===== */
#btnSalida.is-inactive{
  background: linear-gradient(
    180deg,
    rgba(241,245,249,.95),
    rgba(229,231,235,.90)
  );
  color: #9ca3af;
  border-color: rgba(255,255,255,.10);
  box-shadow: none;
  cursor: not-allowed;
}


/* ======= LOADER GLOBAL (overlay moderno) ======= */
.app-loader{
  position: fixed;
  inset: 0;
  z-index: 100000;
  display: grid;
  place-items: center;
  padding: 18px;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
}

.app-loader[hidden]{ display:none !important; }

.loader-card{
  width: min(420px, 100%);
  display: flex;
  gap: 14px;
  align-items: center;
  padding: 14px 14px;
  border-radius: 18px;
  background: rgba(18,26,43,.96);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 18px 45px rgba(0,0,0,.45);
}

.spinner{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 3px solid rgba(255,255,255,.14);
  border-top-color: rgba(209,250,229,.95);  /* pastel suave */
  border-right-color: rgba(237,233,254,.95);/* pastel suave */
  animation: spin 0.85s linear infinite;
  flex: 0 0 auto;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loader-title{
  font-weight: 900;
  letter-spacing: .2px;
}

.loader-msg{
  margin-top: 2px;
  font-size: 12px;
  color: var(--muted);
}

/* opcional: evitar que el usuario toque cosas detrás */
body.is-loading{
  overflow: hidden;
  touch-action: none;
}


/* ===== Layout sin scroll global + scroll solo en Registros ===== */

/* que el área principal use el alto visible */
.container{
  max-height: calc(100vh - 120px); /* header+footer aprox */
  overflow: hidden;                 /* ✅ el main NO scrollea */
}

/* el panel de registros es el que scrollea */
#recordsPanel{
  max-height: calc(100vh - 220px); /* deja espacio para header + tarjeta registrar + footer */
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* cuando registros está oculto, nada scrollea */
#recordsPanel[hidden]{
  overflow: hidden;
}


/* ✅ Scroll solo en el panel de registros */
#recordsPanel{
  flex: 1 1 auto;         /* toma el espacio restante cuando está abierto */
  min-height: 0;          /* ✅ CLAVE para overflow */
  overflow: auto;         /* ✅ aquí sí hay scroll */
  -webkit-overflow-scrolling: touch;
}

/* si está oculto, no ocupa espacio */
#recordsPanel[hidden]{
  overflow: hidden;
}



/* ===== Admin Registros: resumen del mes + filtros compactos ===== */
.admin-month-summary{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
  margin-bottom:6px;
}

.admin-filters{
  margin-top:6px;
  display:grid;
  gap:10px;              /* menos separación, se ve más pro */
  align-items:end;
}

/* 2 columnas cuando hay espacio, 1 columna en móvil */
@media (min-width: 520px){
  .admin-filters{
    grid-template-columns: 1fr 1fr;
  }
}

.filter-item{ min-width: 0; }

/* ✅ HARD LOCK: si NO es admin, NUNCA se ven combos ni contadores de docentes/registros */
body:not(.is-admin) #adminRecordsFilters,
body:not(.is-admin) #adminMonthSummary{
  display: none !important;
}


</style>
</head>

<body>
  <header class="header">
    <div>
      <h1>Asistencia Docentes</h1>
      <p class="sub">Entrada / salida con validación por ubicación</p>
    </div>

<div class="header-actions">
  <!-- Menú circular (avatar) -->
  <div class="menu">
    <button id="btnUserMenu" class="menu-btn" type="button" aria-haspopup="menu" aria-expanded="false" title="Menú">
      <span id="userInitials">?</span>
    </button>

    <div id="userMenu" class="menu-panel" role="menu" hidden>
      <button id="btnRefreshSW" class="menu-item" type="button" role="menuitem">Actualizar</button>
      <button id="btnAdminViewAssist" class="menu-item" type="button" role="menuitem" hidden>Ver asistencias</button>
      <button id="btnAdminManual" class="menu-item" type="button" role="menuitem" hidden>Registro manual</button>

      <button id="btnAdminConfig" class="menu-item" type="button" role="menuitem" hidden>Configuración</button>

<button id="btnAdminApproveDevices" class="menu-item" type="button" role="menuitem" hidden>Aprobar dispositivos</button>

      <button id="btnLogout" class="menu-item danger" type="button" role="menuitem">Cerrar sesión</button>
    </div>
  </div>

  <button id="btnInstall" class="btn btn-ghost" hidden>Instalar</button>
</div>


  </header>

  <main class="container">
    <!-- ===== Registrar ===== -->
    <section class="card">
      <h2>Registrar</h2>

      <label class="label" for="teacherName">Nombre del docente</label>
      <input id="teacherName" class="input" type="text" placeholder="Ej: Ana Pérez" autocomplete="name" />

      <div class="row">
        <button id="btnEntrada" class="btn btn-primary">Entrada</button>
        <button id="btnSalida" class="btn btn-secondary">Salida</button>
      </div>

      <div class="status" id="status">
        <span class="dot" id="dot"></span>
        <div>
          <div id="statusTitle">Listo</div>
          <div class="muted" id="statusMsg">Activa ubicación para registrar en el colegio.</div>
        </div>
      </div>

      <details class="details">
        <summary>Verificación de ubicación</summary>
        <div class="kv">
          <div><span class="k">Distancia:</span> <span id="dist">—</span></div>
          <div><span class="k">Precisión:</span> <span id="acc">—</span></div>
          <div><span class="k">Coordenadas:</span> <span id="coords">—</span></div>
        </div>
      </details>
    </section>

    <!-- ===== Registros: tarjeta grande (botón) ===== -->
    <section class="card card-action">
      <button id="btnToggleRecords" class="card-button" type="button" aria-expanded="false" aria-controls="recordsPanel">
        <div class="card-button-text">
          <div class="card-title">Registros</div>
          <div class="muted small">Ver historial de entradas y salidas</div>
        </div>
        <span class="chevron" aria-hidden="true">›</span>
      </button>
    </section>

    <!-- ===== Panel de registros (colapsable) ===== -->
    <section class="card collapse" id="recordsPanel" hidden>
      <div class="row">
        <button id="btnExport" class="btn btn-ghost">Exportar CSV</button>
          <button id="btnExportXlsx" class="btn btn-ghost" hidden>Excel (con formato)</button>
      </div>



      <!-- ===== Admin: Resumen del mes (solo admin) ===== -->
      <div id="adminMonthSummary" class="admin-month-summary" hidden>
        <span class="badge badge-neutral" id="monthTeachersCount">Docentes: 0</span>
        <span class="badge badge-neutral" id="monthRecordsCount">Registros: 0</span>
      </div>

      <!-- ===== Filtros admin (Mes / Docente) - compactos ===== -->
      <div id="adminRecordsFilters" class="admin-filters" hidden>
        <div class="filter-item">
          <label class="label" for="recordsMonthSelect">Mes</label>
          <select id="recordsMonthSelect" class="input"></select>
        </div>

        <div class="filter-item">
          <label class="label" for="recordsTeacherSelect">Docente</label>
          <select id="recordsTeacherSelect" class="input"></select>
        </div>
      </div>

      <!-- ===== Resumen (contadores) ===== -->
      <div class="row row-between" style="margin-top:10px;">
        <div class="muted small">Resumen</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <span class="badge badge-late" id="lateCount">Entradas tardes: 0</span>
          <span class="badge badge-neutral" id="earlyExitCount">Salidas antes: 0</span>
        </div>
      </div>



      <!-- LISTA MOBILE -->
      <div id="recordsList" class="records-list"></div>

      <!-- TABLA DESKTOP -->
      <div class="table-wrap desktop-only">
        <table class="table" aria-label="Registros de asistencia">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Docente</th>
              <th>Tipo</th>
              <th>Dist</th>
              <th>Prec</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted small">
        Nota: Aquí solo verás tus registros de asistencia.
      </p>
    </section>
  </main>

  <footer class="footer">
    <span class="muted small">APP • Desarrollada por: Deimer Herrera • v.Beta</span>
  </footer>

<!-- ======= MODAL LOGIN ======= -->
<div id="loginModal" class="modal-backdrop" hidden>
  <div class="modal-card">
    <h2 class="modal-title">Iniciar sesión</h2>
    <p class="modal-sub">Registra tus datos una sola vez en este teléfono.</p>

    <label class="modal-label">Nombre</label>
    <input id="loginName" class="modal-input" type="text" placeholder="Ej: Deimer Herrera" />

    <label class="modal-label">Correo</label>
    <input id="loginEmail" class="modal-input" type="email" placeholder="Ej: profesor@colegio.edu.co" />

    <label class="modal-label">Curso (Director de grupo)</label>
    <input id="loginCourse" class="modal-input" type="text" placeholder="Ej: 7A" />

    <div class="device-box">
  <div class="device-row">
    <span class="muted small">ID del teléfono (para autorizar):</span>
    <button id="btnCopyDevice" type="button" class="btn btn-ghost small">Copiar</button>
  </div>
  <div id="deviceIdText" class="device-id"></div>
</div>


<div class="modal-actions">
  <button id="btnLoginSave" type="button" class="btn btn-primary">Entrar</button>
  <button id="btnRequestAuth" type="button" class="btn btn-ghost">Solicitar autorización</button>
  <button id="btnAdminOpen" type="button" class="btn btn-ghost">Administrador</button>
</div>




    <div id="loginHint" class="modal-hint muted small"></div>
  </div>
</div>

<!-- ======= LOADER GLOBAL ======= -->
<div id="appLoader" class="app-loader" hidden aria-live="polite" aria-busy="true">
  <div class="loader-card" role="status">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-text">
      <div id="loaderTitle" class="loader-title">Procesando…</div>
      <div id="loaderMsg" class="loader-msg">Por favor espera…</div>
    </div>
  </div>
</div>


<!-- ======= MODAL ADMIN (PIN / CAMBIO / ASISTENCIAS) ======= -->
<div id="adminModal" class="modal-backdrop" hidden>
  <div class="modal-card">
    <h2 class="modal-title">Administrador</h2>
    <p class="modal-sub" id="adminSub">Ingresa tu PIN para continuar.</p>

    <label class="modal-label">PIN</label>
    <input id="adminPin" class="modal-input" type="password" inputmode="numeric" maxlength="8" placeholder="••••" />

    <div id="adminChangeBlock" hidden>
      <label class="modal-label">Nuevo PIN (4 a 8 dígitos)</label>
      <input id="adminNewPin" class="modal-input" type="password" inputmode="numeric" maxlength="8" placeholder="••••" />
    </div>

    <div class="modal-actions">
      <button id="btnAdminEnter" type="button" class="btn btn-primary">Entrar</button>
      <button id="btnAdminClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>

    <div id="adminHint" class="modal-hint muted small"></div>
  </div>
</div>

<!-- ======= MODAL VER ASISTENCIAS (ADMIN) ======= -->
<div id="adminAssistModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(720px,100%);">
    <h2 class="modal-title">Ver asistencias</h2>
    <p class="modal-sub">Selecciona un docente para ver sus registros del mes seleccionado.</p>

    <!-- ✅ NUEVO: selector de mes -->
    <label class="modal-label">Mes</label>
    <select id="adminMonthSelect" class="modal-input"></select>

    <!-- (se mantiene igual) -->
    <label class="modal-label">Docente</label>
    <select id="adminTeacherSelect" class="modal-input"></select>

    <div class="row row-between" style="margin-top:10px;">
      <div class="muted small" id="adminTeacherTitle">—</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <span class="badge badge-late" id="adminLateCount">Entradas tardes: 0</span>
        <span class="badge badge-neutral" id="adminEarlyExitCount">Salidas antes: 0</span>
      </div>
    </div>

    <div id="adminAssistList" style="
      margin-top:12px;
      max-height: min(60vh, 520px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.10);
    "></div>

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnAdminAssistClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>
  </div>
</div>


<!-- ======= MODAL APROBAR DISPOSITIVOS (ADMIN) ======= -->
<div id="adminDevicesModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(820px,100%);">
    <h2 class="modal-title">Aprobar dispositivos</h2>
    <p class="modal-sub">Aprueba o rechaza solicitudes pendientes en la hoja <b>DISPOSITIVOS</b>.</p>

    <div class="row row-between" style="margin-top:10px;">
      <div class="muted small" id="adminDevicesCount">Pendientes: 0</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="btnAdminDevicesReload" type="button" class="btn btn-ghost small">Recargar</button>
      </div>
    </div>

    <div id="adminDevicesList" style="
      margin-top:12px;
      max-height: min(62vh, 560px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.10);
    "></div>

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnAdminDevicesClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>
  </div>
</div>


<div id="adminConfigModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(520px,100%);">
    <h2 class="modal-title">Configuración</h2>
    <p class="modal-sub">Ajustes del sistema. Se guardan en la hoja CONFIG.</p>

    <label class="modal-label">Hora límite ENTRADA (HH:MM)</label>
    <input id="cfgOnTime" class="modal-input" type="text" placeholder="06:30" />

    <label class="modal-label">Hora mínima SALIDA OK (HH:MM)</label>
    <input id="cfgExitOk" class="modal-input" type="text" placeholder="14:00" />

    <label class="modal-label">Radio del colegio (m)</label>
    <input id="cfgRadius" class="modal-input" type="number" min="1" placeholder="120" />

    <label class="modal-label">Precisión requerida (m)</label>
    <input id="cfgAccuracy" class="modal-input" type="number" min="1" placeholder="50" />

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnCfgSave" type="button" class="btn btn-primary">Guardar</button>
      <button id="btnCfgClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>

    <div id="cfgHint" class="modal-hint muted small"></div>
  </div>
</div>


<!-- ======= MODAL REGISTRO MANUAL (ADMIN) ======= -->
<div id="adminManualModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(520px,100%);">
    <h2 class="modal-title">Registro manual</h2>
    <p class="modal-sub">Registra ENTRADA o SALIDA cuando el docente no tuvo teléfono (marca NTC).</p>

    <label class="modal-label">Docente</label>
    <select id="adminManualTeacher" class="modal-input"></select>

    <div class="row" style="margin-top:12px;">
      <button id="btnAdminManualEntrada" type="button" class="btn btn-primary">Entrada (NTC)</button>
      <button id="btnAdminManualSalida" type="button" class="btn btn-secondary">Salida (NTC)</button>
    </div>

    <div id="adminManualHint" class="modal-hint muted small"></div>

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnAdminManualClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>
  </div>
</div>




<script>
// ======= CONFIG DEL COLEGIO (CAMBIA ESTO) =======
const SCHOOL_LAT = 4.5545060;
const SCHOOL_LNG =-74.1116298;
let SCHOOL_RADIUS_METERS = 120;
let REQUIRED_ACCURACY_METERS = 50;


// ======= GOOGLE SHEETS (CAMBIA ESTO) =======
const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzqLGNfjp0CJi51woGWje8EmKT8rk7uBFhtCHCS-H_R9x4H5NICgYA-S9yu1K6mR7kc/exec"; // ej: https://script.google.com/macros/s/XXXX/exec
const GS_API_KEY = "deimerDh2191docentesRegistros2026appandoidios";        // igual que en Code.gs

// ======= UI =======
const $ = (id) => document.getElementById(id);

const teacherNameEl = $("teacherName");
const tbody = $("tbody");
const statusTitle = $("statusTitle");
const statusMsg = $("statusMsg");
const dot = $("dot");
const distEl = $("dist");
const accEl = $("acc");
const coordsEl = $("coords");

// ======= LOADER UI =======
const appLoader = $("appLoader");
const loaderTitleEl = $("loaderTitle");
const loaderMsgEl = $("loaderMsg");


// ======= LOGIN MODAL UI =======
const loginModal = $("loginModal");
const loginNameEl = $("loginName");
const loginEmailEl = $("loginEmail");
const loginCourseEl = $("loginCourse");
const btnLoginSave = $("btnLoginSave");
const loginHint = $("loginHint");

const deviceIdTextEl = $("deviceIdText");
const btnCopyDevice = $("btnCopyDevice");

const btnRequestAuth = $("btnRequestAuth");
const btnExportXlsx = $("btnExportXlsx");


const btnAdminConfig = $("btnAdminConfig");
const adminConfigModal = $("adminConfigModal");
const cfgOnTime = $("cfgOnTime");
const cfgExitOk = $("cfgExitOk");
const cfgRadius = $("cfgRadius");
const cfgAccuracy = $("cfgAccuracy");
const btnCfgSave = $("btnCfgSave");
const btnCfgClose = $("btnCfgClose");
const cfgHint = $("cfgHint");


const btnEntrada = $("btnEntrada");
const btnSalida  = $("btnSalida");
const btnExport  = $("btnExport");
const btnInstall = $("btnInstall");
const btnRefreshSW = $("btnRefreshSW");
const btnLogout = $("btnLogout");

// ======= ADMIN UI =======
const btnAdminOpen = $("btnAdminOpen");
const adminModal = $("adminModal");
const adminPinEl = $("adminPin");
const adminNewPinEl = $("adminNewPin");
const adminChangeBlock = $("adminChangeBlock");
const adminHint = $("adminHint");
const adminSub = $("adminSub");
const btnAdminEnter = $("btnAdminEnter");
const btnAdminClose = $("btnAdminClose");

const btnAdminViewAssist = $("btnAdminViewAssist");
const adminAssistModal = $("adminAssistModal");
const adminTeacherSelect = $("adminTeacherSelect");
const adminAssistList = $("adminAssistList");
const adminTeacherTitle = $("adminTeacherTitle");
const adminLateCountEl = $("adminLateCount");
const adminEarlyExitCountEl = $("adminEarlyExitCount");
const btnAdminAssistClose = $("btnAdminAssistClose");
const adminMonthSelect = $("adminMonthSelect");

const btnAdminManual = $("btnAdminManual");
const adminManualModal = $("adminManualModal");
const adminManualTeacher = $("adminManualTeacher");
const btnAdminManualEntrada = $("btnAdminManualEntrada");
const btnAdminManualSalida  = $("btnAdminManualSalida");
const btnAdminManualClose   = $("btnAdminManualClose");
const adminManualHint       = $("adminManualHint");



// ======= ADMIN: APROBAR DISPOSITIVOS =======
const btnAdminApproveDevices = $("btnAdminApproveDevices");
const adminDevicesModal = $("adminDevicesModal");
const adminDevicesList = $("adminDevicesList");
const adminDevicesCount = $("adminDevicesCount");
const btnAdminDevicesClose = $("btnAdminDevicesClose");
const btnAdminDevicesReload = $("btnAdminDevicesReload");

const btnUserMenu = $("btnUserMenu");
const userMenu = $("userMenu");
const userInitialsEl = $("userInitials");



const btnToggleRecords = $("btnToggleRecords");
const recordsPanel = $("recordsPanel");
const recordsList = $("recordsList");

const lateCountEl = $("lateCount");
const earlyExitCountEl = $("earlyExitCount");

const adminMonthSummary = $("adminMonthSummary");
const monthTeachersCountEl = $("monthTeachersCount");
const monthRecordsCountEl = $("monthRecordsCount");


// ===== Admin filtros en panel Registros =====
const adminRecordsFilters = $("adminRecordsFilters");
const recordsMonthSelect = $("recordsMonthSelect");
const recordsTeacherSelect = $("recordsTeacherSelect");


let hasEntradaToday = false;
let hasSalidaToday  = false;


function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function normalizeDateYYYYMMDD(v) {
  const s = String(v || "").trim();

  // ya viene como 2026-02-01
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // viene como 01/02/2026 (dd/MM/yyyy)
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
    const [dd, mm, yyyy] = s.split("/");
    return `${yyyy}-${mm}-${dd}`;
  }

  // intentar parsear
  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  return "";
}

function updateDailyButtonsState(records) {
  // En admin, no se usan estos botones (y además el input dice ADMINISTRADOR)
  if (isAdminMode()) {
    btnEntrada.disabled = true;
    btnSalida.disabled = true;
    btnSalida.classList.remove("is-inactive");
    return;
  }

  const p = loadProfile();
  if (!p) return;

  const today = todayStr();

  // ✅ OJO: "records" aquí YA viene filtrado al docente logueado (en modo normal)
  hasEntradaToday = (records || []).some(r =>
    String(r.type || "").toUpperCase() === "ENTRADA" &&
    normalizeDateYYYYMMDD(r.date) === today
  );

  hasSalidaToday = (records || []).some(r =>
    String(r.type || "").toUpperCase() === "SALIDA" &&
    normalizeDateYYYYMMDD(r.date) === today
  );

  // ✅ Estados:
  // 1) Ninguno: Entrada ON, Salida OFF
  // 2) Solo entrada: Entrada OFF, Salida ON
  // 3) Entrada + salida: ambos OFF hasta mañana
  if (!hasEntradaToday && !hasSalidaToday) {
    btnEntrada.disabled = false;

    btnSalida.disabled = true;
    btnSalida.classList.add("is-inactive");
    return;
  }

  if (hasEntradaToday && !hasSalidaToday) {
    btnEntrada.disabled = true;

    btnSalida.disabled = false;
    btnSalida.classList.remove("is-inactive");
    return;
  }

  // ✅ Si ya están ambas hoy:
  btnEntrada.disabled = true;
  btnSalida.disabled = true;
  btnSalida.classList.remove("is-inactive");
}




// ======= Helpers =======
function pad(n){ return String(n).padStart(2,"0"); }
function nowParts() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const ss = pad(d.getSeconds());
  return { date:`${yyyy}-${mm}-${dd}`, time:`${hh}:${mi}:${ss}`, iso:d.toISOString() };
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

// ======= CACHE + TIMEOUT LIST =======
const LS_CACHE_KEY = "asistencia_cache_records_v1";
const LIST_TIMEOUT_MS = 12000; // 12s (ajústalo si quieres)

// key de caché según modo/mes/docente
function cacheKeyForCurrentView_() {
  const admin = isAdminMode();
  const p = loadProfile();
  const month = (admin && typeof recordsMonthSelect !== "undefined" && recordsMonthSelect)
    ? String(recordsMonthSelect.value || "").trim()
    : ""; // "" = mes actual en backend

  const teacher = (!admin && p && p.name) ? normalizeKey(p.name) : "__ADMIN__";
  return `${admin ? "admin" : "user"}|${month || "current"}|${teacher}`;
}

function saveRecordsCache_(key, records) {
  try {
    const raw = localStorage.getItem(LS_CACHE_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    obj[key] = { ts: Date.now(), records: records || [] };
    localStorage.setItem(LS_CACHE_KEY, JSON.stringify(obj));
  } catch {}
}

function loadRecordsCache_(key, maxAgeMs = 24 * 60 * 60 * 1000) {
  try {
    const raw = localStorage.getItem(LS_CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    const item = obj[key];
    if (!item || !Array.isArray(item.records)) return null;
    if ((Date.now() - (item.ts || 0)) > maxAgeMs) return null;
    return item.records;
  } catch {
    return null;
  }
}

async function fetchJsonWithTimeout_(url, options = {}, timeoutMs = LIST_TIMEOUT_MS) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);

  try {
    const res = await fetch(url, { ...options, signal: ctrl.signal });
    const data = await res.json();
    return data;
  } finally {
    clearTimeout(t);
  }
}

  

function isNTCRecord(r) {
  if (!r) return false;

  // SOLO si el servidor lo envía explícito
  if (r.ntc === true) return true;

  const ntcStr = String(r.ntc ?? "").trim().toLowerCase();
  return (ntcStr === "true" || ntcStr === "1");
}



// ======= Admin API =======
async function gsAdminCheckPin(pin) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_check_pin", pin, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_check_failed");
  return data;
}

async function gsAdminChangePin(oldPin, newPin) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_change_pin", old_pin: oldPin, new_pin: newPin, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_change_failed");
  return data;
}


async function gsAdminListMonths() {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_list_months", key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_list_months_failed");
  return data.months || []; // [{key:"YYYY-MM", label:"enero 2026"}, ...]
}


async function gsAdminListTeachers(month) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_list_teachers", month, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_list_teachers_failed");
  return data.teachers || [];
}


async function gsAdminGetTeacherRecords(teacher, month) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_get_teacher_records", teacher, month, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_get_records_failed");
  return data.records || [];
}

async function gsAdminGetConfig() {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_get_config", key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_get_config_failed");
  return data.config;
}

async function gsAdminSetConfig(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_set_config", ...payload, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_set_config_failed");
  return data;
}

async function gsAdminManualRegister(teacher, type, iso) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_manual_register", teacher, type, iso, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_manual_register_failed");
  return data;
}



async function gsAdminListDeviceRequests() {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_list_device_requests", key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_list_device_requests_failed");
  return data.requests || [];
}

async function gsAdminSetDeviceAuth(row, authorized) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "admin_set_device_auth",
      row,
      authorized: authorized ? "SI" : "NO",
      key: GS_API_KEY
    })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_set_device_auth_failed");
  return data;
}


// ======= Contadores de resumen (tardes / salidas antes) =======
let EXIT_OK_HHMM_CLIENT = "14:00";
let ON_TIME_HHMM_CLIENT = "06:30";

function timeToMinutes(hhmmss) {
  const s = String(hhmmss || "").trim();
  const m = s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if (!m) return null;
  const hh = Number(m[1]);
  const mm = Number(m[2]);
  return hh * 60 + mm;
}

function isEarlyExitRecord(r) {
  if (!r || String(r.type || "").toUpperCase() !== "SALIDA") return false;
  const t = timeToMinutes(r.time);
  const limit = timeToMinutes(EXIT_OK_HHMM_CLIENT);
  if (t == null || limit == null) return false;
  return t < limit;
}


function normalizeKey(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .normalize("NFD")                 // separa tildes
    .replace(/[\u0300-\u036f]/g, "")  // quita tildes
    .replace(/\s+/g, " ");            // colapsa espacios
}

function samePersonName(a, b) {
  return normalizeKey(a) === normalizeKey(b);
}


function monthKeyFromDate(d) {
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}`; // YYYY-MM
}

function buildMonthOptions(lastN = 12) {
  const out = [];
  const now = new Date();
  for (let i = 0; i < lastN; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = monthKeyFromDate(d);
    const label = d.toLocaleDateString("es-CO", { month: "long", year: "numeric" });
    out.push({ key, label: label.charAt(0).toUpperCase() + label.slice(1) });
  }
  return out;
}

function uniqueTeachersFromRecords(records) {
  const set = new Set();
  (records || []).forEach(r => {
    const t = String(r.teacher || "").trim();
    if (t) set.add(t);
  });
  return Array.from(set).sort((a,b) => a.localeCompare(b, "es"));
}

function updateAdminMonthSummaryFromRecords(allMonthRecords) {
  if (!adminMonthSummary || !monthTeachersCountEl || !monthRecordsCountEl) return;

  const admin = isAdminMode();

  // ✅ si NO es admin, SIEMPRE oculto y salgo
  adminMonthSummary.hidden = !admin;
  if (!admin) return;

  const totalRecords = (allMonthRecords || []).length;
  const teachers = uniqueTeachersFromRecords(allMonthRecords || []);
  const totalTeachers = teachers.length;

  monthTeachersCountEl.textContent = `Docentes: ${totalTeachers}`;
  monthRecordsCountEl.textContent = `Registros: ${totalRecords}`;
}



function setStatus(kind, title, msg) {
  statusTitle.textContent = title;
  statusMsg.textContent = msg;
  dot.className = "dot" + (kind ? ` ${kind}` : "");
}


let __loadingCount = 0;

function setLoading(isLoading, title = "Procesando…", msg = "Por favor espera…") {
  if (isLoading) __loadingCount++;
  else __loadingCount = Math.max(0, __loadingCount - 1);

  const on = __loadingCount > 0;

// Deshabilitar botones principales para evitar dobles registros
if (on) {
  btnEntrada.disabled = true;
  btnSalida.disabled = true;
  btnExport.disabled = true;
} else {
  // ✅ Al terminar el loader, restaurar el estado real del día
  btnExport.disabled = false;
  updateDailyButtonsState(cachedRecords); // cachedRecords ya es "lo que ve" el docente
}


  // Mostrar overlay loader
  if (appLoader) {
    appLoader.hidden = !on;
    if (loaderTitleEl) loaderTitleEl.textContent = title;
    if (loaderMsgEl) loaderMsgEl.textContent = msg;
  }

  // Evitar scroll/taps detrás
  document.body.classList.toggle("is-loading", on);

  // Mensaje visual (tu status bar)
  if (on) setStatus("warn", title, msg);
}




// ======= PERFIL + DEVICE ID =======
const LS_PROFILE_KEY = "asistencia_profile_v1";
const LS_DEVICE_KEY  = "asistencia_device_id_v1";

function getDeviceId() {
  let id = localStorage.getItem(LS_DEVICE_KEY);
  if (!id) {
    // UUID seguro: evita ReferenceError si crypto no existe
    const c = (typeof window !== "undefined") ? window.crypto : null;
    id = (c && typeof c.randomUUID === "function")
      ? c.randomUUID()
      : "dev-" + Math.random().toString(16).slice(2) + Date.now().toString(16);

    localStorage.setItem(LS_DEVICE_KEY, id);
  }
  return id;
}


function loadProfile() {
  try {
    const raw = localStorage.getItem(LS_PROFILE_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch {
    return null;
  }
}

function openAdminConfigModal() {
  if (!adminConfigModal) return;
  adminConfigModal.hidden = false;
  cfgHint.textContent = "Cargando…";
}

function closeAdminConfigModal() {
  if (!adminConfigModal) return;
  adminConfigModal.hidden = true;
  cfgHint.textContent = "";
}

async function loadAdminConfigIntoUI() {
  const cfg = await gsAdminGetConfig();

  // set inputs
  cfgOnTime.value = cfg.ON_TIME_HHMM || "06:30";
  cfgExitOk.value = cfg.EXIT_OK_HHMM || "14:00";
  cfgRadius.value = String(cfg.SCHOOL_RADIUS_METERS ?? 120);
  cfgAccuracy.value = String(cfg.REQUIRED_ACCURACY_METERS ?? 50);

  // aplicar en runtime (impacta ubicación + contadores)
  ON_TIME_HHMM_CLIENT = cfgOnTime.value;
  EXIT_OK_HHMM_CLIENT = cfgExitOk.value;
  SCHOOL_RADIUS_METERS = Number(cfgRadius.value) || 120;
  REQUIRED_ACCURACY_METERS = Number(cfgAccuracy.value) || 50;

  cfgHint.textContent = "Listo ✅";
}

function isValidHHMM(s) {
  return /^\d{2}:\d{2}$/.test(String(s || "").trim());
}


function saveProfile(profile) {
  localStorage.setItem(LS_PROFILE_KEY, JSON.stringify(profile));
}

const LS_ADMIN_KEY = "asistencia_admin_session_v1";

function isAdminMode() {
  return localStorage.getItem(LS_ADMIN_KEY) === "1";
}

function setAdminMode(on) {
  localStorage.setItem(LS_ADMIN_KEY, on ? "1" : "0");
  document.body.classList.toggle("is-admin", on);

  if (btnAdminViewAssist) btnAdminViewAssist.hidden = !on;
  if (btnAdminConfig) btnAdminConfig.hidden = !on;

  if (btnAdminManual) btnAdminManual.hidden = !on;



  if (btnAdminApproveDevices) btnAdminApproveDevices.hidden = !on;


  // Si entro como admin: cerrar login modal y bloquear “docente”
  if (on) {
    loginModal.hidden = true;
    teacherNameEl.value = "ADMINISTRADOR";
    teacherNameEl.disabled = true;
    teacherNameEl.classList.add("is-locked");
    updateUserInitials({ name: "Administrador" });
    if (btnUserMenu) btnUserMenu.hidden = false;
    setMenuOpen(false);

initAdminRecordsPanelUI();
refreshFromSheet();


  } else {
    // Si salgo de admin: vuelve a comportamiento normal
    if (!loadProfile()) {
      teacherNameEl.disabled = false;
      teacherNameEl.classList.remove("is-locked");
      teacherNameEl.value = "";
      updateUserInitials(null);
      if (btnUserMenu) btnUserMenu.hidden = true;
      setMenuOpen(false);
    }
  }

  initAdminRecordsPanelUI(); // ✅ fuerza ocultar/mostrar SIEMPRE

}

function initAdminRecordsPanelUI() {
  if (!adminRecordsFilters || !recordsMonthSelect || !recordsTeacherSelect) return;

  const on = isAdminMode();

if (btnExportXlsx) btnExportXlsx.hidden = !on;


  // ✅ SOLO ADMIN ve filtros
  adminRecordsFilters.hidden = !on;

  // ✅ SOLO ADMIN ve resumen del mes
  if (typeof adminMonthSummary !== "undefined" && adminMonthSummary) {
    adminMonthSummary.hidden = !on;
  }

  // Si NO es admin, no llenar combos (y listo)
  if (!on) return;

  // llenar meses (últimos 12)
  const months = buildMonthOptions(12);
  recordsMonthSelect.innerHTML = months
    .map(m => `<option value="${m.key}">${escapeHtml(m.label)}</option>`)
    .join("");

  // mes actual por defecto
  recordsMonthSelect.value = monthKeyFromDate(new Date());

  // docente inicia en Todos
  recordsTeacherSelect.innerHTML = `<option value="__ALL__">Todos</option>`;
}


// ✅ cambios de filtros
if (recordsMonthSelect) {
  recordsMonthSelect.addEventListener("change", async () => {
    if (!isAdminMode()) return;
    await refreshFromSheet();
  });
}

if (recordsTeacherSelect) {
  recordsTeacherSelect.addEventListener("change", () => {
    if (!isAdminMode()) return;
    // re-filtra usando los datos ya cargados
    render(__recordsAllRaw);
  });
}



// Estado inicial
if (btnAdminViewAssist) btnAdminViewAssist.hidden = !isAdminMode();

if (btnAdminApproveDevices) btnAdminApproveDevices.hidden = !isAdminMode();
if (btnAdminConfig) btnAdminConfig.hidden = !isAdminMode();
if (btnAdminManual) btnAdminManual.hidden = !isAdminMode();



function getInitials(name) {
  const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
  if (!parts.length) return "?";
  const first = parts[0][0] || "";
  const last = (parts.length > 1 ? parts[parts.length - 1][0] : "") || "";
  return (first + last).toUpperCase();
}

function setMenuOpen(open) {
  if (!btnUserMenu || !userMenu) return;
  userMenu.hidden = !open;
  btnUserMenu.setAttribute("aria-expanded", String(open));
}

function updateUserInitials(profile) {
  if (!userInitialsEl) return;
  if (profile && profile.name) userInitialsEl.textContent = getInitials(profile.name);
  else userInitialsEl.textContent = "?";
}



function applySessionUI(profile) {
  if (profile && profile.name) {
    teacherNameEl.value = profile.name;

    // input bloqueado y grande
    teacherNameEl.disabled = true;
    teacherNameEl.classList.add("is-locked");

    // iniciales en el botón circular
    updateUserInitials(profile);

    // mostrar botón/menu solo si hay sesión
    if (btnUserMenu) btnUserMenu.hidden = false;
  } else {
    teacherNameEl.disabled = false;
    teacherNameEl.classList.remove("is-locked");

    updateUserInitials(null);

    if (btnUserMenu) btnUserMenu.hidden = true;
    setMenuOpen(false);
  }
}


function logout() {
  // borrar perfil docente
  localStorage.removeItem(LS_PROFILE_KEY);

  // apagar admin
  setAdminMode(false);

  // limpiar UI
  applySessionUI(null);

  // abrir modal login
  loginModal.hidden = false;
  updateDeviceIdUI();
  loginHint.textContent = "Sesión cerrada. Inicia sesión para continuar.";

  setStatus("warn", "Sesión cerrada", "Vuelve a iniciar sesión para registrar.");
}


function requireLogin() {
  // ✅ Si está en modo admin, NO pedir perfil docente
  if (isAdminMode()) {
    return { name: "ADMINISTRADOR", email: "admin@local", course: "ADMIN" };
  }

  const p = loadProfile();
  if (p && p.name && p.email && p.course) return p;

  // Mostrar modal y bloquear uso hasta guardar
  loginModal.hidden = false;
  updateDeviceIdUI();
  loginHint.textContent = "Completa tus datos para continuar.";
  return null;
}



function updateDeviceIdUI() {
  if (!deviceIdTextEl) return;
  deviceIdTextEl.textContent = getDeviceId();
}

if (btnCopyDevice) {
  btnCopyDevice.addEventListener("click", async () => {
    try {
      const id = getDeviceId();
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(id);
      } else {
        // fallback antiguo
        const ta = document.createElement("textarea");
        ta.value = id;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      loginHint.textContent = "ID copiado. Pégalo en la hoja DISPOSITIVOS para autorizar.";
    } catch (e) {
      loginHint.textContent = "No se pudo copiar. Copia el ID manualmente.";
    }
  });
}

if (btnAdminConfig) {
  btnAdminConfig.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
      openAdminConfigModal();
      setLoading(true, "Cargando…", "Leyendo CONFIG.");
      await loadAdminConfigIntoUI();
    } catch (e) {
      cfgHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}

if (btnCfgClose) btnCfgClose.addEventListener("click", closeAdminConfigModal);

if (btnCfgSave) {
  btnCfgSave.addEventListener("click", async () => {
    const onTime = String(cfgOnTime.value || "").trim();
    const exitOk = String(cfgExitOk.value || "").trim();
    const radius = String(cfgRadius.value || "").trim();
    const acc = String(cfgAccuracy.value || "").trim();

    if (!isValidHHMM(onTime) || !isValidHHMM(exitOk)) {
      cfgHint.textContent = "Horas inválidas. Usa HH:MM (ej: 06:30).";
      return;
    }
    const r = Number(radius), a = Number(acc);
    if (!Number.isFinite(r) || r <= 0 || !Number.isFinite(a) || a <= 0) {
      cfgHint.textContent = "Radio/precisión inválidos (números > 0).";
      return;
    }

    try {
      setLoading(true, "Guardando…", "Actualizando CONFIG.");
      const resp = await gsAdminSetConfig({
        on_time_hhmm: onTime,
        exit_ok_hhmm: exitOk,
        school_radius_m: r,
        required_accuracy_m: a
      });

      // aplicar runtime
      ON_TIME_HHMM_CLIENT = onTime;
      EXIT_OK_HHMM_CLIENT = exitOk;
      SCHOOL_RADIUS_METERS = r;
      REQUIRED_ACCURACY_METERS = a;

      cfgHint.textContent = resp.msg || "Guardado ✅";
      setStatus("", "Configuración", "Cambios aplicados ✅");
    } catch (e) {
      cfgHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}


// Toggle del menú al tocar el botón circular
if (btnUserMenu) {
  btnUserMenu.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = userMenu && !userMenu.hidden;
    setMenuOpen(!isOpen);
  });
}

// Cerrar menú al tocar fuera
document.addEventListener("click", () => setMenuOpen(false));

// Cerrar menú al tocar una opción
if (userMenu) {
  userMenu.addEventListener("click", () => setMenuOpen(false));
}



btnLoginSave.addEventListener("click", async () => {
  const name = (loginNameEl.value || "").trim();
  const email = (loginEmailEl.value || "").trim().toLowerCase();
  const course = (loginCourseEl.value || "").trim();

  if (!name || !email || !course) {
    loginHint.textContent = "Faltan datos. Nombre, correo y curso son obligatorios.";
    return;
  }
  if (!/^\S+@\S+\.\S+$/.test(email)) {
    loginHint.textContent = "Correo inválido.";
    return;
  }

  try {
    setLoading(true, "Verificando…", "Comprobando si este teléfono ya está autorizado.");
    loginHint.textContent = "Verificando autorización…";

    const chk = await gsCheckDeviceAuth({
      action: "check_device_auth",
      email,
      device_id: getDeviceId()
    });

    // Normaliza por si alguna vez llegara como string (por cambios futuros)
    const authorized = (chk && (chk.authorized === true || String(chk.authorized).toLowerCase() === "true"));

    if (!authorized) {
      const msg = (chk && chk.msg) ? chk.msg : "Aún no autorizado. Usa 'Solicitar autorización' y espera aprobación.";
      loginHint.textContent = msg;

      // ✅ Aviso visible (no solo hint)
      setStatus("bad", "No autorizado", msg);

      // Mantener modal abierto
      loginModal.hidden = false;
      return;
    }


    // ✅ Si está autorizado, validar que el nombre corresponda al dispositivo
const allowedName = (chk && chk.allowed_name) ? String(chk.allowed_name).trim() : "";
if (allowedName && !samePersonName(name, allowedName)) {
  const msg = `El nombre no corresponde a este dispositivo.\nAutorizado para: ${allowedName}`;
  loginHint.textContent = msg;
  setStatus("bad", "Nombre no válido", msg);
  loginModal.hidden = false;
  return;
}


    // ✅ Autorizado: guardar perfil y cerrar modal
    const profile = { name, email, course };
    setAdminMode(false); // ✅ asegura que un docente jamás quede en modo admin

saveProfile(profile);

applySessionUI(profile);
loginModal.hidden = true;


    loginHint.textContent = "";
    

    setStatus("", "Sesión iniciada", "Dispositivo autorizado ✅ Ya puedes registrar asistencia.");

refreshFromSheet({ silent: true, useCache: false }); // ✅ no toca status, solo refresca datos


  } catch (e) {
    const msg = String(e && e.message ? e.message : e);
    loginHint.textContent = msg;
    setStatus("bad", "Error de verificación", msg);
  } finally {
    setLoading(false);
  }
});


function openAdminModal() {
  if (!adminModal) return;
  adminModal.hidden = false;
  adminChangeBlock.hidden = true;
  adminSub.textContent = "Ingresa tu PIN para continuar.";
  adminHint.textContent = "";
  adminPinEl.value = "";
  adminNewPinEl.value = "";
  adminPinEl.focus();
}

function closeAdminModal() {
  if (!adminModal) return;
  adminModal.hidden = true;
  adminHint.textContent = "";

  // ✅ reset modo del botón
  if (btnAdminEnter) {
    delete btnAdminEnter.dataset.mode;
    delete btnAdminEnter.dataset.oldpin;
  }
}

async function adminEnterFlow() {
  const pin = String(adminPinEl.value || "").trim();
  if (!pin) { adminHint.textContent = "Escribe el PIN."; return; }

  try {
    setLoading(true, "Verificando…", "Comprobando PIN de administrador.");
    const chk = await gsAdminCheckPin(pin);

    if (!chk.authorized) {
      adminHint.textContent = chk.msg || "PIN incorrecto.";
      return;
    }

    // si debe cambiar (pin por defecto)
    if (chk.must_change) {
      adminSub.textContent = "PIN por defecto detectado. Debes cambiarlo ahora.";
      adminChangeBlock.hidden = false;
      adminHint.textContent = "Define un nuevo PIN (4 a 8 dígitos).";
      adminNewPinEl.focus();

      btnAdminEnter.dataset.mode = "change";
      btnAdminEnter.dataset.oldpin = pin;
      return;
    }

    // ✅ ENTRAR COMO ADMIN (CIERRA LOGIN SIEMPRE)
    setAdminMode(true);

    // cerrar modales
    closeAdminModal();
    if (loginModal) loginModal.hidden = true;
    if (loginHint) loginHint.textContent = "";

    // UI
    setStatus("", "Administrador", "Sesión iniciada como administrador ✅");

  } catch (e) {
    adminHint.textContent = String(e && e.message ? e.message : e);
  } finally {
    setLoading(false);
  }
}


async function adminChangePinFlow(oldPin) {
  const newPin = String(adminNewPinEl.value || "").trim();
  if (!/^\d{4,8}$/.test(newPin)) {
    adminHint.textContent = "El nuevo PIN debe tener 4 a 8 dígitos.";
    return;
  }

  try {
    setLoading(true, "Actualizando…", "Guardando nuevo PIN de administrador.");
    await gsAdminChangePin(oldPin, newPin);

// ✅ sesión admin principal
setAdminMode(true);

closeAdminModal();
loginModal.hidden = true;

setStatus("", "Administrador", "PIN actualizado ✅ Sesión iniciada como administrador.");


    // limpiar estado del botón
    delete btnAdminEnter.dataset.mode;
    delete btnAdminEnter.dataset.oldpin;

  } catch (e) {
    adminHint.textContent = String(e && e.message ? e.message : e);
  } finally {
    setLoading(false);
  }
}

if (btnAdminOpen) btnAdminOpen.addEventListener("click", openAdminModal);
if (btnAdminClose) btnAdminClose.addEventListener("click", closeAdminModal);

if (btnAdminEnter) {
  btnAdminEnter.addEventListener("click", async () => {
    const mode = btnAdminEnter.dataset.mode || "enter";
    if (mode === "change") {
      const oldPin = btnAdminEnter.dataset.oldpin || "";
      await adminChangePinFlow(oldPin);
    } else {
      await adminEnterFlow();
    }
  });
}


function openAdminAssistModal() {
  if (!adminAssistModal) return;
  adminAssistModal.hidden = false;
  adminAssistList.innerHTML = `<div class="muted small">Cargando…</div>`;
  adminTeacherTitle.textContent = "—";
  adminLateCountEl.textContent = "Entradas tardes: 0";
  adminEarlyExitCountEl.textContent = "Salidas antes: 0";
}

function closeAdminAssistModal() {
  if (!adminAssistModal) return;
  adminAssistModal.hidden = true;
}

function renderAdminTeacherRecords(teacher, records) {
  adminTeacherTitle.textContent = teacher || "—";

  // contadores
  const lateCount = (records || []).filter(r =>
    String(r.type || "").toUpperCase() === "ENTRADA" && !!r.late
  ).length;

  const earlyExitCount = (records || []).filter(isEarlyExitRecord).length;

  adminLateCountEl.textContent = `Entradas tardes: ${lateCount}`;
  adminEarlyExitCountEl.textContent = `Salidas antes: ${earlyExitCount}`;

  if (!records || !records.length) {
    adminAssistList.innerHTML = `<div class="muted small">No hay registros para este docente.</div>`;
    return;
  }

  adminAssistList.innerHTML = records.map(r => {
    const type = String(r.type || "").toUpperCase();
    const isLate = (type === "ENTRADA" && !!r.late);
    const isEarly = isEarlyExitRecord(r);

    // ✅ NTC SOLO si viene explícito desde el servidor (por NOTE = "NTC")
    const ntc = isNTCRecord(r);
    const ntcTxt = ntc ? " • NTC" : "";

    const cls = (type === "ENTRADA")
      ? (isLate ? "record-card late" : "record-card ontime")
      : (isEarly ? "record-card late" : "record-card ontime");

    const badge = (type === "ENTRADA")
      ? (isLate
          ? `<span class="badge badge-late">ENTRADA • TARDE${ntcTxt}</span>`
          : `<span class="badge badge-ontime">ENTRADA • A TIEMPO${ntcTxt}</span>`
        )
      : (isEarly
          ? `<span class="badge badge-late">SALIDA • ANTES${ntcTxt}</span>`
          : `<span class="badge badge-ontime">SALIDA • OK${ntcTxt}</span>`
        );

    return `
      <div class="${cls}" style="margin-bottom:10px;">
        <div class="top">
          <span class="teacher">${escapeHtml(teacher)}</span>
          ${badge}
        </div>
        <div class="meta">
          ${escapeHtml(r.date)} • ${escapeHtml(r.time)}
        </div>
      </div>
    `;
  }).join("");
}




async function adminLoadTeachersAndBind() {
  const month = adminMonthSelect ? adminMonthSelect.value : "";
  const teachers = await gsAdminListTeachers(month);

  adminTeacherSelect.innerHTML = (teachers.length ? teachers : ["(Sin docentes)"])
    .map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`)
    .join("");

  if (teachers.length) {
    const first = teachers[0];
    const recs = await gsAdminGetTeacherRecords(first, month);
    renderAdminTeacherRecords(first, recs);
  } else {
    adminAssistList.innerHTML = `<div class="muted small">No hay docentes en ese mes.</div>`;
    adminTeacherTitle.textContent = "—";
    adminLateCountEl.textContent = "Tardes: 0";
    adminEarlyExitCountEl.textContent = "Salidas antes: 0";
  }
}


function openAdminManualModal() {
  if (!adminManualModal) return;
  adminManualModal.hidden = false;
  adminManualHint.textContent = "";
  adminManualTeacher.innerHTML = `<option>(Cargando...)</option>`;
}

function closeAdminManualModal() {
  if (!adminManualModal) return;
  adminManualModal.hidden = true;
  adminManualHint.textContent = "";
}

async function adminLoadTeachersForManual() {
  const teachers = await gsAdminListTeachers();
  adminManualTeacher.innerHTML = (teachers.length ? teachers : ["(Sin docentes)"])
    .map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`)
    .join("");
}

async function adminDoManual(type) {
  const teacher = String(adminManualTeacher.value || "").trim();
  if (!teacher || teacher === "(Sin docentes)") {
    adminManualHint.textContent = "No hay docentes para seleccionar.";
    return;
  }

  try {
    setLoading(true, "Guardando…", "Registrando asistencia manual (NTC).");

    // usa la hora actual (igual que si lo hiciera el docente)
    const iso = new Date().toISOString();

    await gsAdminManualRegister(teacher, type, iso);

    adminManualHint.textContent = `✅ ${type} guardada (NTC) para ${teacher}.`;

    // refrescar listas/contadores
refreshFromSheet(); // ✅ sin await

    // si está abierto el modal de asistencias admin, recarga si coincide el docente
    // (opcional, no rompe nada)
  } catch (e) {
    adminManualHint.textContent = String(e && e.message ? e.message : e);
  } finally {
    setLoading(false);
  }
}



if (btnAdminManual) {
  btnAdminManual.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
      openAdminManualModal();
      setLoading(true, "Cargando…", "Leyendo docentes del mes actual.");
      await adminLoadTeachersForManual();
    } catch (e) {
      adminManualHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminManualEntrada) btnAdminManualEntrada.addEventListener("click", () => adminDoManual("ENTRADA"));
if (btnAdminManualSalida)  btnAdminManualSalida.addEventListener("click", () => adminDoManual("SALIDA"));
if (btnAdminManualClose)   btnAdminManualClose.addEventListener("click", closeAdminManualModal);


if (btnAdminViewAssist) {
  btnAdminViewAssist.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
    openAdminAssistModal();
setLoading(true, "Cargando…", "Leyendo docentes del mes seleccionado.");

// ✅ AQUI VA ESTO:
if (adminMonthSelect) {
  const months = await gsAdminListMonths();
  adminMonthSelect.innerHTML = (months.length ? months : [{key:"",label:"(Sin meses)"}])
    .map(m => `<option value="${escapeHtml(m.key)}">${escapeHtml(m.label)}</option>`)
    .join("");
}

// y después:
await adminLoadTeachersAndBind();

    } catch (e) {
      adminAssistList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminApproveDevices) {
  btnAdminApproveDevices.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
      openAdminDevicesModal();
      setLoading(true, "Cargando…", "Leyendo solicitudes pendientes.");
      await adminLoadDeviceRequests();
    } catch (e) {
      adminDevicesList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminDevicesReload) {
  btnAdminDevicesReload.addEventListener("click", async () => {
    try {
      setLoading(true, "Recargando…", "Leyendo solicitudes pendientes.");
      await adminLoadDeviceRequests();
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminDevicesClose) btnAdminDevicesClose.addEventListener("click", closeAdminDevicesModal);



if (adminMonthSelect) {
  adminMonthSelect.addEventListener("change", async () => {
    try {
      adminAssistList.innerHTML = `<div class="muted small">Cargando…</div>`;
      await adminLoadTeachersAndBind();
    } catch (e) {
      adminAssistList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    }
  });
}



if (adminTeacherSelect) {
  adminTeacherSelect.addEventListener("change", async () => {
    const t = adminTeacherSelect.value;
    try {
      adminAssistList.innerHTML = `<div class="muted small">Cargando…</div>`;
const month = adminMonthSelect ? adminMonthSelect.value : "";
const recs = await gsAdminGetTeacherRecords(t, month);
      renderAdminTeacherRecords(t, recs);
    } catch (e) {
      adminAssistList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    }
  });
}

if (btnAdminAssistClose) btnAdminAssistClose.addEventListener("click", closeAdminAssistModal);

function openAdminDevicesModal() {
  if (!adminDevicesModal) return;
  adminDevicesModal.hidden = false;
  if (adminDevicesList) adminDevicesList.innerHTML = `<div class="muted small">Cargando…</div>`;
  if (adminDevicesCount) adminDevicesCount.textContent = "Pendientes: —";
}

function closeAdminDevicesModal() {
  if (!adminDevicesModal) return;
  adminDevicesModal.hidden = true;
}

function renderAdminDeviceRequests(requests) {
  const list = (requests || []);
  if (adminDevicesCount) adminDevicesCount.textContent = `Pendientes: ${list.length}`;

  if (!list.length) {
    adminDevicesList.innerHTML = `<div class="muted small">No hay solicitudes pendientes ✅</div>`;
    return;
  }

  adminDevicesList.innerHTML = list.map(r => {
    const email = escapeHtml(r.email || "");
    const device = escapeHtml(r.device_id || "");
    const notes = escapeHtml(r.notes || "");
    const row = Number(r.row || 0);

    return `
      <div class="record-card" style="margin-bottom:10px;">
        <div class="top">
          <span class="teacher">${email}</span>
          <span class="badge badge-neutral">Fila: ${row}</span>
        </div>

        <div class="meta" style="margin-top:8px;">
          <div class="muted small">DEVICE_ID:</div>
          <div class="device-id" style="margin-top:4px;">${device}</div>
        </div>

        <div class="meta" style="margin-top:10px;">
          <div class="muted small">Notas:</div>
          <div class="muted small" style="margin-top:4px; white-space:pre-wrap;">${notes || "—"}</div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn btn-primary" data-approve="${row}">Aprobar ✅</button>
          <button class="btn btn-danger" data-reject="${row}">Rechazar ❌</button>
        </div>
      </div>
    `;
  }).join("");

  // bind botones (delegación)
  adminDevicesList.querySelectorAll("[data-approve]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const row = Number(btn.getAttribute("data-approve"));
      await adminSetDeviceRow(row, true);
    });
  });

  adminDevicesList.querySelectorAll("[data-reject]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const row = Number(btn.getAttribute("data-reject"));
      await adminSetDeviceRow(row, false);
    });
  });
}

async function adminLoadDeviceRequests() {
  const reqs = await gsAdminListDeviceRequests();
  renderAdminDeviceRequests(reqs);
}

async function adminSetDeviceRow(row, approve) {
  try {
    setLoading(true, approve ? "Aprobando…" : "Rechazando…", "Actualizando hoja DISPOSITIVOS.");
    await gsAdminSetDeviceAuth(row, approve);
    await adminLoadDeviceRequests();
    setStatus("", "Listo", approve ? "Dispositivo aprobado ✅" : "Dispositivo rechazado ❌");
  } catch (e) {
    setStatus("bad", "Error", String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}


if (!btnRequestAuth) {
  console.warn("btnRequestAuth NO encontrado en el HTML");
} else {
  btnRequestAuth.addEventListener("click", async () => {
    const name = (loginNameEl.value || "").trim();
    const email = (loginEmailEl.value || "").trim().toLowerCase();
    const course = (loginCourseEl.value || "").trim();

    if (!name || !email || !course) {
      loginHint.textContent = "Primero completa Nombre, Correo y Curso, luego solicita autorización.";
      return;
    }
    if (!/^\S+@\S+\.\S+$/.test(email)) {
      loginHint.textContent = "Correo inválido.";
      return;
    }

    try {
      setLoading(true, "Enviando solicitud…", "Registrando este teléfono para aprobación.");
      loginHint.textContent = "Enviando solicitud…";

      const resp = await gsRequestDeviceAuth({
        action: "request_device_auth",
        name,
        email,
        course,
        device_id: getDeviceId()
      });

      // ✅ Mensaje claro con respuesta del servidor
      loginHint.textContent = resp.msg || "Solicitud enviada ✅. Espera aprobación del administrador.";
    } catch (e) {
      // ✅ Mostrar error real
      loginHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}



// ======= GEO =======
function toRad(x){ return x * Math.PI / 180; }
function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

async function getPosition() {
  if (!("geolocation" in navigator)) {
    throw new Error("NO_GEO");
  }

  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      resolve,
      (err) => {
        // iOS devuelve distintos códigos aunque el permiso esté activo
        if (err && typeof err.code === "number") {
          switch (err.code) {
            case err.PERMISSION_DENIED:
              reject(new Error("PERMISSION_DENIED"));
              return;
            case err.POSITION_UNAVAILABLE:
              reject(new Error("POSITION_UNAVAILABLE"));
              return;
            case err.TIMEOUT:
              reject(new Error("TIMEOUT"));
              return;
          }
        }
        reject(new Error("GEO_UNKNOWN"));
      },
      {
        enableHighAccuracy: true,
        timeout: 15000,   // iOS necesita más tiempo
        maximumAge: 0
      }
    );
  });
}


async function checkLocation() {
  setStatus("warn", "Verificando ubicación…", "Asegúrate de tener GPS/Ubicación activada.");
  const pos = await getPosition();
  const { latitude, longitude, accuracy } = pos.coords;
  const dist = distanceMeters(latitude, longitude, SCHOOL_LAT, SCHOOL_LNG);

  distEl.textContent = `${Math.round(dist)} m`;
  accEl.textContent = `${Math.round(accuracy)} m`;
  coordsEl.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

  const accurateEnough = accuracy <= REQUIRED_ACCURACY_METERS;
  const inside = dist <= SCHOOL_RADIUS_METERS;

  if (!accurateEnough) {
    setStatus("warn", "Ubicación con baja precisión", `Precisión actual ${Math.round(accuracy)} m. Necesito ≤ ${REQUIRED_ACCURACY_METERS} m.`);
    return { ok:false, reason:"accuracy", dist, accuracy, latitude, longitude };
  }
  if (!inside) {
    setStatus("bad", "Fuera del colegio", `Estás a ~${Math.round(dist)} m. Debes estar dentro de ${SCHOOL_RADIUS_METERS} m.`);
    return { ok:false, reason:"outside", dist, accuracy, latitude, longitude };
  }

  setStatus("", "Ubicación validada", `Dentro del radio (${SCHOOL_RADIUS_METERS} m) y precisión OK.`);
  return { ok:true, dist, accuracy, latitude, longitude };
}

// ======= Google Sheets API (Apps Script Web App) =======
async function gsGetList(limit = 50, monthYYYYMM = "", teacher = "") {
  const url = new URL(GS_WEBAPP_URL);
  url.searchParams.set("action", "list");
  url.searchParams.set("limit", String(limit));
  url.searchParams.set("key", GS_API_KEY);

  if (monthYYYYMM) url.searchParams.set("month", monthYYYYMM);
  if (teacher) url.searchParams.set("teacher", teacher);

  let data = null;
  try {
    data = await fetchJsonWithTimeout_(url.toString(), { method: "GET" }, LIST_TIMEOUT_MS);
  } catch (e) {
    // abort / timeout
    const msg = String(e && e.name ? e.name : e);
    if (msg.includes("AbortError")) throw new Error("Tiempo de espera agotado. Revisa internet y vuelve a intentar.");
    throw e;
  }

  if (!data || !data.ok) throw new Error((data && data.error) || "gs_list_failed");
  return data.records || [];
}




async function gsRegister(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    // NO headers: evita preflight CORS
    body: JSON.stringify({ ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inválida del servidor"); }

  // ✅ IMPORTANTE: si el servidor envía msg, lo usamos
  if (!data.ok) {
    throw new Error(data.msg || data.error || "gs_register_failed");
  }
  return data;
}


async function gsRequestDeviceAuth(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    // NO headers: evita preflight CORS
    body: JSON.stringify({ ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inválida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "request_auth_failed");
  return data;
}

async function gsCheckDeviceAuth(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inválida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "check_auth_failed");
  return data;
}


async function gsClearCurrentMonth() {
  const d = new Date();
  const month = `${d.getFullYear()}-${pad(d.getMonth() + 1)}`; // YYYY-MM

  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    // NO headers: evita preflight CORS
    body: JSON.stringify({ action: "clear_month", month, key: GS_API_KEY })
  });

  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "gs_clear_failed");
  return data;
}


// ======= Render (desde Google Sheets) =======
// ======= Render (desde Google Sheets) =======
let cachedRecords = [];
let __recordsAllRaw = []; // ✅ en admin: guarda todos los del mes cargado

function render(records) {
  __recordsAllRaw = (records || []);

  const p = loadProfile();
  const admin = isAdminMode();

  // ✅ Admin: filtrar por selector (Todos o un docente)
  if (admin) {
    const selected = (typeof recordsTeacherSelect !== "undefined" && recordsTeacherSelect)
      ? String(recordsTeacherSelect.value || "__ALL__")
      : "__ALL__";

    const filtered = (selected && selected !== "__ALL__")
      ? __recordsAllRaw.filter(r => normalizeKey(r.teacher) === normalizeKey(selected))
      : __recordsAllRaw;

    cachedRecords = filtered;

    // ======= CONTADORES =======
    const lateCount = filtered.filter(r =>
      String(r.type || "").toUpperCase() === "ENTRADA" && !!r.late
    ).length;

    const earlyExitCount = filtered.filter(isEarlyExitRecord).length;

    if (lateCountEl) lateCountEl.textContent = `Entradas tardes: ${lateCount}`;
    if (earlyExitCountEl) earlyExitCountEl.textContent = `Salidas antes: ${earlyExitCount}`;

    // ======= TABLA (desktop) =======
    tbody.innerHTML = filtered.map(r => {
      const type = String(r.type || "").toUpperCase();
      const ntc = isNTCRecord(r);

      const dist = ntc
        ? "NTC"
        : (r.distance_m ?? r.dist ?? r.distance ?? "—");

      const acc = ntc
        ? "NTC"
        : (r.accuracy_m ?? r.acc ?? r.accuracy ?? "—");

      const typeLabel = ntc ? `${type} • NTC` : type;

      const rowCls =
        (type === "ENTRADA")
          ? (r.late ? "late" : "ontime")
          : "";

      return `
        <tr class="${rowCls}">
          <td>${escapeHtml(r.date)}</td>
          <td>${escapeHtml(r.time)}</td>
          <td>${escapeHtml(r.teacher)}</td>
          <td>${escapeHtml(typeLabel)}</td>
          <td>${escapeHtml(dist)}</td>
          <td>${escapeHtml(acc)}</td>
        </tr>
      `;
    }).join("");

    // ======= CARDS (mobile) =======
    if (!filtered.length) {
      recordsList.innerHTML = `<div class="muted small">No hay registros para el filtro seleccionado.</div>`;
      return; // ✅ en admin no tocamos updateSalidaState()
    }

    recordsList.innerHTML = filtered.map(r => {
      const type = String(r.type || "").toUpperCase();
      const ntc = isNTCRecord(r);
      const ntcTxt = ntc ? " • NTC" : "";

      const badgeClass = (type === "ENTRADA")
        ? (r.late ? "badge badge-late" : "badge badge-ontime")
        : "badge badge-neutral";

      const rowClass = (type === "ENTRADA")
        ? (r.late ? "record-card late" : "record-card ontime")
        : "record-card";

      const badgeText =
        (type === "ENTRADA")
          ? `${type}${r.late ? " • TARDE" : " • A TIEMPO"}${ntcTxt}`
          : `${type}${ntcTxt}`;

      return `
        <div class="${rowClass}">
          <div class="top">
            <span class="teacher">${escapeHtml(r.teacher)}</span>
            <span class="${badgeClass}">${escapeHtml(badgeText)}</span>
          </div>
          <div class="meta">
            ${escapeHtml(r.date)} • ${escapeHtml(r.time)}
          </div>
        </div>
      `;
    }).join("");

    return; // ✅ admin termina aquí
  }

  // ✅ Docente: solo sus registros (como lo tenías)
  const myNameKey = normalizeKey(p && p.name ? p.name : "");
  const filtered = myNameKey
    ? __recordsAllRaw.filter(r => normalizeKey(r.teacher) === myNameKey)
    : __recordsAllRaw;

  cachedRecords = filtered;

  // ======= CONTADORES =======
  const lateCount = filtered.filter(r =>
    String(r.type || "").toUpperCase() === "ENTRADA" && !!r.late
  ).length;

  const earlyExitCount = filtered.filter(isEarlyExitRecord).length;

  if (lateCountEl) lateCountEl.textContent = `Entradas tardes: ${lateCount}`;
  if (earlyExitCountEl) earlyExitCountEl.textContent = `Salidas antes: ${earlyExitCount}`;

  // ======= TABLA (desktop) =======
  tbody.innerHTML = filtered.map(r => {
    const type = String(r.type || "").toUpperCase();
    const ntc = isNTCRecord(r);

    const dist = ntc
      ? "NTC"
      : (r.distance_m ?? r.dist ?? r.distance ?? "—");

    const acc = ntc
      ? "NTC"
      : (r.accuracy_m ?? r.acc ?? r.accuracy ?? "—");

    const typeLabel = ntc ? `${type} • NTC` : type;

    const rowCls =
      (type === "ENTRADA")
        ? (r.late ? "late" : "ontime")
        : "";

    return `
      <tr class="${rowCls}">
        <td>${escapeHtml(r.date)}</td>
        <td>${escapeHtml(r.time)}</td>
        <td>${escapeHtml(r.teacher)}</td>
        <td>${escapeHtml(typeLabel)}</td>
        <td>${escapeHtml(dist)}</td>
        <td>${escapeHtml(acc)}</td>
      </tr>
    `;
  }).join("");

  // ======= CARDS (mobile) =======
  if (!filtered.length) {
    recordsList.innerHTML = `<div class="muted small">No hay registros para este docente.</div>`;
updateDailyButtonsState(filtered);
    return;
  }

  recordsList.innerHTML = filtered.map(r => {
    const type = String(r.type || "").toUpperCase();
    const ntc = isNTCRecord(r);
    const ntcTxt = ntc ? " • NTC" : "";

    const badgeClass = (type === "ENTRADA")
      ? (r.late ? "badge badge-late" : "badge badge-ontime")
      : "badge badge-neutral";

    const rowClass = (type === "ENTRADA")
      ? (r.late ? "record-card late" : "record-card ontime")
      : "record-card";

    const badgeText =
      (type === "ENTRADA")
        ? `${type}${r.late ? " • TARDE" : " • A TIEMPO"}${ntcTxt}`
        : `${type}${ntcTxt}`;

    return `
      <div class="${rowClass}">
        <div class="top">
          <span class="teacher">${escapeHtml(r.teacher)}</span>
          <span class="${badgeClass}">${escapeHtml(badgeText)}</span>
        </div>
        <div class="meta">
          ${escapeHtml(r.date)} • ${escapeHtml(r.time)}
        </div>
      </div>
    `;
  }).join("");

updateDailyButtonsState(filtered);
}

async function refreshFromSheet(options = {}) {
  const {
    useCache = true,      // renderiza caché primero
    silent = false,       // no cambia el status "Cargando..."
    showLoadingAfterMs = 450 // solo mostrar "Cargando" si tarda > 450ms
  } = options;

  const admin = isAdminMode();
  const p = loadProfile();

  // mes (admin)
  let month = "";
  if (admin && typeof recordsMonthSelect !== "undefined" && recordsMonthSelect) {
    month = String(recordsMonthSelect.value || "").trim();
  }

  // docente (normal)
  const teacherFilter = (!admin && p && p.name) ? String(p.name).trim() : "";

  // 1) Render rápido con caché (para que "no demore al iniciar")
  const cacheKey = cacheKeyForCurrentView_();
  if (useCache) {
    const cached = loadRecordsCache_(cacheKey);
    if (cached && cached.length) {
      render(cached);
      // NO pongas "Listo" aquí; dejamos que la red lo confirme luego
    }
  }

  // 2) “Cargando…” SOLO si realmente tarda (evita sensación de lentitud)
  let loadingTimer = null;
  if (!silent) {
    loadingTimer = setTimeout(() => {
      setStatus("warn", "Cargando…", "Leyendo registros de asistencia.");
    }, showLoadingAfterMs);
  }

  try {
    // 3) Reduce carga en inicio para docente (admin sigue alto)
    const limit = admin ? 1200 : 300;

    const records = await gsGetList(limit, month, teacherFilter);

    // Resumen admin
    updateAdminMonthSummaryFromRecords(records);

    // Admin: refrescar combo docentes
    if (admin && typeof recordsTeacherSelect !== "undefined" && recordsTeacherSelect) {
      const current = String(recordsTeacherSelect.value || "__ALL__");
      const teachers = uniqueTeachersFromRecords(records);

      recordsTeacherSelect.innerHTML =
        `<option value="__ALL__">Todos</option>` +
        teachers.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      const exists = teachers.some(t => normalizeKey(t) === normalizeKey(current));
      recordsTeacherSelect.value = exists ? current : "__ALL__";
    }

    render(records);

    // Guardar caché
    saveRecordsCache_(cacheKey, records);

    if (!silent) setStatus("", "Listo", "Datos de asistencia sincronizados.");
  } catch (e) {
    if (!silent) {
      setStatus(
        "bad",
        "Error Google Sheets",
        String(e && e.message ? e.message : "Revisa URL/clave del Web App y permisos.")
      );
    }
  } finally {
    if (loadingTimer) clearTimeout(loadingTimer);
  }
}






// ======= Registrar =======
// ======= Registrar =======
async function register(type) {

  if (type === "SALIDA" && !hasEntradaToday) {
  setStatus(
    "warn",
    "Primero registra ENTRADA",
    "No puedes registrar la salida sin haber registrado la entrada hoy."
  );
  return;
}

  const profile = requireLogin();
  if (!profile) return;

  const teacher = (teacherNameEl.value.trim() || profile.name);
  if (!teacher) {
    setStatus("bad", "Falta el nombre", "Escribe el nombre del docente.");
    teacherNameEl.focus();
    return;
  }

  let geo;
  try {
    geo = await checkLocation();
 } catch (e) {
  const code = String(e && e.message || "");

  if (code === "PERMISSION_DENIED") {
    setStatus(
      "bad",
      "Permiso denegado",
      "En iPhone: Ajustes → Safari → Ubicación → Permitir o Preguntar."
    );
  } else if (code === "POSITION_UNAVAILABLE" || code === "TIMEOUT") {
    setStatus(
      "warn",
      "Ubicación no disponible",
      "Intenta salir al exterior o activa Wi-Fi / Datos."
    );
  } else {
    setStatus(
      "bad",
      "Ubicación no disponible",
      "Revisa que la ubicación esté activada en el dispositivo."
    );
  }
  return;
}

  if (!geo.ok) return;

  const t = nowParts();

  try {
    setLoading(true, "Guardando…", "Enviando registro de asistencia.");

    await gsRegister({
      action: "register",
      teacher,
      type,
      iso: t.iso,
      email: profile.email,
      course: profile.course,
      device_id: getDeviceId(),
      distance_m: Math.round(geo.dist),
      accuracy_m: Math.round(geo.accuracy),
      lat: geo.latitude,
      lng: geo.longitude
    });

refreshFromSheet({ silent: true, useCache: false }); // ✅ no toca status, solo refresca datos

if (type === "ENTRADA") {
  hasEntradaToday = true;
  btnEntrada.disabled = true;

  btnSalida.disabled = false;
  btnSalida.classList.remove("is-inactive");
}

if (type === "SALIDA") {
  hasSalidaToday = true;
  btnEntrada.disabled = true;
  btnSalida.disabled = true;
}



    // ✅ abrir panel para que el usuario vea el registro de inmediato
    setRecordsOpen(true);

    setStatus("", "Guardado", `${type} registrada para ${teacher}.`);


  } catch (e) {
    // ✅ Mensaje real (si viene del servidor)
    const msg = String(e && e.message ? e.message : e).toLowerCase();

    // ✅ Caso típico sin internet / red caída
    const isOffline =
      (typeof navigator !== "undefined" && navigator.onLine === false) ||
      msg.includes("failed to fetch") ||
      msg.includes("networkerror") ||
      msg.includes("load failed") ||
      msg.includes("err_internet_disconnected") ||
      msg.includes("err_network_changed");

    if (isOffline) {
      setStatus(
        "bad",
        "Sin conexión",
        "Revisa tu conexión a internet e intenta de nuevo."
      );
      return;
    }

    // Si quieres títulos más bonitos según el caso:
    if (msg.includes("no está autorizado") || msg.includes("device_not_authorized")) {
      setStatus("bad", "Teléfono no autorizado", String(e && e.message ? e.message : e));
    } else if (msg.includes("ya existe") || msg.includes("already_registered")) {
      setStatus("warn", "Registro duplicado", String(e && e.message ? e.message : e));
    } else if (msg.includes("unauthorized")) {
      setStatus("bad", "Sin permisos", "Clave incorrecta o permisos del WebApp.");
    } else {
      setStatus("bad", "No se pudo guardar", String(e && e.message ? e.message : e) || "Revisa conexión y Apps Script.");
    }

  } finally {

    setLoading(false);
  }
}



// ======= CSV (desde lo que se ve en la app) =======
function csvCell(v){
  if (v === null || v === undefined) return "";
  const s = String(v);
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}





function exportCSV() {
  // En admin, cachedRecords ya representa:
  // - Todos (si selector = __ALL__)
  // - Un docente (si selector = ese nombre)
  // En modo normal, cachedRecords es el docente logueado.
  const dataToExport = cachedRecords || [];

  if (!dataToExport.length) {
    setStatus("warn", "Sin datos", "No hay registros para exportar.");
    return;
  }

  const header = ["teacher","type","date","time","late","iso"];
  const lines = [header.join(",")].concat(
    dataToExport.map(r => header.map(k => csvCell(r[k])).join(","))
  );

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  // nombre del archivo: admin incluye mes y (si aplica) docente
  let fname = `asistencia_${new Date().toISOString().slice(0,10)}`;

  if (isAdminMode()) {
    const month = recordsMonthSelect ? String(recordsMonthSelect.value || "").trim() : "";
    const who = recordsTeacherSelect ? String(recordsTeacherSelect.value || "__ALL__") : "__ALL__";
    if (month) fname += `_${month}`;
    if (who && who !== "__ALL__") fname += `_${who.replace(/\s+/g, "_")}`;
  }

  const a = document.createElement("a");
  a.href = url;
  a.download = `${fname}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  setStatus("", "Exportado", "CSV descargado.");
}


async function downloadAdminExcel() {
  if (!isAdminMode()) {
    setStatus("warn", "Requiere admin", "Solo disponible en modo administrador.");
    return;
  }

  const month = recordsMonthSelect ? String(recordsMonthSelect.value || "").trim() : "";
  const teacher = recordsTeacherSelect ? String(recordsTeacherSelect.value || "__ALL__") : "__ALL__";

  try {
    setLoading(true, "Generando Excel…", "Preparando archivo para descarga.");

    const url = new URL(GS_WEBAPP_URL);
    url.searchParams.set("action", "export_xlsx_link");
    url.searchParams.set("key", GS_API_KEY);
    if (month) url.searchParams.set("month", month);
    if (teacher) url.searchParams.set("teacher", teacher);

    const res = await fetch(url.toString(), { method: "GET" });
    const data = await res.json();

    if (!data.ok || !data.url) throw new Error(data.msg || "No se pudo generar el link.");

    // ✅ Abrir directo Drive (ya no abre script.google.com)
    const opened = window.open(data.url, "_blank");
    if (!opened) window.location.href = data.url;

    setStatus("", "Listo", "Descarga iniciada ✅");
  } catch (e) {
    setStatus("bad", "Error", String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}


if (btnExportXlsx) btnExportXlsx.addEventListener("click", downloadAdminExcel);


// ======= INSTALL (A2HS) =======
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.hidden = false;
});
btnInstall.addEventListener("click", async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  btnInstall.hidden = true;
});

// ======= UI: Toggle registros =======
function setRecordsOpen(open) {
  recordsPanel.hidden = !open;
  btnToggleRecords.setAttribute("aria-expanded", String(open));
  btnToggleRecords.classList.toggle("open", open);
}
setRecordsOpen(false);
btnToggleRecords.addEventListener("click", () => setRecordsOpen(recordsPanel.hidden));

// ======= Reset / Refresh Service Worker + Cache =======
async function hardRefreshPWA() {
  try {
    setStatus("warn", "Actualizando…", "Borrando caché y reiniciando la app.");

    // 🔥 orden de suicidio al SW activo
    if ("serviceWorker" in navigator) {
      const reg = await navigator.serviceWorker.getRegistration();
      if (reg && reg.active) {
        reg.active.postMessage("KILL_SW");
      }
    }

    // 🧹 borrar caches desde la app
    if ("caches" in window) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }

    // 🔄 romper caché del navegador
    const url = new URL(location.href);
    url.searchParams.set("v", Date.now().toString());
    location.replace(url.toString());

  } catch (e) {
    setStatus("bad", "No se pudo actualizar", "Cierra la app y ábrela de nuevo.");
  }
}

btnRefreshSW.addEventListener("click", hardRefreshPWA);
if (btnLogout) {
  btnLogout.addEventListener("click", logout);
}


// ======= SW register =======
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try { await navigator.serviceWorker.register("./sw.js"); } catch {}
  });
}

// ======= EVENTOS =======
btnEntrada.addEventListener("click", () => register("ENTRADA"));
btnSalida.addEventListener("click",  () => register("SALIDA"));

btnExport.addEventListener("click", exportCSV);



// Inicial: rápido (cache) + refresh silencioso
refreshFromSheet({ useCache: true, silent: true });
setStatus("warn", "Listo", "Para registrar, activa ubicación.");

document.body.classList.toggle("is-admin", isAdminMode());


// ✅ Mostrar login al abrir (si no hay perfil guardado)
if (isAdminMode()) {
  setAdminMode(true); // aplica UI admin (cierra modal y pone ADMINISTRADOR)
} else {
  initAdminRecordsPanelUI(); // ✅ fuerza ocultar combos + resumen si NO es admin
  const _p = requireLogin();
  if (_p) applySessionUI(_p);
  else applySessionUI(null);
}





</script>

</body>
</html>






