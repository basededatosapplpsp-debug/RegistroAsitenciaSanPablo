<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b5fff" />
  <meta name="description" content="Registro de asistencia de docentes con validaci√≥n por ubicaci√≥n." />

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" sizes="32x32" href="favicon-32.png" />
  <link rel="icon" sizes="16x16" href="favicon-16.png" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <title>Asistencia Docentes</title>
 <style>
:root{
  --bg:#0b1220;
  --card:#121a2b;
  --text:#e9eefc;
  --muted:#9bb0d0;
  --primary:#0b5fff;
  --secondary:#3b82f6;
  --danger:#ef4444;
  --line:rgba(255,255,255,.10);
  --shadow: 0 8px 30px rgba(0,0,0,.35);
  --radius:18px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background: radial-gradient(1200px 800px at 20% 0%, rgba(11,95,255,.18), transparent 60%),
              radial-gradient(900px 600px at 80% 30%, rgba(59,130,246,.14), transparent 55%),
              var(--bg);
  color:var(--text);

  /* ‚úÖ Layout tipo app (sin scroll global) */
  height: 100dvh;            /* mejor que 100vh en m√≥viles */
  overflow: hidden;          /* NO scroll en la app completa */
  overscroll-behavior: none;

  display: flex;
  flex-direction: column;
}


.header{
  position:sticky; top:0; z-index:10;
  background: rgba(11,18,32,.75);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
  padding: 14px 14px calc(12px + env(safe-area-inset-top));
  display:flex; align-items:center; justify-content:space-between;
}

.header-actions{display:flex; gap:10px; align-items:center}

h1{font-size:18px; margin:0}
.sub{margin:4px 0 0; color:var(--muted); font-size:12px}

.container{
  flex: 1 1 auto;      /* ocupa el espacio entre header y footer */
  min-height: 0;       /* ‚úÖ CLAVE: permite scroll interno */
  overflow: hidden;    /* NO scroll del main */
  
  max-width: 520px;
  margin: 12px auto;
  padding: 0 12px 12px;

  display: flex;       /* ‚úÖ en columna para controlar alturas */
  flex-direction: column;
  gap: 12px;
}


.card{
  background: rgba(18,26,43,.92);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}

h2{font-size:16px; margin:0 0 12px}

.label{display:block; color:var(--muted); font-size:12px; margin-bottom:6px}
.input{
  width:100%;
  padding: 14px 12px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  color: var(--text);
  outline:none;
}
.input:focus{border-color: rgba(11,95,255,.55); box-shadow: 0 0 0 4px rgba(11,95,255,.15)}

.row{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
.row-between{align-items:center; justify-content:space-between}

.btn{
  border:0;
  border-radius: 14px;
  padding: 12px 14px;
  font-weight: 700;
  cursor:pointer;
  color: var(--text);
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
}
.btn:active{transform: translateY(1px)}
.btn-primary{background: linear-gradient(180deg, rgba(11,95,255,.95), rgba(11,95,255,.75)); border-color: rgba(11,95,255,.55)}
.btn-secondary{background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(59,130,246,.70)); border-color: rgba(59,130,246,.55)}
.btn-danger{background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(239,68,68,.70)); border-color: rgba(239,68,68,.55)}
.btn-ghost{background: transparent}

.status{
  display:flex; gap:10px; align-items:center;
  margin-top: 14px;
  padding: 12px;
  border: 1px dashed var(--line);
  border-radius: 14px;
}
.dot{
  width:10px; height:10px; border-radius:50%;
  background: #22c55e;
  box-shadow: 0 0 0 6px rgba(34,197,94,.12);
}
.dot.warn{background:#f59e0b; box-shadow:0 0 0 6px rgba(245,158,11,.12)}
.dot.bad{background:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.12)}
.muted{color:var(--muted)}
.small{font-size:12px}

.details{margin-top:12px; color:var(--muted)}
.details summary{cursor:pointer}
.kv{margin-top:10px; display:grid; gap:6px}
.k{color:var(--text)}

.table-wrap{
  overflow:auto;
  border-radius: 14px;
  border:1px solid var(--line);
  -webkit-overflow-scrolling: touch;
}

.table{width:100%; border-collapse: collapse; min-width: 760px; background: rgba(0,0,0,.15)}
.table th,.table td{
  padding: 10px 10px;
  border-bottom:1px solid var(--line);
  font-size:13px;
  text-align:left;
  white-space:nowrap;
}
.table th{color: var(--muted); font-weight:700}
.table tr:hover td{background: rgba(255,255,255,.03)}

.footer{
  flex: 0 0 auto;
  padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
  border-top: 1px solid var(--line);
  background: rgba(11,18,32,.75);
  backdrop-filter: blur(10px);

  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
}


/* ===== Mobile: botones full width ===== */
@media (max-width: 699px){
  .row{flex-direction: column;}
  .row .btn{width:100%;}
}

/* ===== Desktop ===== */
@media (min-width: 700px){
  .container{
    max-width: 900px;
    margin: 18px auto;
    padding: 0 14px 60px;
    gap:14px;
  }
  .header{padding: 16px 18px;}
  .row{flex-direction: row;}
  .row .btn{width:auto;}
}

.collapse[hidden]{display:none;}

/* ===== Tarjeta bot√≥n "Registros" estilo app ===== */
.card-action{padding:0}

.card-button{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;

  padding:16px;

  background: transparent;
  border: 0;
  color: inherit;
  font: inherit;
  text-align:left;
  cursor:pointer;
}

.card-button:active{transform: translateY(1px);}

.card-title{
  font-weight: 800;
  font-size: 16px;
  margin-bottom: 4px;
}

.chevron{
  font-size: 26px;
  opacity: .7;
  transition: transform .15s ease;
}

/* gira la flecha cuando est√° abierto */
.card-button.open .chevron{
  transform: rotate(90deg);
}

/* ===== Lista tipo cards (mobile) ===== */
.records-list{
  display:grid;
  gap:12px;
  margin-top:12px;
}

.record-card{
  background: rgba(255,255,255,.04);
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
}

.record-card .top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  font-weight:800;
}

.record-card .teacher{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.record-card .type{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--line);
}

.type.ENTRADA{background:rgba(34,197,94,.15); color:#22c55e}
.type.SALIDA{background:rgba(59,130,246,.15); color:#3b82f6}

.record-card .meta{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

/* mobile vs desktop */
.desktop-only{display:none}
@media (min-width:700px){
  .records-list{display:none}
  .desktop-only{display:block}
}


/* ===== Colores A TIEMPO / TARDE ===== */
.record-card.ontime{
  border-color: rgba(34,197,94,.45);
  background: rgba(34,197,94,.10);
}
.record-card.late{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.10);
}

.badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--line);
  font-weight:800;
}
.badge-ontime{ background: rgba(34,197,94,.15); color:#22c55e; border-color: rgba(34,197,94,.35); }
.badge-late{ background: rgba(239,68,68,.15); color:#ef4444; border-color: rgba(239,68,68,.35); }
.badge-neutral{ background: rgba(255,255,255,.08); color: var(--text); }


/* ======= MODAL LOGIN ======= */
.modal-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 9999;
}
.modal-card{
  width: min(420px, 100%);
  background: #0b1220;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.modal-title{ margin: 0 0 6px 0; font-size: 18px; }
.modal-sub{ margin: 0 0 12px 0; opacity: .85; font-size: 13px; }

.modal-label{ display:block; margin: 10px 0 6px; font-size: 12px; opacity:.9; }
.modal-input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: #fff;
  outline: none;
}
.modal-input:focus{ border-color: rgba(99, 179, 237, .8); }

.modal-actions{ margin-top: 14px; display:flex; gap:10px; }
.modal-hint{ margin-top: 10px; }


.device-box{
  margin-top: 12px;
  padding: 10px;
  border-radius: 12px;
  border: 1px dashed rgba(255,255,255,.18);
  background: rgba(255,255,255,.04);
}
.device-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 6px;
}
.device-id{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
  word-break: break-all;
  opacity: .95;
}
.modal-backdrop[hidden]{ 
  display: none !important; 
}

/* ===== Docente logueado: input grande y bloqueado ===== */
.input.is-locked{
  font-size: 20px;
  font-weight: 800;
  letter-spacing: .2px;
  opacity: 1;
}

.input.is-locked:disabled{
  cursor: not-allowed;
  opacity: 1; /* que NO se vea gris apagado */
}

/* ===== Docente logueado: estilo etiqueta/t√≠tulo ===== */
.input.is-locked{
  font-size: 22px;
  font-weight: 900;
  text-align: center;
  letter-spacing: .3px;
  background: linear-gradient(
    180deg,
    rgba(11,95,255,.20),
    rgba(11,95,255,.10)
  );
  border-color: rgba(11,95,255,.55);
  box-shadow: 0 0 0 4px rgba(11,95,255,.15);
  cursor: default;
}

/* Mantener color normal aunque est√© disabled */
.input.is-locked:disabled{
  opacity: 1;
  -webkit-text-fill-color: var(--text);
}


/* ===== Men√∫ circular con iniciales ===== */
.menu{ position: relative; }

.menu-btn{
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-weight: 900;
  letter-spacing: .5px;
  display: grid;
  place-items: center;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
}
.menu-btn:active{ transform: translateY(1px); }

.menu-panel{
  position: absolute;
  right: 0;
  top: calc(100% + 10px);
  min-width: 180px;
  background: rgba(18,26,43,.98);
  border: 1px solid var(--line);
  border-radius: 14px;
  box-shadow: var(--shadow);
  padding: 6px;
  z-index: 10000;
}

.menu-item{
  width: 100%;
  text-align: left;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--text);
  font-weight: 800;
  cursor: pointer;
}
.menu-item:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); }
.menu-item.danger{ color: #ffb4b4; }
.menu-item.danger:hover{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.25); }


/* ===== Botones ENTRADA / SALIDA PRO ===== */

/* ===== Botones ENTRADA / SALIDA (pastel, premium glass, SIN flechas) ===== */

#btnEntrada,
#btnSalida{
  position: relative;
  overflow: hidden;

  font-size: 14.5px;
  font-weight: 800;
  letter-spacing: .35px;
  padding: 14px 16px;
  border-radius: 16px;

  /* Premium feel */
  border: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);

  /* micro-animaci√≥n elegante (easing suave) */
  transition:
    transform .18s cubic-bezier(.2,.8,.2,1),
    box-shadow .20s cubic-bezier(.2,.8,.2,1),
    filter .20s cubic-bezier(.2,.8,.2,1);
}

/* Hover / active premium (sutil) */
#btnEntrada:hover,
#btnSalida:hover{
  filter: brightness(1.03);
  box-shadow:
    0 10px 24px rgba(0,0,0,.22),
    inset 0 1px 0 rgba(255,255,255,.55);
}

#btnEntrada:active,
#btnSalida:active{
  transform: translateY(1px) scale(0.99);
  filter: brightness(1.01);
  box-shadow:
    0 7px 16px rgba(0,0,0,.18),
    inset 0 1px 0 rgba(255,255,255,.45);
}

/* ================= ENTRADA ================= */
#btnEntrada{
  background: linear-gradient(
    180deg,
    rgba(209,250,229,.95),  /* verde pastel */
    rgba(236,253,245,.88)
  );
  color: rgba(6,95,70,.95);
  border-color: rgba(6,95,70,.22);

  /* sombra ultra suave + highlight interno */
  box-shadow:
    0 8px 18px rgba(6,95,70,.12),
    inset 0 1px 0 rgba(255,255,255,.65);
}

/* ================= SALIDA ================= */
#btnSalida{
  background: linear-gradient(
    180deg,
    rgba(237,233,254,.95), /* violeta pastel */
    rgba(245,243,255,.88)
  );
  color: rgba(76,29,149,.95);
  border-color: rgba(76,29,149,.22);

  box-shadow:
    0 8px 18px rgba(76,29,149,.12),
    inset 0 1px 0 rgba(255,255,255,.65);
}

/* ================= Disabled ================= */
#btnEntrada:disabled,
#btnSalida:disabled{
  opacity: .6;
  box-shadow: none;
  filter: grayscale(.25);
}

/* ===== SALIDA inactiva hasta ENTRADA ===== */
#btnSalida.is-inactive{
  background: linear-gradient(
    180deg,
    rgba(241,245,249,.95),
    rgba(229,231,235,.90)
  );
  color: #9ca3af;
  border-color: rgba(255,255,255,.10);
  box-shadow: none;
  cursor: not-allowed;
}


/* ======= LOADER GLOBAL (overlay moderno) ======= */
.app-loader{
  position: fixed;
  inset: 0;
  z-index: 100000;
  display: grid;
  place-items: center;
  padding: 18px;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
}

.app-loader[hidden]{ display:none !important; }

.loader-card{
  width: min(420px, 100%);
  display: flex;
  gap: 14px;
  align-items: center;
  padding: 14px 14px;
  border-radius: 18px;
  background: rgba(18,26,43,.96);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 18px 45px rgba(0,0,0,.45);
}

.spinner{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 3px solid rgba(255,255,255,.14);
  border-top-color: rgba(209,250,229,.95);  /* pastel suave */
  border-right-color: rgba(237,233,254,.95);/* pastel suave */
  animation: spin 0.85s linear infinite;
  flex: 0 0 auto;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loader-title{
  font-weight: 900;
  letter-spacing: .2px;
}

.loader-msg{
  margin-top: 2px;
  font-size: 12px;
  color: var(--muted);
}

/* opcional: evitar que el usuario toque cosas detr√°s */
body.is-loading{
  overflow: hidden;
  touch-action: none;
}


/* ===== Layout sin scroll global + scroll solo en Registros ===== */

/* que el √°rea principal use el alto visible */
.container{
  max-height: calc(100vh - 120px); /* header+footer aprox */
  overflow: hidden;                 /* ‚úÖ el main NO scrollea */
}

/* el panel de registros es el que scrollea */
#recordsPanel{
  max-height: calc(100vh - 220px); /* deja espacio para header + tarjeta registrar + footer */
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* cuando registros est√° oculto, nada scrollea */
#recordsPanel[hidden]{
  overflow: hidden;
}


/* ‚úÖ Scroll solo en el panel de registros */
#recordsPanel{
  flex: 1 1 auto;         /* toma el espacio restante cuando est√° abierto */
  min-height: 0;          /* ‚úÖ CLAVE para overflow */
  overflow: auto;         /* ‚úÖ aqu√≠ s√≠ hay scroll */
  -webkit-overflow-scrolling: touch;
}

/* si est√° oculto, no ocupa espacio */
#recordsPanel[hidden]{
  overflow: hidden;
}



/* ===== Admin Registros: resumen del mes + filtros compactos ===== */
.admin-month-summary{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
  margin-bottom:6px;
}

.admin-filters{
  margin-top:6px;
  display:grid;
  gap:10px;              /* menos separaci√≥n, se ve m√°s pro */
  align-items:end;
}

/* 2 columnas cuando hay espacio, 1 columna en m√≥vil */
@media (min-width: 520px){
  .admin-filters{
    grid-template-columns: 1fr 1fr;
  }
}

.filter-item{ min-width: 0; }

/* ‚úÖ HARD LOCK: si NO es admin, NUNCA se ven combos ni contadores de docentes/registros */
body:not(.is-admin) #adminRecordsFilters,
body:not(.is-admin) #adminMonthSummary{
  display: none !important;
}



   /* ======= Llamado de atenci√≥n ======= */
/* ======= Llamado de atenci√≥n ======= */
.disc-levels{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
  margin-top:12px;
}
.disc-level{
  border-radius: 14px;
  padding: 12px 10px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
  text-align:center;
}
.disc-level:hover{ filter: brightness(1.03); }
.disc-level.active{
  border-color: rgba(34,197,94,.45);
  background: rgba(34,197,94,.12);
}
.disc-level.active[data-level="2"]{
  border-color: rgba(248, 244, 5, 0.45);   /* amarillo */
  background: rgba(248, 244, 5, 0.18);     /* amarillo claro */
}

.disc-level.active[data-level="3"]{
  border-color: rgba(245, 158, 11, 0.6);   /* naranja */
  background: rgba(245, 158, 11, 0.28);    /* naranja m√°s fuerte */
}


.disc-level.danger.active,
.disc-level.active[data-level="4"]{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.16);
}

.disc-who{
  margin-top:12px;
  border:1px dashed var(--line);
  border-radius:14px;
  padding:10px;
}
.disc-who-list{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.disc-pill{
  font-size:12px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
}


/* ===== Disciplina: lista reportados ordenada y clickeable ===== */
.disc-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  width:100%;
  text-align:left;

  /* ‚úÖ m√°s contraste + ‚Äúcard‚Äù m√°s clara */
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.07);

  padding:12px 14px;
  border-radius:16px;
  cursor:pointer;

  /* ‚úÖ mejora legibilidad del texto negro (Android) */
  color: var(--text);
  -webkit-text-fill-color: var(--text);

  /* ‚úÖ sensaci√≥n premium */
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
}

.disc-item:hover{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.18);
}

.disc-item:active{ transform: translateY(1px); }

.disc-item .left{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:0;
}

.disc-item .name{
  font-weight: 950;
  font-size: 16px;
  letter-spacing: .2px;
  color: rgba(233,238,252,.96);
  -webkit-text-fill-color: rgba(233,238,252,.96);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.disc-item .right{
  display:flex;
  gap:8px;
  align-items:center;
  flex:0 0 auto;
  font-size: 12px;
  color: rgba(155,176,208,.98);
  -webkit-text-fill-color: rgba(155,176,208,.98);
}


/* punto de nivel (para lista) */
.lvl-dot{
  width:12px; height:12px; border-radius:999px;
  box-shadow: 0 0 0 8px rgba(255,255,255,.05);
}
.lvl-1{ background:#22c55e; box-shadow:0 0 0 8px rgba(34,197,94,.12); }

/* ‚úÖ NIVEL 2: AMARILLO */
.lvl-2{ background:#f8f405; box-shadow:0 0 0 8px rgba(248,244,5,.18); }

/* ‚úÖ NIVEL 3: NARANJA */
.lvl-3{ background:#f59e0b; box-shadow:0 0 0 8px rgba(245,158,11,.18); }

.lvl-4{ background:#ef4444; box-shadow:0 0 0 8px rgba(239,68,68,.12); }



/* ‚úÖ resaltado del seleccionado */
.disc-item.selected{
  border-color: rgba(11,95,255,.62);
  background: rgba(11,95,255,.18);
}



/* ================================
   MODALES FALTAS (DISC / PIERC / UNI)
   responsive + scroll SOLO en Reportados
================================ */

/* padding seguro en m√≥viles (notch/safe-area) */
#disciplineModal,
#piercingModal,
#uniformModal{
  padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom));
}

/* el card se adapta a altura y NO scrollea */
#disciplineModal .modal-card,
#piercingModal .modal-card,
#uniformModal .modal-card{
  width: min(720px, 100%);
  max-height: calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  display: flex;
  flex-direction: column;
  overflow: hidden; /* evita doble scroll */
}

/* contenedor de ‚ÄúReportados‚Äù en columna, permitiendo que la lista sea la que scrollee */
#disciplineModal .disc-reported,
#piercingModal .disc-reported,
#uniformModal .disc-reported{
  display: flex;
  flex-direction: column;
  min-height: 0; /* CLAVE para overflow del hijo */
}

/* SOLO la lista scrollea */
#disciplineModal .disc-reported-list,
#piercingModal .disc-reported-list,
#uniformModal .disc-reported-list{
  margin-top: 10px;
  flex: 1 1 auto;
  min-height: 120px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;

  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 10px;
  background: rgba(0,0,0,.10);
}

/* opcional: compactar en pantallas muy bajas */
@media (max-height: 640px){
  #disciplineModal .modal-sub,
  #piercingModal .modal-sub,
  #uniformModal .modal-sub{ display:none; }

  #disciplineModal .disc-who,
  #piercingModal .disc-who,
  #uniformModal .disc-who{ padding: 8px; }

  #disciplineModal .disc-level,
  #piercingModal .disc-level,
  #uniformModal .disc-level{ padding: 10px 8px; }
}




/* ===== Bot√≥n trash pro en lista de disciplina ===== */
.disc-trash{
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  display: grid;
  place-items: center;
  cursor: pointer;
  flex: 0 0 auto;
  transition: transform .15s ease, filter .15s ease, background .15s ease, border-color .15s ease;
}

.disc-trash:hover{
  filter: brightness(1.08);
  background: rgba(239,68,68,.10);
  border-color: rgba(239,68,68,.22);
}

.disc-trash:active{
  transform: translateY(1px) scale(.99);
}

.disc-trash svg{
  width: 18px;
  height: 18px;
  opacity: .92;
}

/* color del icono (rojo suave) */
.disc-trash svg path{
  fill: rgba(255,180,180,.95);
}


/* =========================================================
   ‚úÖ FIX: Nombre con "..." SIN mover/tapar el bote (Reportados)
   ========================================================= */

.disc-item{
  /* ya lo tienes, esto asegura layout correcto en todos */
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.disc-item .left{
  display:flex;
  align-items:center;
  gap:12px;

  /* ‚úÖ CLAVE: permite que el texto se encoja dentro del flex */
  min-width: 0;
  flex: 1 1 auto;
}

.disc-item .name{
  /* ‚úÖ CLAVE: elipsis real dentro de flex */
  min-width: 0;
  flex: 1 1 auto;

  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.disc-item .right{
  /* ‚úÖ el bote nunca se encoge ni se mueve */
  flex: 0 0 auto;
}

/* ‚úÖ FIX: nombre seleccionado (modal disciplina) no se desborda */
#discSelectedBox{
  min-width: 0; /* clave en flex */
}

#discSelectedBox > div{
  min-width: 0; /* el contenedor del texto */
}

#discSelectedName{
  display: block;
  min-width: 0;
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}



.menu-subpanel{
  margin-top: 6px;
  padding: 6px;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: rgba(0,0,0,.10);
}


/* ‚úÖ Input con flecha integrada (select invisible encima del lado derecho) */
.input-with-select {
  position: relative;
}

.input-with-select > input,
.input-with-select > .modal-input.input-real {
  padding-right: 44px; /* espacio para la flecha */
}

.input-with-select > select.student-overlay {
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  width: 44px;          /* zona tocable de la flecha */
  opacity: 0;           /* invisible */
  border: 0;
  background: transparent;
  cursor: pointer;
}

.input-with-select::after {
  content: "‚ñæ";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;

  font-size: 22px;      /* üî• tama√±o de la flecha */
  font-weight: 700;     /* m√°s gruesa */
  line-height: 1;
  opacity: 0.9;
}


/* ‚ùå Ocultar label "Estudiante (lista)" porque el select va dentro del input */
label[for="discStudentSelect"],
label[for="piercStudentSelect"],
label[for="uniStudentSelect"] {
  display: none !important;
}


/* ‚ùå Quitar flecha nativa del datalist en inputs */
input[list] {
  -webkit-appearance: none;
  appearance: none;
}

/* Android / Chrome */
input[list]::-webkit-calendar-picker-indicator {
  display: none !important;
}

/* Firefox */
input[list]::-moz-list-dropdown {
  display: none !important;
}


</style>
</head>

<body>
  <header class="header">
    <div>
      <h1>Asistencia Docentes</h1>
      <p class="sub">Entrada / salida con validaci√≥n por ubicaci√≥n</p>
    </div>

<div class="header-actions">
  <!-- Men√∫ circular (avatar) -->
  <div class="menu">
    <button id="btnUserMenu" class="menu-btn" type="button" aria-haspopup="menu" aria-expanded="false" title="Men√∫">
      <span id="userInitials">?</span>
    </button>

<div id="userMenu" class="menu-panel" role="menu" hidden>
  <button id="btnRefreshSW" class="menu-item" type="button" role="menuitem">Actualizar</button>
  <button id="btnAdminViewAssist" class="menu-item" type="button" role="menuitem" hidden>Ver asistencias</button>
  <button id="btnAdminManual" class="menu-item" type="button" role="menuitem" hidden>Registro manual</button>

  <button id="btnAdminConfig" class="menu-item" type="button" role="menuitem" hidden>Configuraci√≥n</button>

  <button id="btnAdminApproveDevices" class="menu-item" type="button" role="menuitem" hidden>Aprobar dispositivos</button>

  <!-- ‚úÖ NUEVO: Bot√≥n que abre el submen√∫ -->
  <button id="btnFaltasMenu" class="menu-item" type="button" role="menuitem" aria-haspopup="true" aria-expanded="false">
    Llamados de atenci√≥n <span class="muted small" aria-hidden="true">‚Ä∫</span>
  </button>

  <!-- ‚úÖ Submen√∫ de Faltas (aqu√≠ van los botones que ya tienes) -->
  <div id="faltasSubMenu" class="menu-subpanel" hidden>
    <div class="muted small" style="padding:6px 8px;">Llamados de atenci√≥n</div>

    <!-- ‚úÖ MISMOS IDs => tu JS no se rompe -->
    <button id="btnDiscipline" class="menu-item" type="button" role="menuitem">Uso del celular</button>
    <button id="btnPiercing" class="menu-item" type="button" role="menuitem">Piercing y perforaciones</button>
    <button id="btnUniform" class="menu-item" type="button" role="menuitem">Porte del uniforme</button>
  </div>

  <button id="btnLogout" class="menu-item danger" type="button" role="menuitem">Cerrar sesi√≥n</button>
</div>

  </div>

  <button id="btnInstall" class="btn btn-ghost" hidden>Instalar</button>
</div>


  </header>

  <main class="container">
    <!-- ===== Registrar ===== -->
    <section class="card">
      <h2>Registrar</h2>

      <label class="label" for="teacherName">Nombre del docente</label>
      <input id="teacherName" class="input" type="text" placeholder="Ej: Ana P√©rez" autocomplete="name" />

      <div class="row">
        <button id="btnEntrada" class="btn btn-primary">Entrada</button>
        <button id="btnSalida" class="btn btn-secondary">Salida</button>
      </div>

      <div class="status" id="status">
        <span class="dot" id="dot"></span>
        <div>
          <div id="statusTitle">Listo</div>
          <div class="muted" id="statusMsg">Activa ubicaci√≥n para registrar en el colegio.</div>
        </div>
      </div>

      <details class="details">
        <summary>Verificaci√≥n de ubicaci√≥n</summary>
        <div class="kv">
          <div><span class="k">Distancia:</span> <span id="dist">‚Äî</span></div>
          <div><span class="k">Precisi√≥n:</span> <span id="acc">‚Äî</span></div>
          <div><span class="k">Coordenadas:</span> <span id="coords">‚Äî</span></div>
        </div>
      </details>
    </section>

    <!-- ===== Registros: tarjeta grande (bot√≥n) ===== -->
    <section class="card card-action">
      <button id="btnToggleRecords" class="card-button" type="button" aria-expanded="false" aria-controls="recordsPanel">
        <div class="card-button-text">
          <div class="card-title">Registros</div>
          <div class="muted small">Ver historial de entradas y salidas</div>
        </div>
        <span class="chevron" aria-hidden="true">‚Ä∫</span>
      </button>
    </section>

    <!-- ===== Panel de registros (colapsable) ===== -->
    <section class="card collapse" id="recordsPanel" hidden>
      <div class="row">
        <button id="btnExport" class="btn btn-ghost">Exportar CSV</button>
          <button id="btnExportXlsx" class="btn btn-ghost" hidden>Excel (con formato)</button>
      </div>



      <!-- ===== Admin: Resumen del mes (solo admin) ===== -->
      <div id="adminMonthSummary" class="admin-month-summary" hidden>
        <span class="badge badge-neutral" id="monthTeachersCount">Docentes: 0</span>
        <span class="badge badge-neutral" id="monthRecordsCount">Registros: 0</span>
      </div>

      <!-- ===== Filtros admin (Mes / Docente) - compactos ===== -->
      <div id="adminRecordsFilters" class="admin-filters" hidden>
        <div class="filter-item">
          <label class="label" for="recordsMonthSelect">Mes</label>
          <select id="recordsMonthSelect" class="input"></select>
        </div>

        <div class="filter-item">
          <label class="label" for="recordsTeacherSelect">Docente</label>
          <select id="recordsTeacherSelect" class="input"></select>
        </div>
      </div>

      <!-- ===== Resumen (contadores) ===== -->
      <div class="row row-between" style="margin-top:10px;">
        <div class="muted small">Resumen</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <span class="badge badge-late" id="lateCount">Entradas tardes: 0</span>
          <span class="badge badge-neutral" id="earlyExitCount">Salidas antes: 0</span>
        </div>
      </div>



      <!-- LISTA MOBILE -->
      <div id="recordsList" class="records-list"></div>

      <!-- TABLA DESKTOP -->
      <div class="table-wrap desktop-only">
        <table class="table" aria-label="Registros de asistencia">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Docente</th>
              <th>Tipo</th>
              <th>Dist</th>
              <th>Prec</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted small">
        Nota: Aqu√≠ solo ver√°s tus registros de asistencia.
      </p>
    </section>
  </main>

  <footer class="footer">
    <span class="muted small">APP ‚Ä¢ Desarrollada por: Deimer Herrera ‚Ä¢ v.Beta</span>
  </footer>

<!-- ======= MODAL LOGIN ======= -->
<div id="loginModal" class="modal-backdrop" hidden>
  <div class="modal-card">
    <h2 class="modal-title">Iniciar sesi√≥n</h2>
    <p class="modal-sub">Registra tus datos una sola vez en este tel√©fono.</p>

    <label class="modal-label">Nombre</label>
    <input id="loginName" class="modal-input" type="text" placeholder="Ej: Deimer Herrera" />

    <label class="modal-label">Correo</label>
    <input id="loginEmail" class="modal-input" type="email" placeholder="Ej: profesor@colegio.edu.co" />

    <label class="modal-label">Celular (WhatsApp destino)</label>
<input id="loginPhone" class="modal-input"
       type="tel" inputmode="numeric"
       placeholder="Ej: 3001234567" autocomplete="tel" />


    <label class="modal-label">Curso (Director de grupo)</label>
    <input id="loginCourse" class="modal-input" type="text" placeholder="Ej: 7A" />

    <div class="device-box">
  <div class="device-row">
    <span class="muted small">ID del tel√©fono (para autorizar):</span>
    <button id="btnCopyDevice" type="button" class="btn btn-ghost small">Copiar</button>
  </div>
  <div id="deviceIdText" class="device-id"></div>
</div>


<div class="modal-actions">
  <button id="btnLoginSave" type="button" class="btn btn-primary">Entrar</button>
  <button id="btnRequestAuth" type="button" class="btn btn-ghost">Solicitar autorizaci√≥n</button>
  <button id="btnAdminOpen" type="button" class="btn btn-ghost">Administrador</button>
</div>




    <div id="loginHint" class="modal-hint muted small"></div>
  </div>
</div>

<!-- ======= LOADER GLOBAL ======= -->
<div id="appLoader" class="app-loader" hidden aria-live="polite" aria-busy="true">
  <div class="loader-card" role="status">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-text">
      <div id="loaderTitle" class="loader-title">Procesando‚Ä¶</div>
      <div id="loaderMsg" class="loader-msg">Por favor espera‚Ä¶</div>
    </div>
  </div>
</div>


<!-- ======= MODAL ADMIN (PIN / CAMBIO / ASISTENCIAS) ======= -->
<div id="adminModal" class="modal-backdrop" hidden>
  <div class="modal-card">
    <h2 class="modal-title">Administrador</h2>
    <p class="modal-sub" id="adminSub">Ingresa tu PIN para continuar.</p>

    <label class="modal-label">PIN</label>
    <input id="adminPin" class="modal-input" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

    <div id="adminChangeBlock" hidden>
      <label class="modal-label">Nuevo PIN (4 a 8 d√≠gitos)</label>
      <input id="adminNewPin" class="modal-input" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>

    <div class="modal-actions">
      <button id="btnAdminEnter" type="button" class="btn btn-primary">Entrar</button>
      <button id="btnAdminClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>

    <div id="adminHint" class="modal-hint muted small"></div>
  </div>
</div>

<!-- ======= MODAL VER ASISTENCIAS (ADMIN) ======= -->
<div id="adminAssistModal" class="modal-backdrop" hidden>
<div class="modal-card">
    <h2 class="modal-title">Ver asistencias</h2>
    <p class="modal-sub">Selecciona un docente para ver sus registros del mes seleccionado.</p>

    <!-- ‚úÖ NUEVO: selector de mes -->
    <label class="modal-label">Mes</label>
    <select id="adminMonthSelect" class="modal-input"></select>

    <!-- (se mantiene igual) -->
    <label class="modal-label">Docente</label>
    <select id="adminTeacherSelect" class="modal-input"></select>

    <div class="row row-between" style="margin-top:10px;">
      <div class="muted small" id="adminTeacherTitle">‚Äî</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <span class="badge badge-late" id="adminLateCount">Entradas tardes: 0</span>
        <span class="badge badge-neutral" id="adminEarlyExitCount">Salidas antes: 0</span>
      </div>
    </div>

    <div id="adminAssistList" style="
      margin-top:12px;
      max-height: min(60vh, 520px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.10);
    "></div>

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnAdminAssistClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>
  </div>
</div>


<!-- ======= MODAL APROBAR DISPOSITIVOS (ADMIN) ======= -->
<div id="adminDevicesModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(820px,100%);">
    <h2 class="modal-title">Aprobar dispositivos</h2>
    <p class="modal-sub">Aprueba o rechaza solicitudes pendientes en la hoja <b>DISPOSITIVOS</b>.</p>

    <div class="row row-between" style="margin-top:10px;">
      <div class="muted small" id="adminDevicesCount">Pendientes: 0</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="btnAdminDevicesReload" type="button" class="btn btn-ghost small">Recargar</button>
      </div>
    </div>

    <div id="adminDevicesList" style="
      margin-top:12px;
      max-height: min(62vh, 560px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.10);
    "></div>

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnAdminDevicesClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>
  </div>
</div>


<div id="adminConfigModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(520px,100%);">
    <h2 class="modal-title">Configuraci√≥n</h2>
    <p class="modal-sub">Ajustes del sistema. Se guardan en la hoja CONFIG.</p>

    <label class="modal-label">Hora l√≠mite ENTRADA (HH:MM)</label>
    <input id="cfgOnTime" class="modal-input" type="text" placeholder="06:30" />

    <label class="modal-label">Hora m√≠nima SALIDA OK (HH:MM)</label>
    <input id="cfgExitOk" class="modal-input" type="text" placeholder="14:00" />

    <label class="modal-label">Radio del colegio (m)</label>
    <input id="cfgRadius" class="modal-input" type="number" min="1" placeholder="120" />

    <label class="modal-label">Precisi√≥n requerida (m)</label>
    <input id="cfgAccuracy" class="modal-input" type="number" min="1" placeholder="50" />

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnCfgSave" type="button" class="btn btn-primary">Guardar</button>
      <button id="btnCfgClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>

    <div id="cfgHint" class="modal-hint muted small"></div>
  </div>
</div>


<!-- ======= MODAL REGISTRO MANUAL (ADMIN) ======= -->
<div id="adminManualModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(520px,100%);">
    <h2 class="modal-title">Registro manual</h2>
    <p class="modal-sub">Registra ENTRADA o SALIDA cuando el docente no tuvo tel√©fono (marca NTC).</p>

    <label class="modal-label">Docente</label>
    <select id="adminManualTeacher" class="modal-input"></select>

    <div class="row" style="margin-top:12px;">
      <button id="btnAdminManualEntrada" type="button" class="btn btn-primary">Entrada (NTC)</button>
      <button id="btnAdminManualSalida" type="button" class="btn btn-secondary">Salida (NTC)</button>
    </div>

    <div id="adminManualHint" class="modal-hint muted small"></div>

    <div class="modal-actions" style="justify-content:flex-end;">
      <button id="btnAdminManualClose" type="button" class="btn btn-ghost">Cerrar</button>
    </div>
  </div>
</div>

<!-- ======= MODAL LLAMADO DE ATENCI√ìN (CELULAR EN CLASE) ======= -->
<div id="disciplineModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(720px,100%);">
    <h2 class="modal-title">Llamado de atenci√≥n</h2>
    <p class="modal-sub">Reporta uso de celular en clase. Marca el nivel (1 a 4). Al llegar a 4 se notifica a los docentes que participaron.</p>

    <label class="modal-label">Seleccionado</label>
    <div id="discSelectedBox" class="status" style="margin-top:6px;">
      <span class="dot" id="discLevelDot"></span>
      <div>
        <div id="discSelectedName" style="font-weight:900;">Selecciona un estudiante de la lista</div>
        <div class="muted" id="discSelectedMeta">‚Äî</div>
      </div>
    </div>

    <!-- ‚úÖ NUEVO: Curso + Autocomplete -->
    <label class="modal-label" for="discCourse">Curso</label>
    <select id="discCourse" class="modal-input"></select>
    <datalist id="discStudentsList"></datalist>
    <label class="modal-label" for="discStudentSelect">Estudiante (lista)</label>
<select id="discStudentSelect" class="modal-input"></select>


    <label class="modal-label" for="discStudent">Estudiante</label>
    <input id="discStudent" class="modal-input" type="text"
           list="discStudentsList"
           placeholder="Escribe el nombre del estudiante‚Ä¶" autocomplete="off" />
    <div class="muted small" style="margin-top:6px;">
      Tip: tambi√©n puedes tocar un nombre en ‚ÄúReportados‚Äù para cargarlo arriba.
    </div>

    <div class="disc-levels">
      <button type="button" class="disc-level" data-level="1">1 ‚Ä¢ Leve</button>
      <button type="button" class="disc-level" data-level="2">2</button>
      <button type="button" class="disc-level" data-level="3">3</button>
      <button type="button" class="disc-level danger" data-level="4">4 ‚Ä¢ Grave</button>
    </div>

    <div class="disc-who">
      <div class="muted small" style="margin-bottom:6px;">Docentes que han marcado niveles</div>
      <div id="discWhoList" class="disc-who-list">‚Äî</div>
    </div>

    <div class="disc-reported">
      <div class="row row-between" style="margin-top:12px;">
        <div class="muted small">Reportados (mes actual)</div>
      </div>

      <div id="discReportedList" class="disc-reported-list"></div>

      <div id="discHint" class="modal-hint muted small"></div>

      <div class="modal-actions" style="justify-content:flex-end;">
        <button id="btnDiscBack" type="button" class="btn btn-ghost" hidden>‚Üê Atr√°s</button>
        <button id="btnDiscReload" type="button" class="btn btn-ghost">Recargar</button>
        <button id="btnDiscClose" type="button" class="btn btn-ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>



<!-- ======= MODAL PIERCING Y PERFORACIONES ======= -->
<div id="piercingModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(720px,100%);">

    <h2 class="modal-title">Piercing y perforaciones</h2>
    <p class="modal-sub">
      Reporta piercing/perforaciones no permitidas. Marca el nivel (1 a 4). Al llegar a 4 se notifica por WhatsApp.
    </p>

    <label class="modal-label">Seleccionado</label>
    <div id="piercSelectedBox" class="status" style="margin-top:6px;">
      <span class="dot" id="piercLevelDot"></span>
      <div>
        <div id="piercSelectedName" style="font-weight:900;">Selecciona un estudiante de la lista</div>
        <div class="muted" id="piercSelectedMeta">‚Äî</div>
      </div>
    </div>

    <label class="modal-label" for="piercCourse">Curso</label>
    <select id="piercCourse" class="modal-input"></select>

    <datalist id="piercStudentsList"></datalist>

    <label class="modal-label" for="piercStudentSelect">Estudiante (lista)</label>
    <select id="piercStudentSelect" class="modal-input"></select>

    <label class="modal-label" for="piercStudent">Estudiante</label>
    <input id="piercStudent" class="modal-input" type="text"
      list="piercStudentsList"
      placeholder="Escribe el nombre del estudiante‚Ä¶" autocomplete="off" />

    <div class="muted small" style="margin-top:6px;">
      Tip: tambi√©n puedes tocar un nombre en ‚ÄúReportados‚Äù para cargarlo arriba.
    </div>

    <div class="disc-levels">
      <button type="button" class="disc-level" data-level="1">1 ‚Ä¢ Leve</button>
      <button type="button" class="disc-level" data-level="2">2</button>
      <button type="button" class="disc-level" data-level="3">3</button>
      <button type="button" class="disc-level danger" data-level="4">4 ‚Ä¢ Grave</button>
    </div>

    <div class="disc-who">
      <div class="muted small" style="margin-bottom:6px;">
        Docentes que han marcado niveles
      </div>
      <div id="piercWhoList" class="disc-who-list">‚Äî</div>
    </div>

    <div class="disc-reported">
      <div class="row row-between" style="margin-top:12px;">
        <div class="muted small">Reportados (mes actual)</div>
      </div>

      <div id="piercReportedList" class="disc-reported-list"></div>
      <div id="piercHint" class="modal-hint muted small"></div>

      <div class="modal-actions" style="justify-content:flex-end;">
        <button id="btnPiercBack" type="button" class="btn btn-ghost" hidden>‚Üê Atr√°s</button>
        <button id="btnPiercReload" type="button" class="btn btn-ghost">Recargar</button>
        <button id="btnPiercClose" type="button" class="btn btn-ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>



<!-- ======= MODAL: PORTE DEL UNIFORME ======= -->
<div id="uniformModal" class="modal-backdrop" hidden>
  <div class="modal-card" style="width:min(720px,100%);">

    <h2 class="modal-title">Porte del uniforme</h2>
    <p class="modal-sub">
      Reporta porte incorrecto del uniforme. Marca el nivel (1 a 4). Al llegar a 4 se notifica por WhatsApp.
    </p>

    <label class="modal-label">Seleccionado</label>
    <div id="uniSelectedBox" class="status" style="margin-top:6px;">
      <span class="dot" id="uniLevelDot"></span>
      <div>
        <div id="uniSelectedName" style="font-weight:900;">Selecciona un estudiante de la lista</div>
        <div class="muted" id="uniSelectedMeta">‚Äî</div>
      </div>
    </div>

    <label class="modal-label" for="uniCourse">Curso</label>
    <select id="uniCourse" class="modal-input"></select>

    <datalist id="uniStudentsList"></datalist>

    <label class="modal-label" for="uniStudentSelect">Estudiante (lista)</label>
    <select id="uniStudentSelect" class="modal-input"></select>

    <label class="modal-label" for="uniStudent">Estudiante</label>
    <input id="uniStudent" class="modal-input" type="text"
      list="uniStudentsList"
      placeholder="Escribe el nombre del estudiante‚Ä¶" autocomplete="off" />

    <div class="muted small" style="margin-top:6px;">
      Tip: tambi√©n puedes tocar un nombre en ‚ÄúReportados‚Äù para cargarlo arriba.
    </div>

    <div class="disc-levels">
      <button type="button" class="disc-level" data-level="1">1 ‚Ä¢ Leve</button>
      <button type="button" class="disc-level" data-level="2">2</button>
      <button type="button" class="disc-level" data-level="3">3</button>
      <button type="button" class="disc-level danger" data-level="4">4 ‚Ä¢ Grave</button>
    </div>

    <div class="disc-who">
      <div class="muted small" style="margin-bottom:6px;">
        Docentes que han marcado niveles
      </div>
      <div id="uniWhoList" class="disc-who-list">‚Äî</div>
    </div>

    <div class="disc-reported">
      <div class="row row-between" style="margin-top:12px;">
        <div class="muted small">Reportados (mes actual)</div>
      </div>

      <div id="uniReportedList" class="disc-reported-list"></div>
      <div id="uniHint" class="modal-hint muted small"></div>

      <div class="modal-actions" style="justify-content:flex-end;">
        <button id="btnUniBack" type="button" class="btn btn-ghost" hidden>‚Üê Atr√°s</button>
        <button id="btnUniReload" type="button" class="btn btn-ghost">Recargar</button>
        <button id="btnUniClose" type="button" class="btn btn-ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>






<script>
// ======= CONFIG DEL COLEGIO (CAMBIA ESTO) =======
const SCHOOL_LAT = 4.55445;;
const SCHOOL_LNG =-74.11165;
let SCHOOL_RADIUS_METERS = 60;
let REQUIRED_ACCURACY_METERS = 30;


// ======= GOOGLE SHEETS (CAMBIA ESTO) =======
const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzqLGNfjp0CJi51woGWje8EmKT8rk7uBFhtCHCS-H_R9x4H5NICgYA-S9yu1K6mR7kc/exec"; // ej: https://script.google.com/macros/s/XXXX/exec
const GS_API_KEY = "deimerDh2191docentesRegistros2026appandoidios";        // igual que en Code.gs

// ======= UI =======
const $ = (id) => document.getElementById(id);

const teacherNameEl = $("teacherName");
const tbody = $("tbody");
const statusTitle = $("statusTitle");
const statusMsg = $("statusMsg");
const dot = $("dot");
const distEl = $("dist");
const accEl = $("acc");
const coordsEl = $("coords");

// ======= LOADER UI =======
const appLoader = $("appLoader");
const loaderTitleEl = $("loaderTitle");
const loaderMsgEl = $("loaderMsg");


// ======= LOGIN MODAL UI =======
const loginModal = $("loginModal");
const loginNameEl = $("loginName");
const loginEmailEl = $("loginEmail");
const loginCourseEl = $("loginCourse");
const btnLoginSave = $("btnLoginSave");
const loginHint = $("loginHint");

  const loginPhoneEl = $("loginPhone");


const deviceIdTextEl = $("deviceIdText");
const btnCopyDevice = $("btnCopyDevice");

const btnRequestAuth = $("btnRequestAuth");
const btnExportXlsx = $("btnExportXlsx");


const btnAdminConfig = $("btnAdminConfig");
const adminConfigModal = $("adminConfigModal");
const cfgOnTime = $("cfgOnTime");
const cfgExitOk = $("cfgExitOk");
const cfgRadius = $("cfgRadius");
const cfgAccuracy = $("cfgAccuracy");
const btnCfgSave = $("btnCfgSave");
const btnCfgClose = $("btnCfgClose");
const cfgHint = $("cfgHint");


const btnEntrada = $("btnEntrada");
const btnSalida  = $("btnSalida");
const btnExport  = $("btnExport");
const btnInstall = $("btnInstall");
const btnRefreshSW = $("btnRefreshSW");
const btnLogout = $("btnLogout");

  // ======= DISCIPLINA (LLAMADO DE ATENCI√ìN) =======
const btnDiscipline = $("btnDiscipline");
const disciplineModal = $("disciplineModal");
// ======= DISCIPLINA (LLAMADO DE ATENCI√ìN) =======
const discWhoList = $("discWhoList");
const discReportedList = $("discReportedList");
const discHint = $("discHint");
const btnDiscClose = $("btnDiscClose");
const btnDiscReload = $("btnDiscReload");
  const btnDiscBack = $("btnDiscBack");


// ‚úÖ NUEVO: UI del seleccionado (sin combo)
const discSelectedNameEl = $("discSelectedName");
const discSelectedMetaEl = $("discSelectedMeta");
const discLevelDotEl = $("discLevelDot");
const discStudentEl = $("discStudent"); // ‚úÖ input para escribir estudiante
// ======= PIERCING (LLAMADO DE ATENCI√ìN) =======
const btnPiercing = $("btnPiercing");
const piercingModal = $("piercingModal");

const piercWhoList = $("piercWhoList");
const piercReportedList = $("piercReportedList");
const piercHint = $("piercHint");

const btnPiercClose = $("btnPiercClose");
const btnPiercReload = $("btnPiercReload");
const btnPiercBack = $("btnPiercBack");

const piercSelectedNameEl = $("piercSelectedName");
const piercSelectedMetaEl = $("piercSelectedMeta");
const piercLevelDotEl = $("piercLevelDot");
const piercStudentEl = $("piercStudent");




// ======= ADMIN UI =======
const btnAdminOpen = $("btnAdminOpen");
const adminModal = $("adminModal");
const adminPinEl = $("adminPin");
const adminNewPinEl = $("adminNewPin");
const adminChangeBlock = $("adminChangeBlock");
const adminHint = $("adminHint");
const adminSub = $("adminSub");
const btnAdminEnter = $("btnAdminEnter");
const btnAdminClose = $("btnAdminClose");

const btnAdminViewAssist = $("btnAdminViewAssist");
const adminAssistModal = $("adminAssistModal");
const adminTeacherSelect = $("adminTeacherSelect");
const adminAssistList = $("adminAssistList");
const adminTeacherTitle = $("adminTeacherTitle");
const adminLateCountEl = $("adminLateCount");
const adminEarlyExitCountEl = $("adminEarlyExitCount");
const btnAdminAssistClose = $("btnAdminAssistClose");
const adminMonthSelect = $("adminMonthSelect");

const btnAdminManual = $("btnAdminManual");
const adminManualModal = $("adminManualModal");
const adminManualTeacher = $("adminManualTeacher");
const btnAdminManualEntrada = $("btnAdminManualEntrada");
const btnAdminManualSalida  = $("btnAdminManualSalida");
const btnAdminManualClose   = $("btnAdminManualClose");
const adminManualHint       = $("adminManualHint");



// ======= ADMIN: APROBAR DISPOSITIVOS =======
const btnAdminApproveDevices = $("btnAdminApproveDevices");
const adminDevicesModal = $("adminDevicesModal");
const adminDevicesList = $("adminDevicesList");
const adminDevicesCount = $("adminDevicesCount");
const btnAdminDevicesClose = $("btnAdminDevicesClose");
const btnAdminDevicesReload = $("btnAdminDevicesReload");

const btnUserMenu = $("btnUserMenu");
const userMenu = $("userMenu");
const userInitialsEl = $("userInitials");



const btnToggleRecords = $("btnToggleRecords");
const recordsPanel = $("recordsPanel");
const recordsList = $("recordsList");

const lateCountEl = $("lateCount");
const earlyExitCountEl = $("earlyExitCount");

const adminMonthSummary = $("adminMonthSummary");
const monthTeachersCountEl = $("monthTeachersCount");
const monthRecordsCountEl = $("monthRecordsCount");


// ===== Admin filtros en panel Registros =====
const adminRecordsFilters = $("adminRecordsFilters");
const recordsMonthSelect = $("recordsMonthSelect");
const recordsTeacherSelect = $("recordsTeacherSelect");


let hasEntradaToday = false;
let hasSalidaToday  = false;


function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function normalizeDateYYYYMMDD(v) {
  const s = String(v || "").trim();

  // ya viene como 2026-02-01
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // viene como 01/02/2026 (dd/MM/yyyy)
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
    const [dd, mm, yyyy] = s.split("/");
    return `${yyyy}-${mm}-${dd}`;
  }

  // intentar parsear
  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  return "";
}

function updateDailyButtonsState(records) {
  // En admin, no se usan estos botones (y adem√°s el input dice ADMINISTRADOR)
  if (isAdminMode()) {
    btnEntrada.disabled = true;
    btnSalida.disabled = true;
    btnSalida.classList.remove("is-inactive");
    return;
  }

  const p = loadProfile();
  if (!p) return;

  const today = todayStr();

  // ‚úÖ OJO: "records" aqu√≠ YA viene filtrado al docente logueado (en modo normal)
  hasEntradaToday = (records || []).some(r =>
    String(r.type || "").toUpperCase() === "ENTRADA" &&
    normalizeDateYYYYMMDD(r.date) === today
  );

  hasSalidaToday = (records || []).some(r =>
    String(r.type || "").toUpperCase() === "SALIDA" &&
    normalizeDateYYYYMMDD(r.date) === today
  );

  // ‚úÖ Estados:
  // 1) Ninguno: Entrada ON, Salida OFF
  // 2) Solo entrada: Entrada OFF, Salida ON
  // 3) Entrada + salida: ambos OFF hasta ma√±ana
  if (!hasEntradaToday && !hasSalidaToday) {
    btnEntrada.disabled = false;

    btnSalida.disabled = true;
    btnSalida.classList.add("is-inactive");
    return;
  }

  if (hasEntradaToday && !hasSalidaToday) {
    btnEntrada.disabled = true;

    btnSalida.disabled = false;
    btnSalida.classList.remove("is-inactive");
    return;
  }

  // ‚úÖ Si ya est√°n ambas hoy:
  btnEntrada.disabled = true;
  btnSalida.disabled = true;
  btnSalida.classList.remove("is-inactive");
}




// ======= Helpers =======



  
function pad(n){ return String(n).padStart(2,"0"); }
function nowParts() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const ss = pad(d.getSeconds());
  return { date:`${yyyy}-${mm}-${dd}`, time:`${hh}:${mi}:${ss}`, iso:d.toISOString() };
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

// ======= CACHE + TIMEOUT LIST =======
const LS_CACHE_KEY = "asistencia_cache_records_v1";
const LIST_TIMEOUT_MS = 12000; // 12s (aj√∫stalo si quieres)

// key de cach√© seg√∫n modo/mes/docente
function cacheKeyForCurrentView_() {
  const admin = isAdminMode();
  const p = loadProfile();

  // ‚úÖ Admin: mes del selector
  // ‚úÖ Docente: mes actual SIEMPRE
  const month = admin
    ? (recordsMonthSelect ? String(recordsMonthSelect.value || "").trim() : "")
    : monthKeyFromDate(new Date()); // YYYY-MM

  const teacher = (!admin && p && p.name) ? normalizeKey(p.name) : "__ADMIN__";
  return `${admin ? "admin" : "user"}|${month || "current"}|${teacher}`;
}


function saveRecordsCache_(key, records) {
  try {
    const raw = localStorage.getItem(LS_CACHE_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    obj[key] = { ts: Date.now(), records: records || [] };
    localStorage.setItem(LS_CACHE_KEY, JSON.stringify(obj));
  } catch {}
}

function loadRecordsCache_(key, maxAgeMs = 24 * 60 * 60 * 1000) {
  try {
    const raw = localStorage.getItem(LS_CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    const item = obj[key];
    if (!item || !Array.isArray(item.records)) return null;
    if ((Date.now() - (item.ts || 0)) > maxAgeMs) return null;
    return item.records;
  } catch {
    return null;
  }
}

async function fetchJsonWithTimeout_(url, options = {}, timeoutMs = LIST_TIMEOUT_MS) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);

  try {
    const res = await fetch(url, { ...options, signal: ctrl.signal });
    const data = await res.json();
    return data;
  } finally {
    clearTimeout(t);
  }
}

  

function isNTCRecord(r) {
  if (!r) return false;

  // SOLO si el servidor lo env√≠a expl√≠cito
  if (r.ntc === true) return true;

  const ntcStr = String(r.ntc ?? "").trim().toLowerCase();
  return (ntcStr === "true" || ntcStr === "1");
}



// ======= Admin API =======
async function gsAdminCheckPin(pin) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_check_pin", pin, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_check_failed");
  return data;
}

async function gsAdminChangePin(oldPin, newPin) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_change_pin", old_pin: oldPin, new_pin: newPin, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_change_failed");
  return data;
}


async function gsAdminListMonths() {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_list_months", key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_list_months_failed");
  return data.months || []; // [{key:"YYYY-MM", label:"enero 2026"}, ...]
}


async function gsAdminListTeachers(month) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_list_teachers", month, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_list_teachers_failed");
  return data.teachers || [];
}


async function gsAdminGetTeacherRecords(teacher, month) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_get_teacher_records", teacher, month, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_get_records_failed");
  return data.records || [];
}

async function gsAdminGetConfig() {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_get_config", key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_get_config_failed");
  return data.config;
}

async function gsAdminSetConfig(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_set_config", ...payload, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_set_config_failed");
  return data;
}

async function gsAdminManualRegister(teacher, type, iso) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_manual_register", teacher, type, iso, key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_manual_register_failed");
  return data;
}



async function gsAdminListDeviceRequests() {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "admin_list_device_requests", key: GS_API_KEY })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_list_device_requests_failed");
  return data.requests || [];
}

async function gsAdminSetDeviceAuth(row, authorized) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "admin_set_device_auth",
      row,
      authorized: authorized ? "SI" : "NO",
      key: GS_API_KEY
    })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.msg || data.error || "admin_set_device_auth_failed");
  return data;
}


// ======= Contadores de resumen (tardes / salidas antes) =======
let EXIT_OK_HHMM_CLIENT = "14:00";
let ON_TIME_HHMM_CLIENT = "06:30";

function timeToMinutes(hhmmss) {
  const s = String(hhmmss || "").trim();
  const m = s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if (!m) return null;
  const hh = Number(m[1]);
  const mm = Number(m[2]);
  return hh * 60 + mm;
}

function isEarlyExitRecord(r) {
  if (!r || String(r.type || "").toUpperCase() !== "SALIDA") return false;
  const t = timeToMinutes(r.time);
  const limit = timeToMinutes(EXIT_OK_HHMM_CLIENT);
  if (t == null || limit == null) return false;
  return t < limit;
}


function normalizeKey(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .normalize("NFD")                 // separa tildes
    .replace(/[\u0300-\u036f]/g, "")  // quita tildes
    .replace(/\s+/g, " ");            // colapsa espacios
}


  function formatDateShort_(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  if (isNaN(d)) return "";
  return d.toLocaleDateString("es-CO", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  });
}


function samePersonName(a, b) {
  return normalizeKey(a) === normalizeKey(b);
}


function monthKeyFromDate(d) {
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}`; // YYYY-MM
}

function buildMonthOptions(lastN = 12) {
  const out = [];
  const now = new Date();
  for (let i = 0; i < lastN; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = monthKeyFromDate(d);
    const label = d.toLocaleDateString("es-CO", { month: "long", year: "numeric" });
    out.push({ key, label: label.charAt(0).toUpperCase() + label.slice(1) });
  }
  return out;
}

function uniqueTeachersFromRecords(records) {
  const set = new Set();
  (records || []).forEach(r => {
    const t = String(r.teacher || "").trim();
    if (t) set.add(t);
  });
  return Array.from(set).sort((a,b) => a.localeCompare(b, "es"));
}

function updateAdminMonthSummaryFromRecords(allMonthRecords) {
  if (!adminMonthSummary || !monthTeachersCountEl || !monthRecordsCountEl) return;

  const admin = isAdminMode();

  // ‚úÖ si NO es admin, SIEMPRE oculto y salgo
  adminMonthSummary.hidden = !admin;
  if (!admin) return;

  const totalRecords = (allMonthRecords || []).length;
  const teachers = uniqueTeachersFromRecords(allMonthRecords || []);
  const totalTeachers = teachers.length;

  monthTeachersCountEl.textContent = `Docentes: ${totalTeachers}`;
  monthRecordsCountEl.textContent = `Registros: ${totalRecords}`;
}



function setStatus(kind, title, msg) {
  statusTitle.textContent = title;
  statusMsg.textContent = msg;
  dot.className = "dot" + (kind ? ` ${kind}` : "");
}


let __loadingCount = 0;

function setLoading(isLoading, title = "Procesando‚Ä¶", msg = "Por favor espera‚Ä¶") {
  if (isLoading) __loadingCount++;
  else __loadingCount = Math.max(0, __loadingCount - 1);

  const on = __loadingCount > 0;

// Deshabilitar botones principales para evitar dobles registros
if (on) {
  btnEntrada.disabled = true;
  btnSalida.disabled = true;
  btnExport.disabled = true;
} else {
  // ‚úÖ Al terminar el loader, restaurar el estado real del d√≠a
  btnExport.disabled = false;
  updateDailyButtonsState(cachedRecords); // cachedRecords ya es "lo que ve" el docente
}


  // Mostrar overlay loader
  if (appLoader) {
    appLoader.hidden = !on;
    if (loaderTitleEl) loaderTitleEl.textContent = title;
    if (loaderMsgEl) loaderMsgEl.textContent = msg;
  }

  // Evitar scroll/taps detr√°s
  document.body.classList.toggle("is-loading", on);

  // Mensaje visual (tu status bar)
  if (on) setStatus("warn", title, msg);
}




// ======= PERFIL + DEVICE ID =======
const LS_PROFILE_KEY = "asistencia_profile_v1";
const LS_DEVICE_KEY  = "asistencia_device_id_v1";

function getDeviceId() {
  let id = localStorage.getItem(LS_DEVICE_KEY);
  if (!id) {
    // UUID seguro: evita ReferenceError si crypto no existe
    const c = (typeof window !== "undefined") ? window.crypto : null;
    id = (c && typeof c.randomUUID === "function")
      ? c.randomUUID()
      : "dev-" + Math.random().toString(16).slice(2) + Date.now().toString(16);

    localStorage.setItem(LS_DEVICE_KEY, id);
  }
  return id;
}


function loadProfile() {
  try {
    const raw = localStorage.getItem(LS_PROFILE_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch {
    return null;
  }
}

function openAdminConfigModal() {
  if (!adminConfigModal) return;
  adminConfigModal.hidden = false;
  cfgHint.textContent = "Cargando‚Ä¶";
}

function closeAdminConfigModal() {
  if (!adminConfigModal) return;
  adminConfigModal.hidden = true;
  cfgHint.textContent = "";
}

async function loadAdminConfigIntoUI() {
  const cfg = await gsAdminGetConfig();

  // set inputs
  cfgOnTime.value = cfg.ON_TIME_HHMM || "06:30";
  cfgExitOk.value = cfg.EXIT_OK_HHMM || "14:00";
  cfgRadius.value = String(cfg.SCHOOL_RADIUS_METERS ?? 120);
  cfgAccuracy.value = String(cfg.REQUIRED_ACCURACY_METERS ?? 50);

  // aplicar en runtime (impacta ubicaci√≥n + contadores)
  ON_TIME_HHMM_CLIENT = cfgOnTime.value;
  EXIT_OK_HHMM_CLIENT = cfgExitOk.value;
  SCHOOL_RADIUS_METERS = Number(cfgRadius.value) || 120;
  REQUIRED_ACCURACY_METERS = Number(cfgAccuracy.value) || 50;

  cfgHint.textContent = "Listo ‚úÖ";
}

function isValidHHMM(s) {
  return /^\d{2}:\d{2}$/.test(String(s || "").trim());
}


function saveProfile(profile) {
  localStorage.setItem(LS_PROFILE_KEY, JSON.stringify(profile));
}

const LS_ADMIN_KEY = "asistencia_admin_session_v1";

function isAdminMode() {
  return localStorage.getItem(LS_ADMIN_KEY) === "1";
}

function setAdminMode(on) {
  localStorage.setItem(LS_ADMIN_KEY, on ? "1" : "0");
  document.body.classList.toggle("is-admin", on);

  if (btnAdminViewAssist) btnAdminViewAssist.hidden = !on;
  if (btnAdminConfig) btnAdminConfig.hidden = !on;

  if (btnAdminManual) btnAdminManual.hidden = !on;



  if (btnAdminApproveDevices) btnAdminApproveDevices.hidden = !on;


  // Si entro como admin: cerrar login modal y bloquear ‚Äúdocente‚Äù
  if (on) {
    loginModal.hidden = true;
    // ‚úÖ cargar cursos/estudiantes para los 3 modales
initAllModalCourses_();

    teacherNameEl.value = "ADMINISTRADOR";
    teacherNameEl.disabled = true;
    teacherNameEl.classList.add("is-locked");
    updateUserInitials({ name: "Administrador" });
    if (btnUserMenu) btnUserMenu.hidden = false;
    setMenuOpen(false);

initAdminRecordsPanelUI();
refreshFromSheet();


  } else {
    // Si salgo de admin: vuelve a comportamiento normal
    if (!loadProfile()) {
      teacherNameEl.disabled = false;
      teacherNameEl.classList.remove("is-locked");
      teacherNameEl.value = "";
      updateUserInitials(null);
      if (btnUserMenu) btnUserMenu.hidden = true;
      setMenuOpen(false);
    }
  }

  initAdminRecordsPanelUI(); // ‚úÖ fuerza ocultar/mostrar SIEMPRE

}

function initAdminRecordsPanelUI() {
  if (!adminRecordsFilters || !recordsMonthSelect || !recordsTeacherSelect) return;

  const on = isAdminMode();

if (btnExportXlsx) btnExportXlsx.hidden = !on;


  // ‚úÖ SOLO ADMIN ve filtros
  adminRecordsFilters.hidden = !on;

  // ‚úÖ SOLO ADMIN ve resumen del mes
  if (typeof adminMonthSummary !== "undefined" && adminMonthSummary) {
    adminMonthSummary.hidden = !on;
  }

  // Si NO es admin, no llenar combos (y listo)
  if (!on) return;

  // llenar meses (√∫ltimos 12)
  const months = buildMonthOptions(12);
  recordsMonthSelect.innerHTML = months
    .map(m => `<option value="${m.key}">${escapeHtml(m.label)}</option>`)
    .join("");

  // mes actual por defecto
  recordsMonthSelect.value = monthKeyFromDate(new Date());

  // docente inicia en Todos
  recordsTeacherSelect.innerHTML = `<option value="__ALL__">Todos</option>`;
}


// ‚úÖ cambios de filtros
if (recordsMonthSelect) {
  recordsMonthSelect.addEventListener("change", async () => {
    if (!isAdminMode()) return;
    await refreshFromSheet();
  });
}

if (recordsTeacherSelect) {
  recordsTeacherSelect.addEventListener("change", () => {
    if (!isAdminMode()) return;
    // re-filtra usando los datos ya cargados
    render(__recordsAllRaw);
  });
}

// ===== Submen√∫ Faltas =====
const btnFaltasMenu = document.getElementById("btnFaltasMenu");
const faltasSubMenu = document.getElementById("faltasSubMenu");

function closeFaltasSubMenu_(){
  if (!faltasSubMenu) return;
  faltasSubMenu.hidden = true;
  if (btnFaltasMenu) btnFaltasMenu.setAttribute("aria-expanded", "false");
}

function toggleFaltasSubMenu_(){
  if (!faltasSubMenu) return;
  const willOpen = !!faltasSubMenu.hidden;
  faltasSubMenu.hidden = !willOpen;
  if (btnFaltasMenu) btnFaltasMenu.setAttribute("aria-expanded", willOpen ? "true" : "false");
}

if (btnFaltasMenu) {
  btnFaltasMenu.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    toggleFaltasSubMenu_();
  });
}

// ‚úÖ Si el usuario toca cualquier opci√≥n dentro del submen√∫, lo cerramos
if (faltasSubMenu) {
  faltasSubMenu.addEventListener("click", () => {
    closeFaltasSubMenu_();
  });
}

// ‚úÖ Si tienes una funci√≥n setMenuOpen(false), el men√∫ se cierra:
// pero el submen√∫ puede quedar "abierto" en estado => lo reseteamos
document.addEventListener("click", (e) => {
  // Si el men√∫ est√° abierto y haces click fuera, probablemente tu c√≥digo ya lo cierra.
  // Aqu√≠ solo aseguramos cerrar el submen√∫ si el click fue fuera del bloque.
  if (!faltasSubMenu || !btnFaltasMenu) return;
  const inside = (e.target && (faltasSubMenu.contains(e.target) || btnFaltasMenu.contains(e.target)));
  if (!inside) closeFaltasSubMenu_();
});


// Estado inicial
if (btnAdminViewAssist) btnAdminViewAssist.hidden = !isAdminMode();

if (btnAdminApproveDevices) btnAdminApproveDevices.hidden = !isAdminMode();
if (btnAdminConfig) btnAdminConfig.hidden = !isAdminMode();
if (btnAdminManual) btnAdminManual.hidden = !isAdminMode();



function getInitials(name) {
  const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
  if (!parts.length) return "?";
  const first = parts[0][0] || "";
  const last = (parts.length > 1 ? parts[parts.length - 1][0] : "") || "";
  return (first + last).toUpperCase();
}

function setMenuOpen(open) {
  if (!btnUserMenu || !userMenu) return;
  userMenu.hidden = !open;
  btnUserMenu.setAttribute("aria-expanded", String(open));
}

function updateUserInitials(profile) {
  if (!userInitialsEl) return;
  if (profile && profile.name) userInitialsEl.textContent = getInitials(profile.name);
  else userInitialsEl.textContent = "?";
}



function applySessionUI(profile) {
  if (profile && profile.name) {
    teacherNameEl.value = profile.name;

    // input bloqueado y grande
    teacherNameEl.disabled = true;
    teacherNameEl.classList.add("is-locked");

    // iniciales en el bot√≥n circular
    updateUserInitials(profile);

    // mostrar bot√≥n/menu solo si hay sesi√≥n
    if (btnUserMenu) btnUserMenu.hidden = false;
  } else {
    teacherNameEl.disabled = false;
    teacherNameEl.classList.remove("is-locked");

    updateUserInitials(null);

    if (btnUserMenu) btnUserMenu.hidden = true;
    setMenuOpen(false);
  }
}


function logout() {
  // borrar perfil docente
  localStorage.removeItem(LS_PROFILE_KEY);

  // apagar admin
  setAdminMode(false);

  // limpiar UI
  applySessionUI(null);

  // abrir modal login
  loginModal.hidden = false;
  updateDeviceIdUI();
  loginHint.textContent = "Sesi√≥n cerrada. Inicia sesi√≥n para continuar.";

  setStatus("warn", "Sesi√≥n cerrada", "Vuelve a iniciar sesi√≥n para registrar.");
}


function requireLogin() {
  // ‚úÖ Si est√° en modo admin, NO pedir perfil docente
  if (isAdminMode()) {
    return { name: "ADMINISTRADOR", email: "admin@local", course: "ADMIN" };
  }

  const p = loadProfile();
  if (p && p.name && p.email && p.course) return p;

  // Mostrar modal y bloquear uso hasta guardar
  loginModal.hidden = false;
  updateDeviceIdUI();
  loginHint.textContent = "Completa tus datos para continuar.";
  return null;
}



function updateDeviceIdUI() {
  if (!deviceIdTextEl) return;
  deviceIdTextEl.textContent = getDeviceId();
}

if (btnCopyDevice) {
  btnCopyDevice.addEventListener("click", async () => {
    try {
      const id = getDeviceId();
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(id);
      } else {
        // fallback antiguo
        const ta = document.createElement("textarea");
        ta.value = id;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      loginHint.textContent = "ID copiado. P√©galo en la hoja DISPOSITIVOS para autorizar.";
    } catch (e) {
      loginHint.textContent = "No se pudo copiar. Copia el ID manualmente.";
    }
  });
}

if (btnAdminConfig) {
  btnAdminConfig.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
      openAdminConfigModal();
      setLoading(true, "Cargando‚Ä¶", "Leyendo CONFIG.");
      await loadAdminConfigIntoUI();
    } catch (e) {
      cfgHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}

if (btnCfgClose) btnCfgClose.addEventListener("click", closeAdminConfigModal);

if (btnCfgSave) {
  btnCfgSave.addEventListener("click", async () => {
    const onTime = String(cfgOnTime.value || "").trim();
    const exitOk = String(cfgExitOk.value || "").trim();
    const radius = String(cfgRadius.value || "").trim();
    const acc = String(cfgAccuracy.value || "").trim();

    if (!isValidHHMM(onTime) || !isValidHHMM(exitOk)) {
      cfgHint.textContent = "Horas inv√°lidas. Usa HH:MM (ej: 06:30).";
      return;
    }
    const r = Number(radius), a = Number(acc);
    if (!Number.isFinite(r) || r <= 0 || !Number.isFinite(a) || a <= 0) {
      cfgHint.textContent = "Radio/precisi√≥n inv√°lidos (n√∫meros > 0).";
      return;
    }

    try {
      setLoading(true, "Guardando‚Ä¶", "Actualizando CONFIG.");
      const resp = await gsAdminSetConfig({
        on_time_hhmm: onTime,
        exit_ok_hhmm: exitOk,
        school_radius_m: r,
        required_accuracy_m: a
      });

      // aplicar runtime
      ON_TIME_HHMM_CLIENT = onTime;
      EXIT_OK_HHMM_CLIENT = exitOk;
      SCHOOL_RADIUS_METERS = r;
      REQUIRED_ACCURACY_METERS = a;

      cfgHint.textContent = resp.msg || "Guardado ‚úÖ";
      setStatus("", "Configuraci√≥n", "Cambios aplicados ‚úÖ");
    } catch (e) {
      cfgHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}


// Toggle del men√∫ al tocar el bot√≥n circular
if (btnUserMenu) {
  btnUserMenu.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = userMenu && !userMenu.hidden;
    setMenuOpen(!isOpen);
  });
}

// Cerrar men√∫ al tocar fuera
document.addEventListener("click", () => setMenuOpen(false));

// Cerrar men√∫ al tocar una opci√≥n
if (userMenu) {
  userMenu.addEventListener("click", () => setMenuOpen(false));
}



btnLoginSave.addEventListener("click", async () => {
  const name = (loginNameEl.value || "").trim();
  const email = (loginEmailEl.value || "").trim().toLowerCase();
  const course = (loginCourseEl.value || "").trim();

  // ‚úÖ NUEVO: celular opcional desde modal (si existe)
  const phoneRaw = (loginPhoneEl && loginPhoneEl.value) ? loginPhoneEl.value : "";
  const phone = String(phoneRaw || "").trim().replace(/\D/g, ""); // solo d√≠gitos

  if (!name || !email || !course) {
    loginHint.textContent = "Faltan datos. Nombre, correo y curso son obligatorios.";
    return;
  }
  if (!/^\S+@\S+\.\S+$/.test(email)) {
    loginHint.textContent = "Correo inv√°lido.";
    return;
  }

  // ‚úÖ Validaci√≥n suave: solo valida si escribi√≥ algo
  if (phone && phone.length < 10) {
    loginHint.textContent = "Celular inv√°lido. Ej: 3001234567";
    return;
  }

  try {
    setLoading(true, "Verificando‚Ä¶", "Comprobando si este tel√©fono ya est√° autorizado.");
    loginHint.textContent = "Verificando autorizaci√≥n‚Ä¶";

    const chk = await gsCheckDeviceAuth({
      action: "check_device_auth",
      email,
      device_id: getDeviceId()
    });

    const authorized = (chk && (chk.authorized === true || String(chk.authorized).toLowerCase() === "true"));

    if (!authorized) {
      const msg = (chk && chk.msg) ? chk.msg : "A√∫n no autorizado. Usa 'Solicitar autorizaci√≥n' y espera aprobaci√≥n.";
      loginHint.textContent = msg;

      setStatus("bad", "No autorizado", msg);
      loginModal.hidden = false;
      return;
    }

    // ‚úÖ validar nombre permitido
    const allowedName = (chk && chk.allowed_name) ? String(chk.allowed_name).trim() : "";
    if (allowedName && !samePersonName(name, allowedName)) {
      const msg = `El nombre no corresponde a este dispositivo.\nAutorizado para: ${allowedName}`;
      loginHint.textContent = msg;
      setStatus("bad", "Nombre no v√°lido", msg);
      loginModal.hidden = false;
      return;
    }

    // ‚úÖ guardar perfil (sin romper nada)
    const profile = { name, email, course };

    // ‚úÖ si el usuario escribi√≥ celular, lo guardamos tambi√©n
    if (phone) profile.whatsapp_to = phone;

    setAdminMode(false); // docente jam√°s queda admin
    saveProfile(profile);

    applySessionUI(profile);
    loginModal.hidden = true;

    // ‚úÖ si hay tel√©fono, lo guardamos inmediatamente (sin prompt)
    if (phone) {
      localStorage.setItem("disc_whatsapp_to", phone);
      await gsSetWhatsAppTo_(profile.email, getDeviceId(), phone);
    } else {
      // si no lo escribi√≥, mantiene tu comportamiento actual (prompt/server/local)
      await ensureWhatsAppToOnLogin_(profile.email, getDeviceId());
    }

    loginHint.textContent = "";
    setStatus("", "Sesi√≥n iniciada", "Dispositivo autorizado ‚úÖ Ya puedes registrar asistencia.");

    refreshFromSheet({ silent: true, useCache: false });
    initAllModalCourses_();


  } catch (e) {
    const msg = String(e && e.message ? e.message : e);
    loginHint.textContent = msg;
    setStatus("bad", "Error de verificaci√≥n", msg);
  } finally {
    setLoading(false);
  }
});



function openAdminModal() {
  if (!adminModal) return;
  adminModal.hidden = false;
  adminChangeBlock.hidden = true;
  adminSub.textContent = "Ingresa tu PIN para continuar.";
  adminHint.textContent = "";
  adminPinEl.value = "";
  adminNewPinEl.value = "";
  adminPinEl.focus();
}

function closeAdminModal() {
  if (!adminModal) return;
  adminModal.hidden = true;
  adminHint.textContent = "";

  // ‚úÖ reset modo del bot√≥n
  if (btnAdminEnter) {
    delete btnAdminEnter.dataset.mode;
    delete btnAdminEnter.dataset.oldpin;
  }
}

async function adminEnterFlow() {
  const pin = String(adminPinEl.value || "").trim();
  if (!pin) { adminHint.textContent = "Escribe el PIN."; return; }

  try {
    setLoading(true, "Verificando‚Ä¶", "Comprobando PIN de administrador.");
    const chk = await gsAdminCheckPin(pin);

    if (!chk.authorized) {
      adminHint.textContent = chk.msg || "PIN incorrecto.";
      return;
    }

    // si debe cambiar (pin por defecto)
    if (chk.must_change) {
      adminSub.textContent = "PIN por defecto detectado. Debes cambiarlo ahora.";
      adminChangeBlock.hidden = false;
      adminHint.textContent = "Define un nuevo PIN (4 a 8 d√≠gitos).";
      adminNewPinEl.focus();

      btnAdminEnter.dataset.mode = "change";
      btnAdminEnter.dataset.oldpin = pin;
      return;
    }

    // ‚úÖ ENTRAR COMO ADMIN (CIERRA LOGIN SIEMPRE)
    setAdminMode(true);

    // cerrar modales
    closeAdminModal();
    if (loginModal) loginModal.hidden = true;
    if (loginHint) loginHint.textContent = "";

    // UI
    setStatus("", "Administrador", "Sesi√≥n iniciada como administrador ‚úÖ");

  } catch (e) {
    adminHint.textContent = String(e && e.message ? e.message : e);
  } finally {
    setLoading(false);
  }
}


async function adminChangePinFlow(oldPin) {
  const newPin = String(adminNewPinEl.value || "").trim();
  if (!/^\d{4,8}$/.test(newPin)) {
    adminHint.textContent = "El nuevo PIN debe tener 4 a 8 d√≠gitos.";
    return;
  }

  try {
    setLoading(true, "Actualizando‚Ä¶", "Guardando nuevo PIN de administrador.");
    await gsAdminChangePin(oldPin, newPin);

// ‚úÖ sesi√≥n admin principal
setAdminMode(true);

closeAdminModal();
loginModal.hidden = true;

setStatus("", "Administrador", "PIN actualizado ‚úÖ Sesi√≥n iniciada como administrador.");


    // limpiar estado del bot√≥n
    delete btnAdminEnter.dataset.mode;
    delete btnAdminEnter.dataset.oldpin;

  } catch (e) {
    adminHint.textContent = String(e && e.message ? e.message : e);
  } finally {
    setLoading(false);
  }
}

if (btnAdminOpen) btnAdminOpen.addEventListener("click", openAdminModal);
if (btnAdminClose) btnAdminClose.addEventListener("click", closeAdminModal);

if (btnAdminEnter) {
  btnAdminEnter.addEventListener("click", async () => {
    const mode = btnAdminEnter.dataset.mode || "enter";
    if (mode === "change") {
      const oldPin = btnAdminEnter.dataset.oldpin || "";
      await adminChangePinFlow(oldPin);
    } else {
      await adminEnterFlow();
    }
  });
}


function openAdminAssistModal() {
  if (!adminAssistModal) return;
  adminAssistModal.hidden = false;
  adminAssistList.innerHTML = `<div class="muted small">Cargando‚Ä¶</div>`;
  adminTeacherTitle.textContent = "‚Äî";
  adminLateCountEl.textContent = "Entradas tardes: 0";
  adminEarlyExitCountEl.textContent = "Salidas antes: 0";
}

function closeAdminAssistModal() {
  if (!adminAssistModal) return;
  adminAssistModal.hidden = true;
}

function renderAdminTeacherRecords(teacher, records) {
  adminTeacherTitle.textContent = teacher || "‚Äî";

  // contadores
  const lateCount = (records || []).filter(r =>
    String(r.type || "").toUpperCase() === "ENTRADA" && !!r.late
  ).length;

  const earlyExitCount = (records || []).filter(isEarlyExitRecord).length;

  adminLateCountEl.textContent = `Entradas tardes: ${lateCount}`;
  adminEarlyExitCountEl.textContent = `Salidas antes: ${earlyExitCount}`;

  if (!records || !records.length) {
    adminAssistList.innerHTML = `<div class="muted small">No hay registros para este docente.</div>`;
    return;
  }

  adminAssistList.innerHTML = records.map(r => {
    const type = String(r.type || "").toUpperCase();
    const isLate = (type === "ENTRADA" && !!r.late);
    const isEarly = isEarlyExitRecord(r);

    // ‚úÖ NTC SOLO si viene expl√≠cito desde el servidor (por NOTE = "NTC")
    const ntc = isNTCRecord(r);
    const ntcTxt = ntc ? " ‚Ä¢ NTC" : "";

    const cls = (type === "ENTRADA")
      ? (isLate ? "record-card late" : "record-card ontime")
      : (isEarly ? "record-card late" : "record-card ontime");

    const badge = (type === "ENTRADA")
      ? (isLate
          ? `<span class="badge badge-late">ENTRADA ‚Ä¢ TARDE${ntcTxt}</span>`
          : `<span class="badge badge-ontime">ENTRADA ‚Ä¢ A TIEMPO${ntcTxt}</span>`
        )
      : (isEarly
          ? `<span class="badge badge-late">SALIDA ‚Ä¢ ANTES${ntcTxt}</span>`
          : `<span class="badge badge-ontime">SALIDA ‚Ä¢ OK${ntcTxt}</span>`
        );

    return `
      <div class="${cls}" style="margin-bottom:10px;">
        <div class="top">
          <span class="teacher">${escapeHtml(teacher)}</span>
          ${badge}
        </div>
        <div class="meta">
          ${escapeHtml(r.date)} ‚Ä¢ ${escapeHtml(r.time)}
        </div>
      </div>
    `;
  }).join("");
}




async function adminLoadTeachersAndBind() {
  const month = adminMonthSelect ? adminMonthSelect.value : "";
  const teachers = await gsAdminListTeachers(month);

  adminTeacherSelect.innerHTML = (teachers.length ? teachers : ["(Sin docentes)"])
    .map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`)
    .join("");

  if (teachers.length) {
    const first = teachers[0];
    const recs = await gsAdminGetTeacherRecords(first, month);
    renderAdminTeacherRecords(first, recs);
  } else {
    adminAssistList.innerHTML = `<div class="muted small">No hay docentes en ese mes.</div>`;
    adminTeacherTitle.textContent = "‚Äî";
    adminLateCountEl.textContent = "Tardes: 0";
    adminEarlyExitCountEl.textContent = "Salidas antes: 0";
  }
}


function openAdminManualModal() {
  if (!adminManualModal) return;
  adminManualModal.hidden = false;
  adminManualHint.textContent = "";
  adminManualTeacher.innerHTML = `<option>(Cargando...)</option>`;
}

function closeAdminManualModal() {
  if (!adminManualModal) return;
  adminManualModal.hidden = true;
  adminManualHint.textContent = "";
}

async function adminLoadTeachersForManual() {
  const teachers = await gsAdminListTeachers();
  adminManualTeacher.innerHTML = (teachers.length ? teachers : ["(Sin docentes)"])
    .map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`)
    .join("");
}

async function adminDoManual(type) {
  const teacher = String(adminManualTeacher.value || "").trim();
  if (!teacher || teacher === "(Sin docentes)") {
    adminManualHint.textContent = "No hay docentes para seleccionar.";
    return;
  }

  try {
    setLoading(true, "Guardando‚Ä¶", "Registrando asistencia manual (NTC).");

    // usa la hora actual (igual que si lo hiciera el docente)
    const iso = new Date().toISOString();

    await gsAdminManualRegister(teacher, type, iso);

    adminManualHint.textContent = `‚úÖ ${type} guardada (NTC) para ${teacher}.`;

    // refrescar listas/contadores
refreshFromSheet(); // ‚úÖ sin await

    // si est√° abierto el modal de asistencias admin, recarga si coincide el docente
    // (opcional, no rompe nada)
  } catch (e) {
    adminManualHint.textContent = String(e && e.message ? e.message : e);
  } finally {
    setLoading(false);
  }
}



if (btnAdminManual) {
  btnAdminManual.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
      openAdminManualModal();
      setLoading(true, "Cargando‚Ä¶", "Leyendo docentes del mes actual.");
      await adminLoadTeachersForManual();
    } catch (e) {
      adminManualHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminManualEntrada) btnAdminManualEntrada.addEventListener("click", () => adminDoManual("ENTRADA"));
if (btnAdminManualSalida)  btnAdminManualSalida.addEventListener("click", () => adminDoManual("SALIDA"));
if (btnAdminManualClose)   btnAdminManualClose.addEventListener("click", closeAdminManualModal);


if (btnAdminViewAssist) {
  btnAdminViewAssist.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
    openAdminAssistModal();
setLoading(true, "Cargando‚Ä¶", "Leyendo docentes del mes seleccionado.");

// ‚úÖ AQUI VA ESTO:
if (adminMonthSelect) {
  const months = await gsAdminListMonths();
  adminMonthSelect.innerHTML = (months.length ? months : [{key:"",label:"(Sin meses)"}])
    .map(m => `<option value="${escapeHtml(m.key)}">${escapeHtml(m.label)}</option>`)
    .join("");
}

// y despu√©s:
await adminLoadTeachersAndBind();

    } catch (e) {
      adminAssistList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminApproveDevices) {
  btnAdminApproveDevices.addEventListener("click", async () => {
    if (!isAdminMode()) {
      setStatus("warn", "Requiere admin", "Ingresa como administrador primero.");
      openAdminModal();
      return;
    }
    try {
      openAdminDevicesModal();
      setLoading(true, "Cargando‚Ä¶", "Leyendo solicitudes pendientes.");
      await adminLoadDeviceRequests();
    } catch (e) {
      adminDevicesList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminDevicesReload) {
  btnAdminDevicesReload.addEventListener("click", async () => {
    try {
      setLoading(true, "Recargando‚Ä¶", "Leyendo solicitudes pendientes.");
      await adminLoadDeviceRequests();
    } finally {
      setLoading(false);
    }
  });
}

if (btnAdminDevicesClose) btnAdminDevicesClose.addEventListener("click", closeAdminDevicesModal);



if (adminMonthSelect) {
  adminMonthSelect.addEventListener("change", async () => {
    try {
      adminAssistList.innerHTML = `<div class="muted small">Cargando‚Ä¶</div>`;
      await adminLoadTeachersAndBind();
    } catch (e) {
      adminAssistList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    }
  });
}



if (adminTeacherSelect) {
  adminTeacherSelect.addEventListener("change", async () => {
    const t = adminTeacherSelect.value;
    try {
      adminAssistList.innerHTML = `<div class="muted small">Cargando‚Ä¶</div>`;
const month = adminMonthSelect ? adminMonthSelect.value : "";
const recs = await gsAdminGetTeacherRecords(t, month);
      renderAdminTeacherRecords(t, recs);
    } catch (e) {
      adminAssistList.innerHTML = `<div class="muted small">${escapeHtml(String(e && e.message ? e.message : e))}</div>`;
    }
  });
}

if (btnAdminAssistClose) btnAdminAssistClose.addEventListener("click", closeAdminAssistModal);

function openAdminDevicesModal() {
  if (!adminDevicesModal) return;
  adminDevicesModal.hidden = false;
  if (adminDevicesList) adminDevicesList.innerHTML = `<div class="muted small">Cargando‚Ä¶</div>`;
  if (adminDevicesCount) adminDevicesCount.textContent = "Pendientes: ‚Äî";
}

function closeAdminDevicesModal() {
  if (!adminDevicesModal) return;
  adminDevicesModal.hidden = true;
}

function renderAdminDeviceRequests(requests) {
  const list = (requests || []);
  if (adminDevicesCount) adminDevicesCount.textContent = `Pendientes: ${list.length}`;

  if (!list.length) {
    adminDevicesList.innerHTML = `<div class="muted small">No hay solicitudes pendientes ‚úÖ</div>`;
    return;
  }

  adminDevicesList.innerHTML = list.map(r => {
    const email = escapeHtml(r.email || "");
    const device = escapeHtml(r.device_id || "");
    const notes = escapeHtml(r.notes || "");
    const row = Number(r.row || 0);

    return `
      <div class="record-card" style="margin-bottom:10px;">
        <div class="top">
          <span class="teacher">${email}</span>
          <span class="badge badge-neutral">Fila: ${row}</span>
        </div>

        <div class="meta" style="margin-top:8px;">
          <div class="muted small">DEVICE_ID:</div>
          <div class="device-id" style="margin-top:4px;">${device}</div>
        </div>

        <div class="meta" style="margin-top:10px;">
          <div class="muted small">Notas:</div>
          <div class="muted small" style="margin-top:4px; white-space:pre-wrap;">${notes || "‚Äî"}</div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn btn-primary" data-approve="${row}">Aprobar ‚úÖ</button>
          <button class="btn btn-danger" data-reject="${row}">Rechazar ‚ùå</button>
        </div>
      </div>
    `;
  }).join("");

  // bind botones (delegaci√≥n)
  adminDevicesList.querySelectorAll("[data-approve]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const row = Number(btn.getAttribute("data-approve"));
      await adminSetDeviceRow(row, true);
    });
  });

  adminDevicesList.querySelectorAll("[data-reject]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const row = Number(btn.getAttribute("data-reject"));
      await adminSetDeviceRow(row, false);
    });
  });
}

async function adminLoadDeviceRequests() {
  const reqs = await gsAdminListDeviceRequests();
  renderAdminDeviceRequests(reqs);
}

async function adminSetDeviceRow(row, approve) {
  try {
    setLoading(true, approve ? "Aprobando‚Ä¶" : "Rechazando‚Ä¶", "Actualizando hoja DISPOSITIVOS.");
    await gsAdminSetDeviceAuth(row, approve);
    await adminLoadDeviceRequests();
    setStatus("", "Listo", approve ? "Dispositivo aprobado ‚úÖ" : "Dispositivo rechazado ‚ùå");
  } catch (e) {
    setStatus("bad", "Error", String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}


if (!btnRequestAuth) {
  console.warn("btnRequestAuth NO encontrado en el HTML");
} else {
  btnRequestAuth.addEventListener("click", async () => {
    const name = (loginNameEl.value || "").trim();
    const email = (loginEmailEl.value || "").trim().toLowerCase();
    const course = (loginCourseEl.value || "").trim();

    if (!name || !email || !course) {
      loginHint.textContent = "Primero completa Nombre, Correo y Curso, luego solicita autorizaci√≥n.";
      return;
    }
    if (!/^\S+@\S+\.\S+$/.test(email)) {
      loginHint.textContent = "Correo inv√°lido.";
      return;
    }

    try {
      setLoading(true, "Enviando solicitud‚Ä¶", "Registrando este tel√©fono para aprobaci√≥n.");
      loginHint.textContent = "Enviando solicitud‚Ä¶";

      const resp = await gsRequestDeviceAuth({
        action: "request_device_auth",
        name,
        email,
        course,
        device_id: getDeviceId()
      });

      // ‚úÖ Mensaje claro con respuesta del servidor
      loginHint.textContent = resp.msg || "Solicitud enviada ‚úÖ. Espera aprobaci√≥n del administrador.";
    } catch (e) {
      // ‚úÖ Mostrar error real
      loginHint.textContent = String(e && e.message ? e.message : e);
    } finally {
      setLoading(false);
    }
  });
}


// ==============================
// DISCIPLINA (CELULAR EN CLASE) ‚Äî SOLO ‚ÄúREPORTADOS DEL MES‚Äù
// ==============================

let __discPollTimer = null;
let __discCurrentStudent = "";   // nombre seleccionado desde la lista
let __discCacheList = [];        // lista del mes actual (para render r√°pido)
  let __discView = "list"; // "list" | "detail"


function discMonthKey_() {
  return monthKeyFromDate(new Date()); // YYYY-MM
}

function normalizeStudent_(s){
  return String(s || "").trim().replace(/\s+/g, " ");
}

function discSetHint_(msg) {
  if (!discHint) return;
  discHint.textContent = msg || "";
  discHint.className = "modal-hint muted small";
}

// ‚úÖ colores del puntico seg√∫n nivel
// ‚úÖ DOT Disciplina: oculto si NO hay reportes
function discSetDotByLevel_(level) {
  if (!discLevelDot) return;

  const lv = Number(level || 0);

  if (lv <= 0) {
    discLevelDot.style.visibility = "hidden"; // üëà no se ve si no hay reportes
    discLevelDot.className = "dot";
    return;
  }

  discLevelDot.style.visibility = "visible";
  // 1 = verde (dot), 2-3 = warn, 4 = bad
  discLevelDot.className = "dot" + (lv >= 4 ? " bad" : (lv >= 2 ? " warn" : ""));
}

// ‚úÖ pinta el recuadro ‚ÄúSeleccionado‚Äù
function discUpdateSelectedBox_(studentName){
  const s = normalizeStudent_(studentName);
  __discCurrentStudent = s;

  // ‚úÖ mantener input sincronizado
  if (discStudentEl) discStudentEl.value = s || "";

  if (!discSelectedNameEl || !discSelectedMetaEl) return;

  if (!s) {
    discSelectedNameEl.textContent = "(Selecciona o escribe un estudiante)";
    discSelectedMetaEl.textContent = "‚Äî";
    discSetDotByLevel_(0);
    discClearLevelUI_();
    if (discWhoList) discWhoList.textContent = "‚Äî";
    return;
  }

  const item = discFindInCache_(s);
  const maxLevel = item ? Number(item.maxLevel || 0) : 0;
  const total = item ? Number(item.totalMarks || 0) : 0;
  const teachersCount = item ? Number(item.teachersCount || 0) : 0;

  discSelectedNameEl.textContent = s;

  if (item) {
    discSelectedMetaEl.textContent = `Nivel ${maxLevel} ‚Ä¢ Llamados: ${total} ‚Ä¢ Docentes: ${teachersCount}`;
  } else {
    discSelectedMetaEl.textContent = `Nuevo (sin reportes este mes a√∫n)`;
  }

  discSetDotByLevel_(maxLevel);
  discApplyLevelUI_(maxLevel);

  if (item && Array.isArray(item.who) && item.who.length) {
    discRenderWho_(item.who);
  } else {
    if (discWhoList) discWhoList.textContent = "‚Äî";
  }
}


function discFindInCache_(studentName) {
  const key = normalizeKey(studentName);
  return (__discCacheList || []).find(x => normalizeKey(x.student) === key) || null;
}

function discClearLevelUI_() {
  document.querySelectorAll(".disc-level").forEach(b => b.classList.remove("active"));
}

function discApplyLevelUI_(level) {
  discClearLevelUI_();
  const lv = Number(level || 0);
  for (let i=1;i<=lv;i++){
    const btn = document.querySelector(`.disc-level[data-level="${i}"]`);
    if (btn) btn.classList.add("active");
  }
}

function discRenderWho_(whoArr) {
  if (!discWhoList) return;
  const list = Array.isArray(whoArr) ? whoArr : [];
  if (!list.length) {
    discWhoList.textContent = "‚Äî";
    return;
  }

  // ‚úÖ Muestra: Docente + nivel que puso
discWhoList.innerHTML = list.map(x => {
  const name = escapeHtml(x.teacher || "");
  const lvl  = escapeHtml(String(x.level || ""));
  const date = formatDateShort_(x.date);
  return `
    <span class="disc-pill">
      ${name} ‚Ä¢ Nivel ${lvl}${date ? ` ‚Ä¢ ${date}` : ""}
    </span>
  `;
}).join("");

}

// ‚úÖ LISTA ‚ÄúReportados del mes‚Äù = solo nombres ordenados, click selecciona
function discRenderReportedList_(items) {
  if (!discReportedList) return;

  const list = Array.isArray(items) ? items : [];

  if (!list.length) {
    discReportedList.innerHTML = `<div class="muted small">No hay reportes este mes.</div>`;
    return;
  }

// ‚úÖ ordenar por m√°s reciente (arriba) ‚Üí m√°s antiguo (abajo)
const sorted = [...list].sort((a, b) => {
  const ta = Date.parse(a.lastIso || a.updated_at || a.updatedAt || a.ts || a.lastAt || "");
  const tb = Date.parse(b.lastIso || b.updated_at || b.updatedAt || b.ts || b.lastAt || "");

  // si ambos tienen fecha v√°lida: m√°s reciente primero
  if (!isNaN(ta) && !isNaN(tb)) return tb - ta;

  // si solo uno tiene fecha v√°lida: el que tiene fecha va arriba
  if (!isNaN(ta) && isNaN(tb)) return -1;
  if (isNaN(ta) && !isNaN(tb)) return 1;

  // fallback: por nombre (estable)
  return String(a.student || "").localeCompare(String(b.student || ""), "es", { sensitivity: "base" });
});


  // icono trash (SVG)
  const trashSvg = `
    <svg viewBox="0 0 448 512" aria-hidden="true" focusable="false">
      <path d="M135.2 17.7C140.6 7.1 151.5 0 163.8 0H284.2c12.3 0 23.2 7.1 28.6 17.7L320 32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32h-16l-21.2 339.2C377.2 480.8 348.5 512 312.6 512H135.4c-35.9 0-64.6-31.2-66.2-76.8L48 96H32C14.3 96 0 81.7 0 64s14.3-32 32-32h96l7.2-14.3zM192 64l-3.2 6.4h70.4L256 64h-64zM112 96l19.2 336.5c.2 4.2 2.2 7.5 4.2 7.5h177.2c2 0 4-3.3 4.2-7.5L336 96H112zm64 64c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16zm96 0c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16z"></path>
    </svg>
  `;

  const selectedKey = normalizeKey(__discCurrentStudent || "");

  // ‚úÖ OJO: ahora el contenedor NO es button, es div clickable
  discReportedList.innerHTML = sorted
    .map((it) => {
      const student = String(it.student || "").trim();
      if (!student) return "";

      const maxLevel = Number(it.maxLevel || 0);
      const dotCls = maxLevel ? `lvl-dot lvl-${maxLevel}` : "lvl-dot";

      const isSelected = selectedKey && normalizeKey(student) === selectedKey;
      const selectedCls = isSelected ? " selected" : "";

      return `
        <div class="disc-item${selectedCls}"
             role="button"
             tabindex="0"
             data-student="${escapeHtml(student)}">

          <div class="left">
            <span class="${dotCls}"></span>
            <span class="name">${escapeHtml(student)}</span>
          </div>

          <div class="right" style="gap:10px;">
            <button type="button"
                    class="disc-trash"
                    title="Eliminar estudiante"
                    aria-label="Eliminar estudiante"
                    data-del="${escapeHtml(student)}">
              ${trashSvg}
            </button>
            <span class="muted small" aria-hidden="true">‚Ä∫</span>
          </div>
        </div>
      `;
    })
    .join("");

  // ‚úÖ Abrir detalle (click + enter/space)
  discReportedList.querySelectorAll(".disc-item[data-student]").forEach((row) => {
    const open = () => {
      const s = row.getAttribute("data-student") || "";
      discOpenDetail_(s);
    };

    row.addEventListener("click", (e) => {
      // si el click viene del trash, no abrir
      if (e.target && e.target.closest && e.target.closest("[data-del]")) return;
      open();
    });

    row.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        open();
      }
    });
  });

  // ‚úÖ Trash: borrar SIN abrir detalle
  discReportedList.querySelectorAll("[data-del]").forEach((delBtn) => {
    delBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      const student = delBtn.getAttribute("data-del") || "";
      await discDeleteStudent_(student);
    });
  });
}



function discOpenDetail_(studentName){
  __discView = "detail";

  // fija seleccionado + refresca box (nivel/who/meta)
  discUpdateSelectedBox_(studentName);

  // pinta vista detalle en el contenedor
  discRenderDetailView_();

  // ‚úÖ mostrar bot√≥n Atr√°s (abajo)
  if (typeof btnDiscBack !== "undefined" && btnDiscBack) btnDiscBack.hidden = false;
}

function discBackToList_(){
  __discView = "list";

  // vuelve a pintar la lista del mes (cache)
  discRenderReportedList_(__discCacheList);

  discSetHint_("");

  // ‚úÖ ocultar bot√≥n Atr√°s (abajo)
  if (typeof btnDiscBack !== "undefined" && btnDiscBack) btnDiscBack.hidden = true;
}


  function discRenderDetailView_(){
  if (!discReportedList) return;

  const s = normalizeStudent_(__discCurrentStudent);
  const item = s ? discFindInCache_(s) : null;

  const maxLevel = item ? Number(item.maxLevel || 0) : 0;
  const total = item ? Number(item.totalMarks || 0) : 0;
  const teachersCount = item ? Number(item.teachersCount || 0) : 0;

 discReportedList.innerHTML = `
  <div class="record-card" style="margin-bottom:10px;">
    <div class="top">
      <span class="teacher">${escapeHtml(s || "‚Äî")}</span>
      <span class="badge badge-neutral">${maxLevel ? `Nivel ${maxLevel}` : "Sin nivel"}</span>
    </div>
    <div class="meta">
      Llamados: <b>${total}</b> ‚Ä¢ Docentes: <b>${teachersCount}</b>
    </div>
  </div>

  <div class="muted small" style="margin-bottom:6px;">(Usa los botones de nivel arriba para registrar)</div>
`;




  // ‚úÖ repinta UI de niveles y ‚Äúwho‚Äù usando lo que ya tienes
  discApplyLevelUI_(maxLevel);
  if (item && Array.isArray(item.who) && item.who.length) discRenderWho_(item.who);
  else if (discWhoList) discWhoList.textContent = "‚Äî";
}


/* ======= Google Sheets API (acciones) ======= */
async function gsDisciplineMark(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "discipline_mark", ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "discipline_mark_failed");
  return data;
}

async function gsDisciplineDeleteStudent(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "discipline_delete_student", ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "discipline_delete_failed");
  return data;
}


async function gsDisciplineList(month) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "discipline_list", month, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "discipline_list_failed");
  return data.items || [];
}

/************ CURSOS + ESTUDIANTES (AUTOCOMPLETE) ************/
/************ CACHE CURSOS/ESTUDIANTES ************/
const LS_COURSES_CACHE = "courses_cache_v1";
const LS_STUDENTS_CACHE_PREFIX = "course_students_cache_v1:"; // + course
const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6 horas (aj√∫stalo)

function cacheSet_(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify({ t: Date.now(), v: value }));
  } catch {}
}

function cacheGet_(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.t) return null;
    if ((Date.now() - obj.t) > CACHE_TTL_MS) return null;
    return obj.v;
  } catch {
    return null;
  }
}

async function gsCoursesListCached() {
  const cached = cacheGet_(LS_COURSES_CACHE);
  if (Array.isArray(cached) && cached.length) return cached;

  const fresh = await gsCoursesList();
  if (Array.isArray(fresh)) cacheSet_(LS_COURSES_CACHE, fresh);
  return fresh;
}

async function gsCourseStudentsCached(course) {
  const c = String(course || "").trim();
  if (!c) return [];

  const key = LS_STUDENTS_CACHE_PREFIX + c;
  const cached = cacheGet_(key);
  if (Array.isArray(cached) && cached.length) return cached;

  const fresh = await gsCourseStudents(c);
  if (Array.isArray(fresh)) cacheSet_(key, fresh);
  return fresh;
}

// ‚úÖ Precarga cursos + estudiantes del curso por defecto
async function prewarmCoursesAndStudents_() {
  try {
    console.log("üî• Preload: cursos/estudiantes‚Ä¶");

    const courses = await gsCoursesListCached();
    console.log("‚úÖ Preload cursos:", (courses || []).length);

    // Curso por defecto: el del perfil o el del login
    const profile = (typeof loadProfile === "function") ? loadProfile() : null;
    const defaultCourse =
      (profile && profile.course) ? String(profile.course).trim() :
      (typeof loginCourseEl !== "undefined" && loginCourseEl && loginCourseEl.value) ? loginCourseEl.value.trim() :
      "";

    if (defaultCourse) {
      const st = await gsCourseStudentsCached(defaultCourse);
      console.log("‚úÖ Preload estudiantes de", defaultCourse, ":", (st || []).length);
    }

  } catch (e) {
    console.warn("‚ö†Ô∏è Preload fall√≥ (se seguir√° cargando normal):", e);
  }
}



async function gsCoursesList() {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "courses_list", key: GS_API_KEY })
  });
  let data = null;
  try { data = await res.json(); } catch { throw new Error("Respuesta inv√°lida del servidor"); }
  if (!data.ok) throw new Error(data.msg || data.error || "courses_list_failed");
  return data.courses || [];
}

async function gsCourseStudents(course) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "course_students", course, key: GS_API_KEY })
  });
  let data = null;
  try { data = await res.json(); } catch { throw new Error("Respuesta inv√°lida del servidor"); }
  if (!data.ok) throw new Error(data.msg || data.error || "course_students_failed");
  return data.students || [];
}

function fillSelect_(selectEl, items, placeholderText) {
  if (!selectEl) return;
  const prev = selectEl.value;

  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholderText || "Selecciona‚Ä¶";
  selectEl.appendChild(opt0);

  (items || []).forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    selectEl.appendChild(opt);
  });

  // intenta restaurar selecci√≥n anterior si existe
  if (prev && items && items.includes(prev)) selectEl.value = prev;
}

function fillDatalist_(datalistEl, names) {
  if (!datalistEl) return;
  datalistEl.innerHTML = "";
  (names || []).forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    datalistEl.appendChild(opt);
  });
}

function fillStudentsUI_(students, datalistEl, selectEl, inputEl) {
  const arr = Array.isArray(students) ? students : [];

  // 1) datalist (por si el navegador s√≠ lo soporta)
  if (datalistEl) {
    datalistEl.innerHTML = "";
    arr.forEach(name => {
      const opt = document.createElement("option");
      opt.value = String(name || "");
      datalistEl.appendChild(opt);
    });
  }

  // 2) select REAL (combo)
  if (selectEl) {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = arr.length ? "‚Äî Selecciona ‚Äî" : "‚Äî Sin estudiantes ‚Äî";
    selectEl.appendChild(opt0);

    arr.forEach(name => {
      const opt = document.createElement("option");
      opt.value = String(name || "");
      opt.textContent = String(name || "");
      selectEl.appendChild(opt);
    });
  }

  // 3) Si hay input, lo limpiamos para evitar confusi√≥n
  if (inputEl) inputEl.value = "";
}


// ‚úÖ Vincula el <select> de estudiantes con el <input> (para que tu l√≥gica existente use el input)
// ‚úÖ select -> input + UI update inmediato (sin esperar debounce)
function bindStudentSelectToInput_(studentSelectEl, studentInputEl, onPick) {
  if (!studentSelectEl || !studentInputEl) return;

  if (studentSelectEl.dataset.boundToInput === "1") return;
  studentSelectEl.dataset.boundToInput = "1";

  const applyNow = () => {
    const v = String(studentSelectEl.value || "").trim();
    if (!v) return;

    // 1) actualiza input ya
    if (studentInputEl.value !== v) studentInputEl.value = v;

    // 2) fuerza eventos (para tu l√≥gica existente)
    studentInputEl.dispatchEvent(new Event("input", { bubbles: true }));
    studentInputEl.dispatchEvent(new Event("change", { bubbles: true }));

    // 3) callback inmediato (actualiza ‚ÄúSeleccionado‚Äù y niveles)
    if (typeof onPick === "function") onPick(v);

    // 4) truco: fuerza un frame de render para que el DOM pinte YA (Android)
    requestAnimationFrame(() => {});
  };

  // change al seleccionar
  studentSelectEl.addEventListener("change", applyNow);

  // algunos navegadores disparan click/touch sin change inmediato
  studentSelectEl.addEventListener("click", applyNow);
  studentSelectEl.addEventListener("touchend", applyNow, { passive: true });
}


// ‚úÖ Mete el select "lista de estudiantes" dentro del input (overlay a la derecha)
function mountStudentSelectIntoInput_(studentInputEl, studentSelectEl) {
  if (!studentInputEl || !studentSelectEl) return;

  // evitar duplicar
  if (studentInputEl.dataset.selectOverlayMounted === "1") return;
  studentInputEl.dataset.selectOverlayMounted = "1";

  // crear wrapper
  const wrap = document.createElement("div");
  wrap.className = "input-with-select";

  // inserta wrapper donde estaba el input
  const parent = studentInputEl.parentElement;
  parent.insertBefore(wrap, studentInputEl);

  // mover input dentro
  wrap.appendChild(studentInputEl);

  // marcar input para que tome padding
  studentInputEl.classList.add("input-real");

  // mover select dentro y convertirlo en overlay
  studentSelectEl.classList.add("student-overlay");
  wrap.appendChild(studentSelectEl);
}



// ‚úÖ Inicializa el combo de cursos y, al cambiar, carga estudiantes en datalist + select
function initCourseComboForModal({
  courseSelectEl,
  studentInputEl,
  studentsDatalistEl,
  studentSelectEl
}) {
  if (!courseSelectEl) return;

  // evitar doble bind
  if (courseSelectEl.dataset.courseStudentsInit === "1") return;
  courseSelectEl.dataset.courseStudentsInit = "1";

  let loading = false;

  const clearStudentsUI = () => {
    fillStudentsUI_([], studentsDatalistEl, studentSelectEl, studentInputEl);
    if (studentInputEl) studentInputEl.value = "";
    if (studentSelectEl) studentSelectEl.value = "";
  };

  const loadCourses = async () => {
    if (loading) return;
    loading = true;
    try {
      const courses = await gsCoursesListCached();
      fillSelect_(courseSelectEl, courses, "‚Äî Selecciona curso ‚Äî");
    } catch (e) {
      console.warn("‚ùå No se pudieron cargar cursos:", e);
      fillSelect_(courseSelectEl, [], "‚Äî Sin cursos ‚Äî");
    } finally {
      loading = false;
    }
  };

  const loadStudentsForCourse = async (course) => {
    const c = String(course || "").trim();
    if (!c) {
      clearStudentsUI();
      return;
    }

    // UI r√°pida mientras carga
    fillStudentsUI_([], studentsDatalistEl, studentSelectEl, studentInputEl);

    try {
      console.log("üìö Cargando estudiantes del curso:", c);
      const students = await gsCourseStudents(c);
      fillStudentsUI_(students, studentsDatalistEl, studentSelectEl, studentInputEl);
      console.log("‚úÖ Estudiantes cargados:", (students || []).length);
    } catch (e) {
      console.warn("‚ùå No se pudieron cargar estudiantes del curso:", c, e);
      clearStudentsUI();
    }
  };

  // 1) cargar cursos una vez
  loadCourses();

  // 2) cuando cambia el curso => cargar estudiantes
  courseSelectEl.addEventListener("change", () => {
    const course = String(courseSelectEl.value || "").trim();
    // limpia selecci√≥n previa antes de cargar
    if (studentInputEl) studentInputEl.value = "";
    if (studentSelectEl) studentSelectEl.value = "";
    loadStudentsForCourse(course);
  });

  // 3) si ya ven√≠a un curso seleccionado (por restore), cargar estudiantes
  if (String(courseSelectEl.value || "").trim()) {
    loadStudentsForCourse(courseSelectEl.value);
  }
}



/*function bindStudentSelectToInput_(selectEl, inputEl, onInputCb) {
  if (!selectEl || !inputEl) return;

  selectEl.addEventListener("change", () => {
    inputEl.value = selectEl.value || "";
    // dispara tu misma l√≥gica existente
    if (typeof onInputCb === "function") onInputCb();
    // por si tienes listeners "input" ya puestos:
    inputEl.dispatchEvent(new Event("input", { bubbles: true }));
  });
}
*/
  
// Inicializa un modal (select curso -> carga estudiantes -> datalist)
// Inicializa un modal (select curso -> carga estudiantes -> datalist)
// ‚úÖ Ahora es "re-ejecutable" sin duplicar event listeners
// ‚úÖ Curso -> carga estudiantes en DATAlist + SELECT (sin romper nada)
async function initCourseComboForModal({
  selectEl,         // <select> de cursos
  datalistEl,       // <datalist> (opcional)
  studentInputEl,   // <input> donde escribes estudiante (opcional)
  studentSelectEl,  // <select> lista estudiantes (opcional)
  defaultCourse
}) {
  if (!selectEl) return;

  try {
    console.log("üìö Cargando cursos para:", selectEl.id);

    const courses = await gsCoursesList();
    fillSelect_(selectEl, courses, "Selecciona el curso‚Ä¶");

    // default: usa el curso guardado en login (si existe)
    const preferred = String(defaultCourse || "").trim();
    if (preferred && courses.includes(preferred)) {
      selectEl.value = preferred;
    }

    async function loadStudentsForSelectedCourse() {
      const course = String(selectEl.value || "").trim();

      // limpia UI si no hay curso
      if (!course) {
        if (datalistEl) fillDatalist_(datalistEl, []);
        if (studentSelectEl) fillStudentsUI_([], datalistEl, studentSelectEl, null);
        return;
      }

      console.log("üë• Cargando estudiantes del curso:", course, "para:", selectEl.id);

      const students = await gsCourseStudentsCached(course);

      // ‚úÖ llena datalist + select de estudiantes
      if (studentSelectEl) {
        fillStudentsUI_(students, datalistEl, studentSelectEl, null);
      } else if (datalistEl) {
        fillDatalist_(datalistEl, students);
      }

      // NO borro el input para no romper tu flujo (pero si quieres limpiar, me dices)
    }

    // ‚úÖ evita duplicar listeners si se llama de nuevo
    if (selectEl.__courseChangeHandler) {
      selectEl.removeEventListener("change", selectEl.__courseChangeHandler);
    }
    selectEl.__courseChangeHandler = loadStudentsForSelectedCourse;
    selectEl.addEventListener("change", selectEl.__courseChangeHandler);

    // carga inicial
    await loadStudentsForSelectedCourse();

    console.log("‚úÖ Cursos cargados:", courses.length, "en:", selectEl.id);

  } catch (e) {
    console.warn("‚ö†Ô∏è No se pudo cargar cursos/estudiantes:", e);
    // deja vac√≠o sin romper
    try { fillSelect_(selectEl, [], "‚Äî Sin cursos ‚Äî"); } catch {}
    try { if (datalistEl) fillDatalist_(datalistEl, []); } catch {}
    try { if (studentSelectEl) fillStudentsUI_([], datalistEl, studentSelectEl, null); } catch {}
  }
}



  
/* ======= UI actions ======= */
async function discReloadReportedList(showHint=false) {
  try {
    const month = discMonthKey_();
    const items = await gsDisciplineList(month);

    __discCacheList = items;

    // ‚úÖ SI hay seleccionado y NO est√°s escribiendo, refresca el box SIEMPRE
    // (esto arregla: punto de arriba + cards 1..4 + who)
    const isTyping = (discStudentEl && document.activeElement === discStudentEl);
    if (__discCurrentStudent && !isTyping) {
      discUpdateSelectedBox_(__discCurrentStudent);
    }

    // ‚úÖ si estoy en detalle, refresco detalle
    if (__discView === "detail" && __discCurrentStudent) {
      discRenderDetailView_();
    } else {
      // ‚úÖ en lista, repinta lista (para que cambie el punto/orden)
      discRenderReportedList_(items);
    }

    if (showHint) discSetHint_("Lista sincronizada ‚úÖ");
  } catch (e) {
    if (showHint) discSetHint_(String(e && e.message ? e.message : e));
  }
}


async function discDeleteStudent_(studentName){
  const profile = requireLogin();
  if (!profile) return;

  const student = normalizeStudent_(studentName);
  if (!student) return;

  const ok = confirm(`¬øSeguro que deseas eliminar a "${student}"?\n\nSe borrar√°n TODOS sus reportes del mes actual.`);
  if (!ok) return;

  try {
    setLoading(true, "Eliminando‚Ä¶", "Borrando reportes del estudiante.");

    const resp = await gsDisciplineDeleteStudent({
      month: discMonthKey_(),
      student,
      teacher: profile.name,
      email: profile.email,
      device_id: getDeviceId()
    });

    // resp debe devolver lista actualizada
    if (resp && Array.isArray(resp.list)) {
      __discCacheList = resp.list;
    } else {
      await discReloadReportedList(false);
    }

    // si borraste el que estaba seleccionado, limpia vista
    if (__discCurrentStudent && normalizeKey(__discCurrentStudent) === normalizeKey(student)) {
      __discCurrentStudent = "";
      discUpdateSelectedBox_("");
      discBackToList_(); // vuelve a lista
    } else {
      // si est√°s en lista, repinta lista
      if (__discView !== "detail") discRenderReportedList_(__discCacheList);
    }

    discSetHint_("Estudiante eliminado ‚úÖ");

  } catch (e) {
    discSetHint_(String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}



async function shareTextNative_(text) {
  try {
    if (navigator.share) {
      await navigator.share({ text: String(text || "") });
      return true;
    }
  } catch (e) {
    // si el usuario cancela, no pasa nada
  }
  return false;
}

const WHATSAPP_GROUP_LINK = "https://chat.whatsapp.com/EztQUrHgqC6L7di7rvaNwu?mode=gi_t";

async function discDoMarkLevel(level) {
  const profile = requireLogin();
  if (!profile) return;

  const lvl = Number(level || 0);
  if (lvl < 1 || lvl > 4) return;

  const student = normalizeStudent_(__discCurrentStudent);
  if (!student) {
    discSetHint_("Primero selecciona un estudiante de la lista.");
    return;
  }

  const item = discFindInCache_(student);
  const currentMax = item ? Number(item.maxLevel || 0) : 0;

  if (lvl > currentMax + 1) {
    discSetHint_(`Debes marcar primero el nivel ${currentMax + 1}.`);
    discApplyLevelUI_(currentMax);
    return;
  }

  try {
    setLoading(true, "Guardando‚Ä¶", "Registrando llamado de atenci√≥n.");

  const resp = await gsDisciplineMark({
  month: discMonthKey_(),
  student,
  level: lvl,
  teacher: profile.name,
  email: profile.email,
  device_id: getDeviceId(),
  date: new Date().toISOString()
});


    if (resp && Array.isArray(resp.list)) {
      __discCacheList = resp.list;
    } else {
      await discReloadReportedList(false);
    }

  // ‚úÖ actualizar seleccionado (arriba) + volver a lista actualizada
discUpdateSelectedBox_(student);

__discView = "list";
discRenderReportedList_(__discCacheList);

// ocultar Atr√°s porque estamos en lista
if (btnDiscBack) btnDiscBack.hidden = true;


    let openedWa = false;

    // ‚úÖ Solo cuando es reporte por primera vez (nivel 4)
   if (resp && resp.ok && resp.justReported && lvl >= 4) {
  const waUrl = String(resp.wa_url || "").trim();

  if (waUrl) {
    window.open(waUrl, "_blank"); // abre chat de la coordinadora con el mensaje listo
    openedWa = true;
  } else {
    alert("‚ö†Ô∏è No lleg√≥ el link de WhatsApp desde el servidor (wa_url).");
  }
}


    if (lvl >= 4) {
      discSetHint_(openedWa ? "Nivel 4 registrado. Grupo abierto ‚úÖ" : "Nivel 4 registrado ‚úÖ");
    } else {
      discSetHint_("Registrado ‚úÖ");
    }

  } catch (e) {
    discSetHint_(String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}






/* ======= Poll para sincronizar entre celulares ======= */
function discStartPolling_() {
  if (__discPollTimer) return;

  __discPollTimer = setInterval(async () => {
    const p = loadProfile();
    const admin = isAdminMode();
    if (!p && !admin) return;

    // ‚úÖ si el modal no est√° abierto, solo actualiza cache y ya
    if (!disciplineModal || disciplineModal.hidden === true) {
      try {
        __discCacheList = await gsDisciplineList(discMonthKey_());
      } catch {}
      return;
    }

    try {
      const items = await gsDisciplineList(discMonthKey_());
      __discCacheList = items;

      // ‚úÖ Si el usuario est√° escribiendo en el input, NO pisar su texto
      const isTyping = (discStudentEl && document.activeElement === discStudentEl);

      // ‚úÖ SI hay estudiante seleccionado (aunque est√©s en LISTA),
      // refresca ‚ÄúSeleccionado‚Äù (punto arriba + niveles + who)
      if (__discCurrentStudent && !isTyping) {
        discUpdateSelectedBox_(__discCurrentStudent);
      }

      // ‚úÖ Si estoy en detalle: refresco la tarjeta detalle
      if (__discView === "detail") {
        if (__discCurrentStudent) discRenderDetailView_();
        return;
      }

      // ‚úÖ En lista: repintar lista (para que cambie el punto/orden)
      discRenderReportedList_(items);

    } catch {
      // silencioso
    }
  }, 15000);
}





function openDisciplineModal() {
  if (!disciplineModal) return;

  disciplineModal.hidden = false;
  discSetHint_("");

  __discView = "list";               // ‚úÖ siempre abre en lista
  __discCurrentStudent = "";         // ‚úÖ no debe quedar ‚Äúpegado‚Äù el √∫ltimo
  discUpdateSelectedBox_("");        // limpia box seleccionado
  discRenderReportedList_(__discCacheList);

  // ‚úÖ ocultar bot√≥n Atr√°s al abrir
  if (typeof btnDiscBack !== "undefined" && btnDiscBack) btnDiscBack.hidden = true;

  // si quieres que muestre el ‚ÄúLista sincronizada ‚úÖ‚Äù al abrir:
  discReloadReportedList(true);
}

function closeDisciplineModal() {
  if (!disciplineModal) return;

  disciplineModal.hidden = true;

  __discView = "list";
  __discCurrentStudent = "";
  discSetHint_("");
  discUpdateSelectedBox_("");

  // ‚úÖ ocultar bot√≥n Atr√°s al cerrar
  if (typeof btnDiscBack !== "undefined" && btnDiscBack) btnDiscBack.hidden = true;
}
function discBindUI_() {
  // ‚úÖ Mantener men√∫/submen√∫ abiertos al abrir el modal
  if (btnDiscipline) {
    btnDiscipline.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      openDisciplineModal();
    });
  }

  // ‚úÖ Evitar que cualquier click dentro del modal cierre el men√∫ global
  if (disciplineModal) {
    disciplineModal.addEventListener("click", (e) => e.stopPropagation());
  }

  if (btnDiscClose) {
    btnDiscClose.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeDisciplineModal();
    });
  }

  if (btnDiscReload) {
    btnDiscReload.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      discReloadReportedList(true);
    });
  }

  if (btnDiscBack) {
    btnDiscBack.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      discBackToList_();
    });
  }

  // botones 1..4 (tambi√©n evitamos bubbling)
  if (disciplineModal) {
    disciplineModal.querySelectorAll(".disc-level").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const lvl = Number(btn.getAttribute("data-level") || 0);
        discDoMarkLevel(lvl);
      });
    });
  }

  // input: no hace falta stopPropagation aqu√≠, pero no estorba
  if (discStudentEl) {
    discStudentEl.addEventListener("input", () => {
      const raw = String(discStudentEl.value || "");
      __discCurrentStudent = raw;

      const s = normalizeStudent_(raw);
      // ... (TU C√ìDIGO EXISTENTE sigue igual desde aqu√≠)
    });
  }
}



// ==============================
// PIERCING Y PERFORACIONES ‚Äî ‚ÄúREPORTADOS DEL MES‚Äù
// ==============================

let __piercPollTimer = null;
let __piercCurrentStudent = "";
let __piercCacheList = [];
let __piercView = "list"; // "list" | "detail"

function piercMonthKey_() {
  return monthKeyFromDate(new Date()); // YYYY-MM
}

function piercNormalizeStudent_(s){
  return String(s || "").trim().replace(/\s+/g, " ");
}

function piercSetHint_(msg) {
  if (!piercHint) return;
  piercHint.textContent = msg || "";
  piercHint.className = "modal-hint muted small";
}

// ‚úÖ DOT Piercing: oculto si NO hay reportes
function piercSetDotByLevel_(level) {
  if (!piercLevelDot) return;

  const lv = Number(level || 0);

  if (lv <= 0) {
    piercLevelDot.style.visibility = "hidden";
    piercLevelDot.className = "dot";
    return;
  }

  piercLevelDot.style.visibility = "visible";
  piercLevelDot.className = "dot" + (lv >= 4 ? " bad" : (lv >= 2 ? " warn" : ""));
}

function piercFindInCache_(studentName) {
  const key = normalizeKey(studentName);
  return (__piercCacheList || []).find(x => normalizeKey(x.student) === key) || null;
}

function piercClearLevelUI_() {
  if (!piercingModal) return;
  piercingModal.querySelectorAll(".disc-level").forEach(b => b.classList.remove("active"));
}

function piercApplyLevelUI_(level) {
  piercClearLevelUI_();
  const lv = Number(level || 0);
  for (let i=1;i<=lv;i++){
    const btn = piercingModal.querySelector(`.disc-level[data-level="${i}"]`);
    if (btn) btn.classList.add("active");
  }
}

function piercRenderWho_(whoArr) {
  if (!piercWhoList) return;
  const list = Array.isArray(whoArr) ? whoArr : [];
  if (!list.length) { piercWhoList.textContent = "‚Äî"; return; }

 piercWhoList.innerHTML = list.map(x => {
  const name = escapeHtml(x.teacher || "");
  const lvl  = escapeHtml(String(x.level || ""));
  const date = formatDateShort_(x.date);
  return `
    <span class="disc-pill">
      ${name} ‚Ä¢ Nivel ${lvl}${date ? ` ‚Ä¢ ${date}` : ""}
    </span>
  `;
}).join("");

}

function piercUpdateSelectedBox_(studentName){
  const s = piercNormalizeStudent_(studentName);
  __piercCurrentStudent = s;

  if (piercStudentEl) piercStudentEl.value = s || "";

  if (!piercSelectedNameEl || !piercSelectedMetaEl) return;

  if (!s) {
    piercSelectedNameEl.textContent = "(Selecciona o escribe un estudiante)";
    piercSelectedMetaEl.textContent = "‚Äî";
    piercSetDotByLevel_(0);
    piercClearLevelUI_();
    if (piercWhoList) piercWhoList.textContent = "‚Äî";
    return;
  }

  const item = piercFindInCache_(s);
  const maxLevel = item ? Number(item.maxLevel || 0) : 0;
  const total = item ? Number(item.totalMarks || 0) : 0;
  const teachersCount = item ? Number(item.teachersCount || 0) : 0;

  piercSelectedNameEl.textContent = s;

  piercSelectedMetaEl.textContent = item
    ? `Nivel ${maxLevel} ‚Ä¢ Llamados: ${total} ‚Ä¢ Docentes: ${teachersCount}`
    : `Nuevo (sin reportes este mes a√∫n)`;

  piercSetDotByLevel_(maxLevel);
  piercApplyLevelUI_(maxLevel);

  if (item && Array.isArray(item.who) && item.who.length) piercRenderWho_(item.who);
  else if (piercWhoList) piercWhoList.textContent = "‚Äî";
}

function piercRenderReportedList_(items) {
  if (!piercReportedList) return;
  const list = Array.isArray(items) ? items : [];

  if (!list.length) {
    piercReportedList.innerHTML = `<div class="muted small">No hay reportes este mes.</div>`;
    return;
  }

  const sorted = [...list].sort((a, b) => {
    const ta = Date.parse(a.updatedAt || "");
    const tb = Date.parse(b.updatedAt || "");
    if (!isNaN(ta) && !isNaN(tb)) return tb - ta;
    if (!isNaN(ta) && isNaN(tb)) return -1;
    if (isNaN(ta) && !isNaN(tb)) return 1;
    return String(a.student || "").localeCompare(String(b.student || ""), "es", { sensitivity: "base" });
  });

  const trashSvg = `
    <svg viewBox="0 0 448 512" aria-hidden="true" focusable="false">
      <path d="M135.2 17.7C140.6 7.1 151.5 0 163.8 0H284.2c12.3 0 23.2 7.1 28.6 17.7L320 32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32h-16l-21.2 339.2C377.2 480.8 348.5 512 312.6 512H135.4c-35.9 0-64.6-31.2-66.2-76.8L48 96H32C14.3 96 0 81.7 0 64s14.3-32 32-32h96l7.2-14.3zM192 64l-3.2 6.4h70.4L256 64h-64zM112 96l19.2 336.5c.2 4.2 2.2 7.5 4.2 7.5h177.2c2 0 4-3.3 4.2-7.5L336 96H112zm64 64c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16zm96 0c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16z"></path>
    </svg>
  `;

  const selectedKey = normalizeKey(__piercCurrentStudent || "");

  piercReportedList.innerHTML = sorted.map(it => {
    const student = String(it.student || "").trim();
    if (!student) return "";

    const maxLevel = Number(it.maxLevel || 0);
    const dotCls = maxLevel ? `lvl-dot lvl-${maxLevel}` : "lvl-dot";
    const isSelected = selectedKey && normalizeKey(student) === selectedKey;
    const selectedCls = isSelected ? " selected" : "";

    return `
      <div class="disc-item${selectedCls}" role="button" tabindex="0" data-student="${escapeHtml(student)}">
        <div class="left">
          <span class="${dotCls}"></span>
          <span class="name">${escapeHtml(student)}</span>
        </div>
        <div class="right" style="gap:10px;">
          <button type="button" class="disc-trash" title="Eliminar estudiante" aria-label="Eliminar estudiante" data-del="${escapeHtml(student)}">
            ${trashSvg}
          </button>
          <span class="muted small" aria-hidden="true">‚Ä∫</span>
        </div>
      </div>
    `;
  }).join("");

  piercReportedList.querySelectorAll(".disc-item[data-student]").forEach(row => {
    const open = () => {
      const s = row.getAttribute("data-student") || "";
      piercOpenDetail_(s);
    };

    row.addEventListener("click", (e) => {
      if (e.target && e.target.closest && e.target.closest("[data-del]")) return;
      open();
    });

    row.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        open();
      }
    });
  });

  piercReportedList.querySelectorAll("[data-del]").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      const student = btn.getAttribute("data-del") || "";
      await piercDeleteStudent_(student);
    });
  });
}

function piercRenderDetailView_(){
  if (!piercReportedList) return;
  const s = piercNormalizeStudent_(__piercCurrentStudent);
  const item = s ? piercFindInCache_(s) : null;

  const maxLevel = item ? Number(item.maxLevel || 0) : 0;
  const total = item ? Number(item.totalMarks || 0) : 0;
  const teachersCount = item ? Number(item.teachersCount || 0) : 0;

  piercReportedList.innerHTML = `
    <div class="record-card" style="margin-bottom:10px;">
      <div class="top">
        <span class="teacher">${escapeHtml(s || "‚Äî")}</span>
        <span class="badge badge-neutral">${maxLevel ? `Nivel ${maxLevel}` : "Sin nivel"}</span>
      </div>
      <div class="meta">
        Llamados: <b>${total}</b> ‚Ä¢ Docentes: <b>${teachersCount}</b>
      </div>
    </div>
    <div class="muted small" style="margin-bottom:6px;">(Usa los botones de nivel arriba para registrar)</div>
  `;

  piercApplyLevelUI_(maxLevel);
  if (item && Array.isArray(item.who) && item.who.length) piercRenderWho_(item.who);
  else if (piercWhoList) piercWhoList.textContent = "‚Äî";
}

function piercOpenDetail_(studentName){
  __piercView = "detail";
  piercUpdateSelectedBox_(studentName);
  piercRenderDetailView_();
  if (btnPiercBack) btnPiercBack.hidden = false;
}

function piercBackToList_(){
  __piercView = "list";
  piercRenderReportedList_(__piercCacheList);
  piercSetHint_("");
  if (btnPiercBack) btnPiercBack.hidden = true;
}

/* ======= Google Sheets API: Piercing ======= */
async function gsPiercingList(month) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "piercing_list", month, key: GS_API_KEY })
  });
  let data = null;
  try { data = await res.json(); } catch { throw new Error("Respuesta inv√°lida del servidor"); }
  if (!data.ok) throw new Error(data.msg || data.error || "piercing_list_failed");
  return data.items || [];
}

async function gsPiercingMark(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "piercing_mark", ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "piercing_mark_failed");
  return data;
}

async function gsPiercingDeleteStudent(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "piercing_delete_student", ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "piercing_delete_failed");
  return data;
}

/* ======= UI actions ======= */
async function piercReloadReportedList(showHint=false) {
  try {
    const month = piercMonthKey_();
    const items = await gsPiercingList(month);
    __piercCacheList = items;

    const isTyping = (piercStudentEl && document.activeElement === piercStudentEl);
    if (__piercCurrentStudent && !isTyping) piercUpdateSelectedBox_(__piercCurrentStudent);

    if (__piercView === "detail" && __piercCurrentStudent) piercRenderDetailView_();
    else piercRenderReportedList_(items);

    if (showHint) piercSetHint_("Lista sincronizada ‚úÖ");
  } catch (e) {
    if (showHint) piercSetHint_(String(e && e.message ? e.message : e));
  }
}

async function piercDeleteStudent_(studentName){
  const profile = requireLogin();
  if (!profile) return;

  const student = piercNormalizeStudent_(studentName);
  if (!student) return;

  const ok = confirm(`¬øSeguro que deseas eliminar a "${student}"?\n\nSe borrar√°n TODOS sus reportes del mes actual.`);
  if (!ok) return;

  try {
    setLoading(true, "Eliminando‚Ä¶", "Borrando reportes del estudiante.");
    const resp = await gsPiercingDeleteStudent({
      month: piercMonthKey_(),
      student,
      teacher: profile.name,
      email: profile.email,
      device_id: getDeviceId()
    });

    if (resp && Array.isArray(resp.list)) __piercCacheList = resp.list;
    else await piercReloadReportedList(false);

    if (__piercCurrentStudent && normalizeKey(__piercCurrentStudent) === normalizeKey(student)) {
      __piercCurrentStudent = "";
      piercUpdateSelectedBox_("");
      piercBackToList_();
    } else {
      if (__piercView !== "detail") piercRenderReportedList_(__piercCacheList);
    }

    piercSetHint_("Estudiante eliminado ‚úÖ");
  } catch (e) {
    piercSetHint_(String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}

async function piercDoMarkLevel(level) {
  const profile = requireLogin();
  if (!profile) return;

  const lvl = Number(level || 0);
  if (lvl < 1 || lvl > 4) return;

  const student = piercNormalizeStudent_(__piercCurrentStudent);
  if (!student) { piercSetHint_("Primero selecciona un estudiante de la lista."); return; }

  const item = piercFindInCache_(student);
  const currentMax = item ? Number(item.maxLevel || 0) : 0;

  if (lvl > currentMax + 1) {
    piercSetHint_(`Debes marcar primero el nivel ${currentMax + 1}.`);
    piercApplyLevelUI_(currentMax);
    return;
  }

  try {
    setLoading(true, "Guardando‚Ä¶", "Registrando reporte de piercing/perforaciones.");

  const resp = await gsPiercingMark({
  month: piercMonthKey_(),
  student,
  level: lvl,
  teacher: profile.name,
  email: profile.email,
  device_id: getDeviceId(),
  date: new Date().toISOString()
});


    if (resp && Array.isArray(resp.list)) __piercCacheList = resp.list;
    else await piercReloadReportedList(false);

    piercUpdateSelectedBox_(student);
    __piercView = "list";
    piercRenderReportedList_(__piercCacheList);
    if (btnPiercBack) btnPiercBack.hidden = true;

    if (resp && resp.ok && resp.justReported && lvl >= 4) {
      const waUrl = String(resp.wa_url || "").trim();
      if (waUrl) window.open(waUrl, "_blank");
    }

    piercSetHint_(lvl >= 4 ? "Nivel 4 registrado ‚úÖ" : "Registrado ‚úÖ");

  } catch (e) {
    piercSetHint_(String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}

/* ======= Poll ======= */
function piercStartPolling_() {
  if (__piercPollTimer) return;

  __piercPollTimer = setInterval(async () => {
    const p = loadProfile();
    const admin = isAdminMode();
    if (!p && !admin) return;

    if (!piercingModal || piercingModal.hidden === true) {
      try { __piercCacheList = await gsPiercingList(piercMonthKey_()); } catch {}
      return;
    }

    try {
      const items = await gsPiercingList(piercMonthKey_());
      __piercCacheList = items;

      const isTyping = (piercStudentEl && document.activeElement === piercStudentEl);
      if (__piercCurrentStudent && !isTyping) piercUpdateSelectedBox_(__piercCurrentStudent);

      if (__piercView === "detail") {
        if (__piercCurrentStudent) piercRenderDetailView_();
        return;
      }

      piercRenderReportedList_(items);
    } catch {}
  }, 15000);
}

function openPiercingModal() {
  const modal = document.getElementById("piercingModal");
  if (!modal) return;

  // üî• FIX: si est√° anidado dentro de disciplineModal, s√°calo al <body>
  if (modal.parentElement !== document.body) {
    document.body.appendChild(modal);
    console.warn("‚úÖ PiercingModal movido al <body> (estaba anidado).");
  }

  // ‚úÖ (Opcional) cerrar SOLO disciplina (no el men√∫)
  if (disciplineModal) disciplineModal.hidden = true;

  // ‚ùå NO cerrar men√∫ aqu√≠
  // setMenuOpen(false);

  // Abre piercing
  modal.hidden = false;
  modal.removeAttribute("hidden");
  modal.style.display = "flex";

  // Reset UI
  piercSetHint_("");
  __piercView = "list";
  __piercCurrentStudent = "";
  piercUpdateSelectedBox_("");
  piercRenderReportedList_(__piercCacheList);
  if (btnPiercBack) btnPiercBack.hidden = true;

  // Cargar lista
  piercReloadReportedList(true);

  console.log("‚úÖ openPiercingModal() abri√≥ el modal y dej√≥ el men√∫/submen√∫ abiertos");
}


function closePiercingModal() {
  if (!piercingModal) return;

  piercingModal.hidden = true;
  __piercView = "list";
  __piercCurrentStudent = "";
  piercSetHint_("");
  piercUpdateSelectedBox_("");
  if (btnPiercBack) btnPiercBack.hidden = true;
}

function piercBindUI_() {
  // ‚úÖ Mantener men√∫/submen√∫ abiertos al abrir el modal
  if (btnPiercing) {
    btnPiercing.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      openPiercingModal();
    });
  }

  // ‚úÖ Evitar que cualquier click dentro del modal cierre el men√∫ global
  if (piercingModal) {
    piercingModal.addEventListener("click", (e) => e.stopPropagation());
  }

  if (btnPiercClose) {
    btnPiercClose.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      closePiercingModal();
    });
  }

  if (btnPiercReload) {
    btnPiercReload.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      piercReloadReportedList(true);
    });
  }

  if (btnPiercBack) {
    btnPiercBack.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      piercBackToList_();
    });
  }

  if (piercingModal) {
    piercingModal.querySelectorAll(".disc-level").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const lvl = Number(btn.getAttribute("data-level") || 0);
        piercDoMarkLevel(lvl);
      });
    });
  }

  if (piercStudentEl) {
    piercStudentEl.addEventListener("input", () => {
      const raw = String(piercStudentEl.value || "");
      __piercCurrentStudent = raw;

      // ... (TU C√ìDIGO EXISTENTE sigue igual desde aqu√≠)
    });
  }
}

// ======= Curso + Autocomplete en modales (Cursos + Select estudiantes) =======
const discCourseEl        = document.getElementById("discCourse");
const discStudentsDL      = document.getElementById("discStudentsList");
const discStudentSelectEl = document.getElementById("discStudentSelect");

const piercCourseEl        = document.getElementById("piercCourse");
const piercStudentsDL      = document.getElementById("piercStudentsList");
const piercStudentSelectEl = document.getElementById("piercStudentSelect");

const uniCourseEl        = document.getElementById("uniCourse");
const uniStudentsDL      = document.getElementById("uniStudentsList");
const uniStudentSelectEl = document.getElementById("uniStudentSelect");

// ‚úÖ Llama esto cuando la app ya est√° lista (despu√©s del login o al cargar)
function initAllModalCourses_() {
  const defaultCourse =
    (loginCourseEl && loginCourseEl.value)
      ? loginCourseEl.value.trim()
      : "";

  // ========= DISC =========
  mountStudentSelectIntoInput_(discStudentEl, discStudentSelectEl);
  bindStudentSelectToInput_(discStudentSelectEl, discStudentEl, (name) => {
    if (typeof discUpdateSelectedBox_ === "function") {
      discUpdateSelectedBox_(name);
    }
  });

  initCourseComboForModal({
    selectEl: discCourseEl,
    datalistEl: discStudentsDL,
    studentInputEl: discStudentEl,
    studentSelectEl: discStudentSelectEl,
    defaultCourse
  });

  // ========= PIERC =========
  mountStudentSelectIntoInput_(piercStudentEl, piercStudentSelectEl);
  bindStudentSelectToInput_(piercStudentSelectEl, piercStudentEl, (name) => {
    if (typeof piercUpdateSelectedBox_ === "function") {
      piercUpdateSelectedBox_(name);
    }
  });

  initCourseComboForModal({
    selectEl: piercCourseEl,
    datalistEl: piercStudentsDL,
    studentInputEl: piercStudentEl,
    studentSelectEl: piercStudentSelectEl,
    defaultCourse
  });

  // ========= UNI =========
  mountStudentSelectIntoInput_(uniStudentEl, uniStudentSelectEl);
bindStudentSelectToInput_(uniStudentSelectEl, uniStudentEl, (name) => {
  uniOnStudentChange_(name);
});


  initCourseComboForModal({
    selectEl: uniCourseEl,
    datalistEl: uniStudentsDL,
    studentInputEl: uniStudentEl,
    studentSelectEl: uniStudentSelectEl,
    defaultCourse
  });
}





/************ UNIFORME (UI) ************/
const btnUniform = document.getElementById("btnUniform");
const uniformModal = document.getElementById("uniformModal");
const btnUniClose = document.getElementById("btnUniClose");
const btnUniReload = document.getElementById("btnUniReload");
const btnUniBack = document.getElementById("btnUniBack");

const uniSelectedNameEl = document.getElementById("uniSelectedName");
const uniSelectedMetaEl = document.getElementById("uniSelectedMeta");
const uniLevelDot = document.getElementById("uniLevelDot");
const uniWhoList = document.getElementById("uniWhoList");
const uniStudentEl = document.getElementById("uniStudent");
const uniReportedList = document.getElementById("uniReportedList");
const uniHintEl = document.getElementById("uniHint");

let __uniCacheList = [];
let __uniCurrentStudent = "";
let __uniView = "list";
let __uniPollTimer = null;

/* ======= Google Sheets API: Uniforme ======= */
async function gsUniformList(month) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "uniform_list", month, key: GS_API_KEY })
  });
  let data = null;
  try { data = await res.json(); } catch { throw new Error("Respuesta inv√°lida del servidor"); }
  if (!data.ok) throw new Error(data.msg || data.error || "uniform_list_failed");
  return data.items || [];
}

async function gsUniformMark(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "uniform_mark", ...payload, key: GS_API_KEY })
  });
  let data = null;
  try { data = await res.json(); } catch { throw new Error("Respuesta inv√°lida del servidor"); }
  if (!data.ok) throw new Error(data.msg || data.error || "uniform_mark_failed");
  return data;
}

async function gsUniformDeleteStudent(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "uniform_delete_student", ...payload, key: GS_API_KEY })
  });
  let data = null;
  try { data = await res.json(); } catch { throw new Error("Respuesta inv√°lida del servidor"); }
  if (!data.ok) throw new Error(data.msg || data.error || "uniform_delete_failed");
  return data;
}

/* ======= helpers ======= */
function uniMonthKey_() {
  // usa la misma l√≥gica del mes actual que ya usas en disciplina/piercing
  // si ya tienes discMonthKey_ / piercMonthKey_, esto mantiene el mismo mes
  return (typeof discMonthKey_ === "function") ? discMonthKey_() : (typeof piercMonthKey_ === "function" ? piercMonthKey_() : "");
}

function uniNormalizeStudent_(s) {
  return String(s || "").trim().replace(/\s+/g, " ");
}
function uniSetHint_(t){ if (uniHintEl) uniHintEl.textContent = String(t||""); }
// ‚úÖ DOT Uniforme: oculto si NO hay reportes
// ‚úÖ DOT Uniforme: oculto si NO hay reportes
function uniSetDotByLevel_(level) {
  if (!uniLevelDot) return;

  const lv = Number(level || 0);

  if (lv <= 0) {
    uniLevelDot.style.visibility = "hidden";
    uniLevelDot.className = "dot";
    return;
  }

  uniLevelDot.style.visibility = "visible";
  uniLevelDot.className = "dot" + (lv >= 4 ? " bad" : (lv >= 2 ? " warn" : ""));
}

// ‚úÖ faltaba esta funci√≥n (estaba rompiendo Uniforme)
function uniClearLevelUI_() {
  if (!uniformModal) return;
  uniformModal.querySelectorAll(".disc-level").forEach(btn => {
    btn.classList.remove("active");
    btn.disabled = false; // ‚úÖ important√≠simo: re-habilita todo antes de aplicar regla
  });
}

function uniApplyLevelUI_(maxLevel) {
  if (!uniformModal) return;

  uniClearLevelUI_();

  const max = Number(maxLevel || 0);

  // activa 1..max
  for (let i = 1; i <= max; i++) {
    const btn = uniformModal.querySelector(`.disc-level[data-level="${i}"]`);
    if (btn) btn.classList.add("active");
  }

  // regla de bloqueo: solo deja habilitado hasta max+1
  uniformModal.querySelectorAll(".disc-level").forEach(btn => {
    const lvl = Number(btn.getAttribute("data-level") || 0);
    if (!lvl) return;
    if (lvl > max + 1) btn.disabled = true;
  });
}

function uniRenderWho_(whoArr){
  if (!uniWhoList) return;

  const list = Array.isArray(whoArr) ? whoArr : [];
  if (!list.length) {
    uniWhoList.textContent = "‚Äî";
    return;
  }

  // ‚úÖ Igual que Disciplina/Piercing: Docente ‚Ä¢ Nivel X (en pills)
 uniWhoList.innerHTML = list.map(x => {
  const name = escapeHtml(x.teacher || "");
  const lvl  = escapeHtml(String(x.level || ""));
  const date = formatDateShort_(x.date);
  return `
    <span class="disc-pill">
      ${name} ‚Ä¢ Nivel ${lvl}${date ? ` ‚Ä¢ ${date}` : ""}
    </span>
  `;
}).join("");

}

function uniFindInCache_(student){
  const key = normalizeKey(student);
  return (__uniCacheList || []).find(it => normalizeKey(it.student) === key) || null;
}



function uniOnStudentChange_(studentName) {
  const s = uniNormalizeStudent_(studentName);
  __uniCurrentStudent = s;

  // siempre actualizar box de seleccionado (punto, niveles, who)
  uniUpdateSelectedBox_(s);

  // si est√° en los reportados del mes => abrir detalle
  const item = s ? uniFindInCache_(s) : null;
  if (item) {
    __uniView = "detail";
    uniRenderDetailView_();
    if (btnUniBack) btnUniBack.hidden = false;
    return;
  }

  // si no est√° reportado => quedarse en lista normal
  __uniView = "list";
  uniRenderReportedList_(__uniCacheList);
  if (btnUniBack) btnUniBack.hidden = true;
}



/* ======= render list ======= */
function uniRenderReportedList_(items){
  if (!uniReportedList) return;

  const list = Array.isArray(items) ? items : [];
  const selectedKey = __uniCurrentStudent ? normalizeKey(uniNormalizeStudent_(__uniCurrentStudent)) : "";

  const trashSvg = (typeof window.trashSvg !== "undefined")
    ? window.trashSvg
    : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="currentColor" stroke-width="2"/><path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2"/><path d="M6 6l1 16h10l1-16" stroke="currentColor" stroke-width="2"/></svg>`;

  uniReportedList.innerHTML = list.map(it=>{
    const student = String(it.student || "");
    const maxLevel = Number(it.maxLevel || 0);
    const dotCls = maxLevel ? `lvl-dot lvl-${maxLevel}` : "lvl-dot";

    const isSelected = selectedKey && normalizeKey(student) === selectedKey;
    const selectedCls = isSelected ? " selected" : "";

    return `
      <div class="disc-item${selectedCls}"
           role="button"
           tabindex="0"
           data-student="${escapeHtml(student)}">

        <div class="left">
          <span class="${dotCls}"></span>
          <span class="name">${escapeHtml(student)}</span>
        </div>

        <div class="right" style="gap:10px;">
          <button type="button"
                  class="disc-trash"
                  title="Eliminar estudiante"
                  aria-label="Eliminar estudiante"
                  data-del="${escapeHtml(student)}">
            ${trashSvg}
          </button>
          <span class="muted small" aria-hidden="true">‚Ä∫</span>
        </div>
      </div>
    `;
  }).join("");

  // abrir detalle
  uniReportedList.querySelectorAll(".disc-item[data-student]").forEach(row=>{
    const open = ()=>{
      const s = row.getAttribute("data-student") || "";
      uniOpenDetail_(s);
    };
    row.addEventListener("click",(e)=>{
      if (e.target && e.target.closest && e.target.closest("[data-del]")) return;
      open();
    });
    row.addEventListener("keydown",(e)=>{
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); open(); }
    });
  });

  // borrar
  uniReportedList.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const s = btn.getAttribute("data-del") || "";
      await uniDeleteStudent_(s);
    });
  });
}

// ‚úÖ Reusar el mismo √≠cono de basura en Disciplina / Piercing / Uniforme
window.trashSvg = `
  <svg viewBox="0 0 448 512" aria-hidden="true" focusable="false">
    <path d="M135.2 17.7C140.6 7.1 151.5 0 163.8 0H284.2c12.3 0 23.2 7.1 28.6 17.7L320 32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32h-16l-21.2 339.2C377.2 480.8 348.5 512 312.6 512H135.4c-35.9 0-64.6-31.2-66.2-76.8L48 96H32C14.3 96 0 81.7 0 64s14.3-32 32-32h96l7.2-14.3zM192 64l-3.2 6.4h70.4L256 64h-64zM112 96l19.2 336.5c.2 4.2 2.2 7.5 4.2 7.5h177.2c2 0 4-3.3 4.2-7.5L336 96H112zm64 64c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16zm96 0c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16z"></path>
  </svg>
`;


/* ======= selected box ======= */
function uniUpdateSelectedBox_(studentName){
  const s = uniNormalizeStudent_(studentName);
  __uniCurrentStudent = s || "";

  if (!s) {
    if (uniStudentEl) uniStudentEl.value = "";
    if (uniSelectedNameEl) uniSelectedNameEl.textContent = "(Selecciona o escribe un estudiante)";
    if (uniSelectedMetaEl) uniSelectedMetaEl.textContent = "‚Äî";
    uniSetDotByLevel_(0);
    uniClearLevelUI_();
    if (uniWhoList) uniWhoList.textContent = "‚Äî";
    return;
  }

  if (uniStudentEl) uniStudentEl.value = s;

  const item = uniFindInCache_(s);
  const maxLevel = item ? Number(item.maxLevel || 0) : 0;
  const total = item ? Number(item.totalMarks || 0) : 0;
  const teachersCount = item ? Number(item.teachersCount || 0) : 0;

  if (uniSelectedNameEl) uniSelectedNameEl.textContent = s;
  if (uniSelectedMetaEl) {
    uniSelectedMetaEl.textContent = item
      ? `Nivel ${maxLevel} ‚Ä¢ Llamados: ${total} ‚Ä¢ Docentes: ${teachersCount}`
      : `Nuevo (sin reportes este mes a√∫n)`;
  }

  uniSetDotByLevel_(maxLevel);
  uniApplyLevelUI_(maxLevel);

  if (item && Array.isArray(item.who) && item.who.length) uniRenderWho_(item.who);
  else if (uniWhoList) uniWhoList.textContent = "‚Äî";
}

/* ======= views ======= */
function uniOpenDetail_(studentName){
  __uniView = "detail";
  uniUpdateSelectedBox_(studentName);
  uniRenderDetailView_();
  if (btnUniBack) btnUniBack.hidden = false;
}
function uniBackToList_(){
  __uniView = "list";
  uniRenderReportedList_(__uniCacheList);
  uniSetHint_("");
  if (btnUniBack) btnUniBack.hidden = true;
}
function uniRenderDetailView_(){
  // igual que disciplina: deja arriba el box y debajo info
  // aqu√≠ simplemente reusamos la lista, pero mostrando ‚Äúseleccionado‚Äù
  if (!uniReportedList) return;
  const s = uniNormalizeStudent_(__uniCurrentStudent);
  const item = s ? uniFindInCache_(s) : null;

  const maxLevel = item ? Number(item.maxLevel || 0) : 0;
  const total = item ? Number(item.totalMarks || 0) : 0;
  const teachersCount = item ? Number(item.teachersCount || 0) : 0;

  uniReportedList.innerHTML = `
    <div class="record-card" style="margin-bottom:10px;">
      <div class="top">
        <span class="teacher">${escapeHtml(s || "‚Äî")}</span>
        <span class="badge badge-neutral">${maxLevel ? `Nivel ${maxLevel}` : "Sin nivel"}</span>
      </div>
      <div class="meta">
        Llamados: <b>${total}</b> ‚Ä¢ Docentes: <b>${teachersCount}</b>
      </div>
    </div>
    <div class="muted small" style="margin-bottom:6px;">(Usa los botones de nivel arriba para registrar)</div>
  `;

  uniApplyLevelUI_(maxLevel);
  if (item && Array.isArray(item.who) && item.who.length) uniRenderWho_(item.who);
  else if (uniWhoList) uniWhoList.textContent = "‚Äî";
}

/* ======= actions ======= */
async function uniReloadReportedList(showHint=false){
  try {
    const items = await gsUniformList(uniMonthKey_());
    __uniCacheList = items;

    const isTyping = (uniStudentEl && document.activeElement === uniStudentEl);
    if (__uniCurrentStudent && !isTyping) uniUpdateSelectedBox_(__uniCurrentStudent);

    if (__uniView === "detail" && __uniCurrentStudent) uniRenderDetailView_();
    else uniRenderReportedList_(items);

    if (showHint) uniSetHint_("Lista sincronizada ‚úÖ");
  } catch (e) {
    if (showHint) uniSetHint_(String(e && e.message ? e.message : e));
  }
}

async function uniDeleteStudent_(studentName){
  const profile = requireLogin();
  if (!profile) return;

  const student = uniNormalizeStudent_(studentName);
  if (!student) return;

  const ok = confirm(`¬øSeguro que deseas eliminar a "${student}"?\n\nSe borrar√°n TODOS sus reportes del mes actual.`);
  if (!ok) return;

  try {
    setLoading(true, "Eliminando‚Ä¶", "Borrando reportes del estudiante.");

    const resp = await gsUniformDeleteStudent({
      month: uniMonthKey_(),
      student,
      teacher: profile.name,
      email: profile.email,
      device_id: getDeviceId()
    });

    if (resp && Array.isArray(resp.list)) __uniCacheList = resp.list;
    else await uniReloadReportedList(false);

    if (__uniCurrentStudent && normalizeKey(__uniCurrentStudent) === normalizeKey(student)) {
      __uniCurrentStudent = "";
      uniUpdateSelectedBox_("");
      uniBackToList_();
    } else {
      if (__uniView !== "detail") uniRenderReportedList_(__uniCacheList);
    }

    uniSetHint_("Estudiante eliminado ‚úÖ");
  } catch (e) {
    uniSetHint_(String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}

async function uniDoMarkLevel(level) {
  const profile = requireLogin();
  if (!profile) return;

  const lvl = Number(level || 0);
  if (lvl < 1 || lvl > 4) return;

  const student = uniNormalizeStudent_(__uniCurrentStudent);
  if (!student) { uniSetHint_("Primero selecciona un estudiante de la lista."); return; }

  const item = uniFindInCache_(student);
  const currentMax = item ? Number(item.maxLevel || 0) : 0;

  if (lvl > currentMax + 1) {
    uniSetHint_(`Debes marcar primero el nivel ${currentMax + 1}.`);
    uniApplyLevelUI_(currentMax);
    return;
  }

  try {
    setLoading(true, "Guardando‚Ä¶", "Registrando porte del uniforme.");

const resp = await gsUniformMark({
  month: uniMonthKey_(),
  student,
  level: lvl,
  teacher: profile.name,
  email: profile.email,
  device_id: getDeviceId(),
  date: new Date().toISOString()
});


    if (resp && Array.isArray(resp.list)) __uniCacheList = resp.list;
    else await uniReloadReportedList(false);

    uniUpdateSelectedBox_(student);
    __uniView = "list";
    uniRenderReportedList_(__uniCacheList);
    if (btnUniBack) btnUniBack.hidden = true;

    if (resp && resp.ok && resp.justReported && lvl >= 4) {
      const waUrl = String(resp.wa_url || "").trim();
      if (waUrl) window.open(waUrl, "_blank");
    }

    uniSetHint_(lvl >= 4 ? "Nivel 4 registrado ‚úÖ" : "Registrado ‚úÖ");
  } catch (e) {
    uniSetHint_(String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}

/* ======= modal open/close/bind ======= */
function openUniformModal() {
  if (!uniformModal) return;
  uniformModal.hidden = false;

  uniSetHint_("");
  __uniView = "list";
  __uniCurrentStudent = "";
  uniUpdateSelectedBox_("");
  uniRenderReportedList_(__uniCacheList);

  if (btnUniBack) btnUniBack.hidden = true;
  uniReloadReportedList(true);
}

function closeUniformModal() {
  if (!uniformModal) return;
  uniformModal.hidden = true;

  __uniView = "list";
  __uniCurrentStudent = "";
  uniSetHint_("");
  uniUpdateSelectedBox_("");
  if (btnUniBack) btnUniBack.hidden = true;
}

function uniBindUI_() {
  // ‚úÖ Mantener men√∫/submen√∫ abiertos al abrir el modal
  if (btnUniform) {
    btnUniform.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      openUniformModal();
    });
  }

  // ‚úÖ Evitar que cualquier click dentro del modal cierre el men√∫ global
  if (uniformModal) {
    uniformModal.addEventListener("click", (e) => e.stopPropagation());
  }

  if (btnUniClose) {
    btnUniClose.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeUniformModal();
    });
  }

  if (btnUniReload) {
    btnUniReload.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      uniReloadReportedList(true);
    });
  }

  if (btnUniBack) {
    btnUniBack.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      uniBackToList_();
    });
  }

  if (uniformModal) {
    uniformModal.querySelectorAll(".disc-level").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const lvl = Number(btn.getAttribute("data-level") || 0);
        uniDoMarkLevel(lvl);
      });
    });
  }

if (uniStudentEl) {
  uniStudentEl.addEventListener("input", () => {
    const raw = String(uniStudentEl.value || "");
    uniOnStudentChange_(raw);
  });
}

}


/* ======= Poll ======= */
function uniStartPolling_() {
  if (__uniPollTimer) return;

  __uniPollTimer = setInterval(async () => {
    const p = loadProfile();
    const admin = isAdminMode();
    if (!p && !admin) return;

    if (!uniformModal || uniformModal.hidden === true) {
      try { __uniCacheList = await gsUniformList(uniMonthKey_()); } catch {}
      return;
    }

    try {
      const items = await gsUniformList(uniMonthKey_());
      __uniCacheList = items;

      const isTyping = (uniStudentEl && document.activeElement === uniStudentEl);

      if (__uniCurrentStudent && !isTyping) uniUpdateSelectedBox_(__uniCurrentStudent);

      if (__uniView === "detail") {
        if (__uniCurrentStudent) uniRenderDetailView_();
        return;
      }

      uniRenderReportedList_(items);

    } catch {
      // silencioso
    }
  }, 15000);
}


// ======= GEO =======
function toRad(x){ return x * Math.PI / 180; }
function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

async function getPosition() {
  if (!("geolocation" in navigator)) {
    throw new Error("NO_GEO");
  }

  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      resolve,
      (err) => {
        // iOS devuelve distintos c√≥digos aunque el permiso est√© activo
        if (err && typeof err.code === "number") {
          switch (err.code) {
            case err.PERMISSION_DENIED:
              reject(new Error("PERMISSION_DENIED"));
              return;
            case err.POSITION_UNAVAILABLE:
              reject(new Error("POSITION_UNAVAILABLE"));
              return;
            case err.TIMEOUT:
              reject(new Error("TIMEOUT"));
              return;
          }
        }
        reject(new Error("GEO_UNKNOWN"));
      },
      {
        enableHighAccuracy: true,
        timeout: 15000,   // iOS necesita m√°s tiempo
        maximumAge: 0
      }
    );
  });
}


async function checkLocation() {
  setStatus("warn", "Verificando ubicaci√≥n‚Ä¶", "Aseg√∫rate de tener GPS/Ubicaci√≥n activada.");
  const pos = await getPosition();
  const { latitude, longitude, accuracy } = pos.coords;
  const dist = distanceMeters(latitude, longitude, SCHOOL_LAT, SCHOOL_LNG);

  distEl.textContent = `${Math.round(dist)} m`;
  accEl.textContent = `${Math.round(accuracy)} m`;
  coordsEl.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

  const accurateEnough = accuracy <= REQUIRED_ACCURACY_METERS;
  const inside = dist <= SCHOOL_RADIUS_METERS;

  if (!accurateEnough) {
    setStatus("warn", "Ubicaci√≥n con baja precisi√≥n", `Precisi√≥n actual ${Math.round(accuracy)} m. Necesito ‚â§ ${REQUIRED_ACCURACY_METERS} m.`);
    return { ok:false, reason:"accuracy", dist, accuracy, latitude, longitude };
  }
  if (!inside) {
    setStatus("bad", "Fuera del colegio", `Est√°s a ~${Math.round(dist)} m. Debes estar dentro de ${SCHOOL_RADIUS_METERS} m.`);
    return { ok:false, reason:"outside", dist, accuracy, latitude, longitude };
  }

  setStatus("", "Ubicaci√≥n validada", `Dentro del radio (${SCHOOL_RADIUS_METERS} m) y precisi√≥n OK.`);
  return { ok:true, dist, accuracy, latitude, longitude };
}

// ======= Google Sheets API (Apps Script Web App) =======
async function gsGetList(limit = 50, monthYYYYMM = "", teacher = "") {
  const url = new URL(GS_WEBAPP_URL);
  url.searchParams.set("action", "list");
  url.searchParams.set("limit", String(limit));
  url.searchParams.set("key", GS_API_KEY);

  if (monthYYYYMM) url.searchParams.set("month", monthYYYYMM);
  if (teacher) url.searchParams.set("teacher", teacher);

  let data = null;
  try {
    data = await fetchJsonWithTimeout_(url.toString(), { method: "GET" }, LIST_TIMEOUT_MS);
  } catch (e) {
    // abort / timeout
    const msg = String(e && e.name ? e.name : e);
    if (msg.includes("AbortError")) throw new Error("Tiempo de espera agotado. Revisa internet y vuelve a intentar.");
    throw e;
  }

  if (!data || !data.ok) throw new Error((data && data.error) || "gs_list_failed");
  return data.records || [];
}




async function gsRegister(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    // NO headers: evita preflight CORS
    body: JSON.stringify({ ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  // ‚úÖ IMPORTANTE: si el servidor env√≠a msg, lo usamos
  if (!data.ok) {
    throw new Error(data.msg || data.error || "gs_register_failed");
  }
  return data;
}


async function gsRequestDeviceAuth(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    // NO headers: evita preflight CORS
    body: JSON.stringify({ ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "request_auth_failed");
  return data;
}

async function gsCheckDeviceAuth(payload) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ ...payload, key: GS_API_KEY })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "check_auth_failed");
  return data;
}


async function gsClearCurrentMonth() {
  const d = new Date();
  const month = `${d.getFullYear()}-${pad(d.getMonth() + 1)}`; // YYYY-MM

  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    // NO headers: evita preflight CORS
    body: JSON.stringify({ action: "clear_month", month, key: GS_API_KEY })
  });

  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "gs_clear_failed");
  return data;
}


// ======= Render (desde Google Sheets) =======
// ======= Render (desde Google Sheets) =======
let cachedRecords = [];
let __recordsAllRaw = []; // ‚úÖ en admin: guarda todos los del mes cargado

function render(records) {
  __recordsAllRaw = (records || []);

  const p = loadProfile();
  const admin = isAdminMode();

  // ‚úÖ Admin: filtrar por selector (Todos o un docente)
  if (admin) {
    const selected = (typeof recordsTeacherSelect !== "undefined" && recordsTeacherSelect)
      ? String(recordsTeacherSelect.value || "__ALL__")
      : "__ALL__";

    const filtered = (selected && selected !== "__ALL__")
      ? __recordsAllRaw.filter(r => normalizeKey(r.teacher) === normalizeKey(selected))
      : __recordsAllRaw;

    cachedRecords = filtered;

    // ======= CONTADORES =======
    const lateCount = filtered.filter(r =>
      String(r.type || "").toUpperCase() === "ENTRADA" && !!r.late
    ).length;

    const earlyExitCount = filtered.filter(isEarlyExitRecord).length;

    if (lateCountEl) lateCountEl.textContent = `Entradas tardes: ${lateCount}`;
    if (earlyExitCountEl) earlyExitCountEl.textContent = `Salidas antes: ${earlyExitCount}`;

    // ======= TABLA (desktop) =======
    tbody.innerHTML = filtered.map(r => {
      const type = String(r.type || "").toUpperCase();
      const ntc = isNTCRecord(r);

      const dist = ntc
        ? "NTC"
        : (r.distance_m ?? r.dist ?? r.distance ?? "‚Äî");

      const acc = ntc
        ? "NTC"
        : (r.accuracy_m ?? r.acc ?? r.accuracy ?? "‚Äî");

      const typeLabel = ntc ? `${type} ‚Ä¢ NTC` : type;

      const rowCls =
        (type === "ENTRADA")
          ? (r.late ? "late" : "ontime")
          : "";

      return `
        <tr class="${rowCls}">
          <td>${escapeHtml(r.date)}</td>
          <td>${escapeHtml(r.time)}</td>
          <td>${escapeHtml(r.teacher)}</td>
          <td>${escapeHtml(typeLabel)}</td>
          <td>${escapeHtml(dist)}</td>
          <td>${escapeHtml(acc)}</td>
        </tr>
      `;
    }).join("");

    // ======= CARDS (mobile) =======
    if (!filtered.length) {
      recordsList.innerHTML = `<div class="muted small">No hay registros para el filtro seleccionado.</div>`;
      return; // ‚úÖ en admin no tocamos updateSalidaState()
    }

    recordsList.innerHTML = filtered.map(r => {
      const type = String(r.type || "").toUpperCase();
      const ntc = isNTCRecord(r);
      const ntcTxt = ntc ? " ‚Ä¢ NTC" : "";

      const badgeClass = (type === "ENTRADA")
        ? (r.late ? "badge badge-late" : "badge badge-ontime")
        : "badge badge-neutral";

      const rowClass = (type === "ENTRADA")
        ? (r.late ? "record-card late" : "record-card ontime")
        : "record-card";

      const badgeText =
        (type === "ENTRADA")
          ? `${type}${r.late ? " ‚Ä¢ TARDE" : " ‚Ä¢ A TIEMPO"}${ntcTxt}`
          : `${type}${ntcTxt}`;

      return `
        <div class="${rowClass}">
          <div class="top">
            <span class="teacher">${escapeHtml(r.teacher)}</span>
            <span class="${badgeClass}">${escapeHtml(badgeText)}</span>
          </div>
          <div class="meta">
            ${escapeHtml(r.date)} ‚Ä¢ ${escapeHtml(r.time)}
          </div>
        </div>
      `;
    }).join("");

    return; // ‚úÖ admin termina aqu√≠
  }

  // ‚úÖ Docente: solo sus registros (como lo ten√≠as)
  const myNameKey = normalizeKey(p && p.name ? p.name : "");
  const filtered = myNameKey
    ? __recordsAllRaw.filter(r => normalizeKey(r.teacher) === myNameKey)
    : __recordsAllRaw;

  cachedRecords = filtered;

  // ======= CONTADORES =======
  const lateCount = filtered.filter(r =>
    String(r.type || "").toUpperCase() === "ENTRADA" && !!r.late
  ).length;

  const earlyExitCount = filtered.filter(isEarlyExitRecord).length;

  if (lateCountEl) lateCountEl.textContent = `Entradas tardes: ${lateCount}`;
  if (earlyExitCountEl) earlyExitCountEl.textContent = `Salidas antes: ${earlyExitCount}`;

  // ======= TABLA (desktop) =======
  tbody.innerHTML = filtered.map(r => {
    const type = String(r.type || "").toUpperCase();
    const ntc = isNTCRecord(r);

    const dist = ntc
      ? "NTC"
      : (r.distance_m ?? r.dist ?? r.distance ?? "‚Äî");

    const acc = ntc
      ? "NTC"
      : (r.accuracy_m ?? r.acc ?? r.accuracy ?? "‚Äî");

    const typeLabel = ntc ? `${type} ‚Ä¢ NTC` : type;

    const rowCls =
      (type === "ENTRADA")
        ? (r.late ? "late" : "ontime")
        : "";

    return `
      <tr class="${rowCls}">
        <td>${escapeHtml(r.date)}</td>
        <td>${escapeHtml(r.time)}</td>
        <td>${escapeHtml(r.teacher)}</td>
        <td>${escapeHtml(typeLabel)}</td>
        <td>${escapeHtml(dist)}</td>
        <td>${escapeHtml(acc)}</td>
      </tr>
    `;
  }).join("");

  // ======= CARDS (mobile) =======
  if (!filtered.length) {
    recordsList.innerHTML = `<div class="muted small">No hay registros para este docente.</div>`;
updateDailyButtonsState(filtered);
    return;
  }

  recordsList.innerHTML = filtered.map(r => {
    const type = String(r.type || "").toUpperCase();
    const ntc = isNTCRecord(r);
    const ntcTxt = ntc ? " ‚Ä¢ NTC" : "";

    const badgeClass = (type === "ENTRADA")
      ? (r.late ? "badge badge-late" : "badge badge-ontime")
      : "badge badge-neutral";

    const rowClass = (type === "ENTRADA")
      ? (r.late ? "record-card late" : "record-card ontime")
      : "record-card";

    const badgeText =
      (type === "ENTRADA")
        ? `${type}${r.late ? " ‚Ä¢ TARDE" : " ‚Ä¢ A TIEMPO"}${ntcTxt}`
        : `${type}${ntcTxt}`;

    return `
      <div class="${rowClass}">
        <div class="top">
          <span class="teacher">${escapeHtml(r.teacher)}</span>
          <span class="${badgeClass}">${escapeHtml(badgeText)}</span>
        </div>
        <div class="meta">
          ${escapeHtml(r.date)} ‚Ä¢ ${escapeHtml(r.time)}
        </div>
      </div>
    `;
  }).join("");

updateDailyButtonsState(filtered);
}

  function filterToMonth_(records, monthYYYYMM) {
  const m = String(monthYYYYMM || "").trim();
  if (!m) return records || [];
  return (records || []).filter(r => String(r.date || "").startsWith(m + "-"));
}


  

async function refreshFromSheet(options = {}) {
  const {
    useCache = true,         // renderiza cach√© primero
    silent = false,          // no cambia el status "Cargando..."
    showLoadingAfterMs = 450 // solo mostrar "Cargando" si tarda > 450ms
  } = options;

  const admin = isAdminMode();
  const p = loadProfile();

  // ‚úÖ Mes:
  // - Admin: selector
  // - Docente: mes actual SIEMPRE
  let month = "";
  if (admin && typeof recordsMonthSelect !== "undefined" && recordsMonthSelect) {
    month = String(recordsMonthSelect.value || "").trim(); // YYYY-MM
  } else {
    month = monthKeyFromDate(new Date()); // ‚úÖ docente: mes actual
  }

  // ‚úÖ Docente: pedir solo sus registros
  const teacherFilter = (!admin && p && p.name) ? String(p.name).trim() : "";

  // 1) Render r√°pido con cach√© (no se siente "lento al iniciar")
  const cacheKey = cacheKeyForCurrentView_();
  if (useCache) {
    const cached = loadRecordsCache_(cacheKey);
    if (cached && cached.length) {
      render(cached);
      // no ponemos "Listo" aqu√≠: esperamos confirmaci√≥n de red
    }
  }

  // 2) ‚ÄúCargando‚Ä¶‚Äù SOLO si realmente tarda
  let loadingTimer = null;
  if (!silent) {
    loadingTimer = setTimeout(() => {
      setStatus("warn", "Cargando‚Ä¶", "Leyendo registros de asistencia.");
    }, showLoadingAfterMs);
  }

  try {
    // ‚úÖ Reduce carga en docente: solo mes actual y solo su nombre
    const limit = admin ? 1200 : 300;

    let records = await gsGetList(limit, month, teacherFilter);

    // ‚úÖ Seguro extra: docente SOLO mes actual (por si backend devolviera m√°s)
    if (!admin) {
      records = filterToMonth_(records, month);
    }

    // ‚úÖ Admin: resumen del mes
    updateAdminMonthSummaryFromRecords(records);

    // ‚úÖ Admin: actualizar lista de docentes seg√∫n lo cargado (sin romper selecci√≥n)
    if (admin && typeof recordsTeacherSelect !== "undefined" && recordsTeacherSelect) {
      const current = String(recordsTeacherSelect.value || "__ALL__");
      const teachers = uniqueTeachersFromRecords(records);

      recordsTeacherSelect.innerHTML =
        `<option value="__ALL__">Todos</option>` +
        teachers.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      const exists = teachers.some(t => normalizeKey(t) === normalizeKey(current));
      recordsTeacherSelect.value = exists ? current : "__ALL__";
    }

    // Render final
    render(records);

    // Guardar cach√© (ya filtrado)
    saveRecordsCache_(cacheKey, records);

    if (!silent) setStatus("", "Listo", "Datos de asistencia sincronizados.");
  } catch (e) {
    if (!silent) {
      setStatus(
        "bad",
        "Error Google Sheets",
        String(e && e.message ? e.message : "Revisa URL/clave del Web App y permisos.")
      );
    }
  } finally {
    if (loadingTimer) clearTimeout(loadingTimer);
  }
}







// ======= Registrar =======
// ======= Registrar =======
async function register(type) {

  if (type === "SALIDA" && !hasEntradaToday) {
  setStatus(
    "warn",
    "Primero registra ENTRADA",
    "No puedes registrar la salida sin haber registrado la entrada hoy."
  );
  return;
}

  const profile = requireLogin();
  if (!profile) return;

  const teacher = (teacherNameEl.value.trim() || profile.name);
  if (!teacher) {
    setStatus("bad", "Falta el nombre", "Escribe el nombre del docente.");
    teacherNameEl.focus();
    return;
  }

  let geo;
  try {
    geo = await checkLocation();
 } catch (e) {
  const code = String(e && e.message || "");

  if (code === "PERMISSION_DENIED") {
    setStatus(
      "bad",
      "Permiso denegado",
      "En iPhone: Ajustes ‚Üí Safari ‚Üí Ubicaci√≥n ‚Üí Permitir o Preguntar."
    );
  } else if (code === "POSITION_UNAVAILABLE" || code === "TIMEOUT") {
    setStatus(
      "warn",
      "Ubicaci√≥n no disponible",
      "Intenta salir al exterior o activa Wi-Fi / Datos."
    );
  } else {
    setStatus(
      "bad",
      "Ubicaci√≥n no disponible",
      "Revisa que la ubicaci√≥n est√© activada en el dispositivo."
    );
  }
  return;
}

  if (!geo.ok) return;

  const t = nowParts();

  try {
    setLoading(true, "Guardando‚Ä¶", "Enviando registro de asistencia.");

    await gsRegister({
      action: "register",
      teacher,
      type,
      iso: t.iso,
      email: profile.email,
      course: profile.course,
      device_id: getDeviceId(),
      distance_m: Math.round(geo.dist),
      accuracy_m: Math.round(geo.accuracy),
      lat: geo.latitude,
      lng: geo.longitude
    });

refreshFromSheet({ silent: true, useCache: false }); // ‚úÖ no toca status, solo refresca datos

if (type === "ENTRADA") {
  hasEntradaToday = true;
  btnEntrada.disabled = true;

  btnSalida.disabled = false;
  btnSalida.classList.remove("is-inactive");
}

if (type === "SALIDA") {
  hasSalidaToday = true;
  btnEntrada.disabled = true;
  btnSalida.disabled = true;
}



    // ‚úÖ abrir panel para que el usuario vea el registro de inmediato
    setRecordsOpen(true);

    setStatus("", "Guardado", `${type} registrada para ${teacher}.`);


  } catch (e) {
    // ‚úÖ Mensaje real (si viene del servidor)
    const msg = String(e && e.message ? e.message : e).toLowerCase();

    // ‚úÖ Caso t√≠pico sin internet / red ca√≠da
    const isOffline =
      (typeof navigator !== "undefined" && navigator.onLine === false) ||
      msg.includes("failed to fetch") ||
      msg.includes("networkerror") ||
      msg.includes("load failed") ||
      msg.includes("err_internet_disconnected") ||
      msg.includes("err_network_changed");

    if (isOffline) {
      setStatus(
        "bad",
        "Sin conexi√≥n",
        "Revisa tu conexi√≥n a internet e intenta de nuevo."
      );
      return;
    }

    // Si quieres t√≠tulos m√°s bonitos seg√∫n el caso:
    if (msg.includes("no est√° autorizado") || msg.includes("device_not_authorized")) {
      setStatus("bad", "Tel√©fono no autorizado", String(e && e.message ? e.message : e));
    } else if (msg.includes("ya existe") || msg.includes("already_registered")) {
      setStatus("warn", "Registro duplicado", String(e && e.message ? e.message : e));
    } else if (msg.includes("unauthorized")) {
      setStatus("bad", "Sin permisos", "Clave incorrecta o permisos del WebApp.");
    } else {
      setStatus("bad", "No se pudo guardar", String(e && e.message ? e.message : e) || "Revisa conexi√≥n y Apps Script.");
    }

  } finally {

    setLoading(false);
  }
}


// ===== WhatsApp destino (para disciplina NIVEL 4) =====
async function gsGetWhatsAppTo_(email, deviceId) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "get_whatsapp_to",
      email,
      device_id: deviceId,
      key: GS_API_KEY
    })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "get_whatsapp_to_failed");
  return data; // { ok:true, wa_to:"..." }
}

async function gsSetWhatsAppTo_(email, deviceId, whatsappTo) {
  const res = await fetch(GS_WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "set_whatsapp_to",
      email,
      device_id: deviceId,
      whatsapp_to: whatsappTo,
      key: GS_API_KEY
    })
  });

  let data = null;
  try { data = await res.json(); }
  catch { throw new Error("Respuesta inv√°lida del servidor"); }

  if (!data.ok) throw new Error(data.msg || data.error || "set_whatsapp_to_failed");
  return data;
}

async function ensureWhatsAppToOnLogin_(email, deviceId) {
  try {
    const lsKey = "disc_whatsapp_to";

    // helper: solo d√≠gitos (ej: "300 123-4567" -> "3001234567")
    const cleanPhone = (v) => String(v || "").trim().replace(/\D/g, "");

    let waTo = "";

    // 0) prioridad: perfil guardado (si ya lo guardaste)
    const p = loadProfile();
    if (p && p.whatsapp_to) waTo = cleanPhone(p.whatsapp_to);

    // 1) si no hay en perfil, intenta localStorage
    if (!waTo) {
      waTo = cleanPhone(localStorage.getItem(lsKey) || "");
    }

    // 2) si no hay local, intenta server
    if (!waTo) {
      const r = await gsGetWhatsAppTo_(email, deviceId);
      if (r && r.wa_to) waTo = cleanPhone(r.wa_to);
    }

    // 3) si sigue vac√≠o, pedirlo (fallback actual)
    if (!waTo) {
      waTo = cleanPhone(
        prompt(
          "Escribe el n√∫mero destino para enviar reportes por WhatsApp (ej: 3001234567):",
          ""
        ) || ""
      );
      if (!waTo) return; // cancel√≥
    }

    // Validaci√≥n suave (no rompe tu flujo)
    // Si quieres exigir 10 d√≠gitos exactos, cambia la condici√≥n.
    if (waTo.length < 10) {
      console.warn("WhatsAppTo inv√°lido (muy corto):", waTo);
      return;
    }

    // 4) guardar local + server (idempotente)
    localStorage.setItem(lsKey, waTo);
    await gsSetWhatsAppTo_(email, deviceId, waTo);

  } catch (e) {
    console.warn("WhatsAppTo login error:", e);
  }
}





// ======= CSV (desde lo que se ve en la app) =======
function csvCell(v){
  if (v === null || v === undefined) return "";
  const s = String(v);
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}





function exportCSV() {
  // En admin, cachedRecords ya representa:
  // - Todos (si selector = __ALL__)
  // - Un docente (si selector = ese nombre)
  // En modo normal, cachedRecords es el docente logueado.
  const dataToExport = cachedRecords || [];

  if (!dataToExport.length) {
    setStatus("warn", "Sin datos", "No hay registros para exportar.");
    return;
  }

  const header = ["teacher","type","date","time","late","iso"];
  const lines = [header.join(",")].concat(
    dataToExport.map(r => header.map(k => csvCell(r[k])).join(","))
  );

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  // nombre del archivo: admin incluye mes y (si aplica) docente
  let fname = `asistencia_${new Date().toISOString().slice(0,10)}`;

  if (isAdminMode()) {
    const month = recordsMonthSelect ? String(recordsMonthSelect.value || "").trim() : "";
    const who = recordsTeacherSelect ? String(recordsTeacherSelect.value || "__ALL__") : "__ALL__";
    if (month) fname += `_${month}`;
    if (who && who !== "__ALL__") fname += `_${who.replace(/\s+/g, "_")}`;
  }

  const a = document.createElement("a");
  a.href = url;
  a.download = `${fname}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  setStatus("", "Exportado", "CSV descargado.");
}


async function downloadAdminExcel() {
  if (!isAdminMode()) {
    setStatus("warn", "Requiere admin", "Solo disponible en modo administrador.");
    return;
  }

  const month = recordsMonthSelect ? String(recordsMonthSelect.value || "").trim() : "";
  const teacher = recordsTeacherSelect ? String(recordsTeacherSelect.value || "__ALL__") : "__ALL__";

  try {
    setLoading(true, "Generando Excel‚Ä¶", "Preparando archivo para descarga.");

    const url = new URL(GS_WEBAPP_URL);
    url.searchParams.set("action", "export_xlsx_link");
    url.searchParams.set("key", GS_API_KEY);
    if (month) url.searchParams.set("month", month);
    if (teacher) url.searchParams.set("teacher", teacher);

    const res = await fetch(url.toString(), { method: "GET" });
    const data = await res.json();

    if (!data.ok || !data.url) throw new Error(data.msg || "No se pudo generar el link.");

    // ‚úÖ Abrir directo Drive (ya no abre script.google.com)
    const opened = window.open(data.url, "_blank");
    if (!opened) window.location.href = data.url;

    setStatus("", "Listo", "Descarga iniciada ‚úÖ");
  } catch (e) {
    setStatus("bad", "Error", String(e && e.message ? e.message : e));
  } finally {
    setLoading(false);
  }
}


if (btnExportXlsx) btnExportXlsx.addEventListener("click", downloadAdminExcel);


// ======= INSTALL (A2HS) =======
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.hidden = false;
});
btnInstall.addEventListener("click", async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  btnInstall.hidden = true;
});

// ======= UI: Toggle registros =======
function setRecordsOpen(open) {
  recordsPanel.hidden = !open;
  btnToggleRecords.setAttribute("aria-expanded", String(open));
  btnToggleRecords.classList.toggle("open", open);
}
setRecordsOpen(false);
btnToggleRecords.addEventListener("click", () => setRecordsOpen(recordsPanel.hidden));

// ======= Reset / Refresh Service Worker + Cache =======
async function hardRefreshPWA() {
  try {
    setStatus("warn", "Actualizando‚Ä¶", "Borrando cach√© y reiniciando la app.");

    // üî• orden de suicidio al SW activo
    if ("serviceWorker" in navigator) {
      const reg = await navigator.serviceWorker.getRegistration();
      if (reg && reg.active) {
        reg.active.postMessage("KILL_SW");
      }
    }

    // üßπ borrar caches desde la app
    if ("caches" in window) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }

    // üîÑ romper cach√© del navegador
    const url = new URL(location.href);
    url.searchParams.set("v", Date.now().toString());
    location.replace(url.toString());

  } catch (e) {
    setStatus("bad", "No se pudo actualizar", "Cierra la app y √°brela de nuevo.");
  }
}

btnRefreshSW.addEventListener("click", hardRefreshPWA);
if (btnLogout) {
  btnLogout.addEventListener("click", logout);
}


// ======= SW register =======
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try { await navigator.serviceWorker.register("./sw.js"); } catch {}
  });
}

// ======= EVENTOS =======
btnEntrada.addEventListener("click", () => register("ENTRADA"));
btnSalida.addEventListener("click",  () => register("SALIDA"));

btnExport.addEventListener("click", exportCSV);



// Inicial: r√°pido (cache) + refresh silencioso
refreshFromSheet({ useCache: true, silent: true });
setStatus("warn", "Listo", "Para registrar, activa ubicaci√≥n.");

  // DISCIPLINA: bind + polling para sincronizar entre celulares
discBindUI_();
discStartPolling_();
  piercBindUI_();
piercStartPolling_();

uniBindUI_();
uniStartPolling_();



document.body.classList.toggle("is-admin", isAdminMode());


// ‚úÖ Mostrar login al abrir (si no hay perfil guardado)
if (isAdminMode()) {
  setAdminMode(true); // aplica UI admin (cierra modal y pone ADMINISTRADOR)

  // ‚úÖ (Opcional pero recomendado) tambi√©n prepara cursos/estudiantes por si usa modales
  initAllModalCourses_();

} else {
  initAdminRecordsPanelUI(); // ‚úÖ fuerza ocultar combos + resumen si NO es admin
  const _p = requireLogin();

  if (_p) {
    applySessionUI(_p);

    // ‚úÖ FIX: si ya hay sesi√≥n guardada, inicializa cursos + estudiantes
    initAllModalCourses_();
  } else {
    applySessionUI(null);
  }
}





// ‚úÖ Arranque seguro (si hay un error arriba, esto te ayuda a detectarlo)
window.addEventListener("error", (e) => {
  console.error("‚ùå Error JS:", e.message, e.filename, e.lineno);
});


document.addEventListener("DOMContentLoaded", () => {
  // precarga en segundo plano (no rompe si a√∫n no hay login)
  prewarmCoursesAndStudents_();

  // si ya hay perfil guardado, deja listos los combos tambi√©n
  try {
    const p = (typeof loadProfile === "function") ? loadProfile() : null;
    if (p && p.course) initAllModalCourses_();
  } catch {}
});


</script>

</body>
</html>











